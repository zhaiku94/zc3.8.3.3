<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯æŒç®¡ç†ä¸è´¢åŠ¡åˆ†æç³»ç»Ÿ - å¯¼å…¥ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --primary: #3b82f6; --success: #22c55e; --warn: #f97316; --danger: #ef4444; --bg: #f8fafc; --text: #1e293b; }

/* é’ˆå¯¹å¹´ä»½é€‰æ‹©å™¨çš„ä¿®å¤ */
#anaYearSelect {
    width: 90px;
    height: 32px;
    padding: 0;
    font-size: 12px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    background-color: white !important; /* å¼ºåˆ¶èƒŒæ™¯ä¸ºç™½ */
    color: #1e293b !important;        /* å¼ºåˆ¶å­—ä½“ä¸ºæ·±ç°è‰²ï¼Œé˜²æ­¢å˜æˆè“è‰² */
    cursor: pointer;

    /* æ ¸å¿ƒä¿®å¤ï¼šå±…ä¸­é€»è¾‘ */
    text-align: center;
    text-align-last: center; /* é’ˆå¯¹ç§»åŠ¨ç«¯æµè§ˆå™¨çš„æ–‡å­—å±…ä¸­ */

    /* ç§»é™¤ iOS å’Œ Android é»˜è®¤çš„å¤–è§‚æ ·å¼ */
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;

    /* ç§»é™¤ iOS ç‚¹å‡»æ—¶çš„è“è‰²é«˜äº® */
    -webkit-tap-highlight-color: transparent;
    outline: none;
}

/* é’ˆå¯¹éƒ¨åˆ†ç§»åŠ¨ç«¯æµè§ˆå™¨ option æ ·å¼çš„ä¿®æ­£ */
#anaYearSelect option {
    text-align: center;
    color: #1e293b;
}

/* è¯¦æƒ…å¼¹çª—èƒŒæ™¯é®ç½© */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.6); /* æ·±è‰²åŠé€æ˜ï¼Œæ›´æœ‰è´¨æ„Ÿ */
    backdrop-filter: blur(4px);        /* èƒŒæ™¯æ¨¡ç³Šï¼Œèšç„¦å¼¹çª— */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    padding: 20px;                     /* æ ¸å¿ƒï¼šç¡®ä¿é®ç½©å±‚æœ¬èº«æœ‰å†…è¾¹è·ï¼Œå¼¹çª—æ°¸è¿œä¸ä¼šæ’è¾¹ */
    box-sizing: border-box;
}

/* å¼¹çª—ä¸»ä½“ */
.modal-content {
    background: white;
    width: 100%;                       /* ç§»åŠ¨ç«¯é»˜è®¤å æ»¡å¯ç”¨å®½åº¦ï¼ˆå—çˆ¶çº§ padding é™åˆ¶ï¼‰ */
    max-width: 500px;                  /* å¤§å±ä¸‹é™åˆ¶æœ€å¤§å®½åº¦ */
    border-radius: 16px;               /* æ›´åœ†æ¶¦çš„è½¬è§’ */
    padding: 24px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    position: relative;
    display: flex;
    flex-direction: column;
    max-height: 85vh;                  /* é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢è¶…å‡ºå±å¹• */
    animation: modalSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes modalSlideUp {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-header {
    border-bottom: 1px solid #f1f5f9;
    padding-bottom: 16px;
    margin-bottom: 16px;
    flex-shrink: 0;                    /* å¤´éƒ¨ä¸æ”¶ç¼© */
}

.modal-body {
    font-size: 15px;
    line-height: 1.7;
    color: #334155;
    overflow-y: auto;                  /* å†…å®¹è¿‡å¤šæ—¶æ»šåŠ¨ */
    white-space: pre-wrap;
    padding-right: 4px;                /* ç»™æ»šåŠ¨æ¡ç•™ç‚¹ç©ºé—´ */
}

/* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
.modal-body::-webkit-scrollbar { width: 4px; }
.modal-body::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

.modal-footer {
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid #f1f5f9;
    display: flex;
    flex-wrap: wrap;                   /* æ‰‹æœºç«¯ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨æ¢è¡Œ */
    gap: 10px;
    justify-content: flex-end;
    flex-shrink: 0;                    /* åº•éƒ¨ä¸æ”¶ç¼© */
}

/* æ‰‹æœºç«¯é€‚é…ï¼šæŒ‰é’®å æ»¡è¡Œ */
@media (max-width: 480px) {
    .modal-content {
        padding: 20px;
    }
    /* å¼ºåˆ¶å¼¹çª—å†…æŒ‰é’®æ ·å¼ç»Ÿä¸€ */
.modal-footer button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px; /* åœ†è§’ä¸€è‡´ */
    font-weight: 600;
    white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œå¯¼è‡´é«˜åº¦æ’‘å¼€ */
    -webkit-appearance: none; /* æ¶ˆé™¤iOSé»˜è®¤å¤–è§‚ */
    appearance: none;
}

/* è¦†ç›–å¯èƒ½å¯¼è‡´é«˜åº¦ä¸ä¸€çš„è¾¹æ¡†å·®å¼‚ */
.modal-footer .btn-clear-danger,
.modal-footer .btn-indigo,
.modal-footer .btn-outline {
    border-width: 1px;
    border-style: solid;
}
}


/* ç‰ˆæƒä¿¡æ¯æ ·å¼ */
.footer-copyright {
    text-align: center;
    color: #94a3b8;
    font-size: 12px;
    margin: 40px auto 20px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
    max-width: 480px; /* é™åˆ¶å®½åº¦è®©åˆ†å‰²çº¿æ›´ç²¾ç¾ */
}

.footer-link {
    color: #64748b;
    text-decoration: none;
    transition: 0.2s;
    font-weight: 500;
}

.footer-link:hover {
    color: var(--primary); /* æ‚¬åœæ—¶å˜è“è‰² */
    text-decoration: underline;
}

/* åœ¨æ‰‹æœºç«¯ç¨å¾®åŠ å¤§é—´è·æ–¹ä¾¿ç‚¹å‡» */
@media (max-width: 600px) {
    .footer-copyright {
        margin-top: 60px;
    }
}
/* é’ˆå¯¹ç”»åƒåˆ†æä¸­å›¾è¡¨çš„æ¨ªå‘æ»‘åŠ¨åŒ…è£… */
.scroll-container {
    width: 100%;
    overflow-x: auto; /* å¼€å¯æ¨ªå‘æ»šåŠ¨ */
    display: flex;
    gap: 15px;
    padding-bottom: 10px;
    /* éšè—æ»šåŠ¨æ¡ï¼ˆå¯é€‰ï¼Œå–å†³äºå®¡ç¾ï¼‰ */
    -webkit-overflow-scrolling: touch;
}

/* ç¡®ä¿æ¯ä¸ªå›¾è¡¨åœ¨æ»‘åŠ¨å®¹å™¨ä¸­æœ‰ä¸€ä¸ªå›ºå®šå®½åº¦ï¼Œé˜²æ­¢è¢«æŒ¤å‹ */
.scroll-item {
    flex: 0 0 280px; /* å…³é”®ï¼šæ¯ä¸ªå›¾è¡¨æœ€å°å®½åº¦ 280pxï¼Œä¸æ”¶ç¼© */
    max-width: 80%;
}

/* å…¼å®¹ç§»åŠ¨ç«¯çš„å¹³æ»‘æ»šåŠ¨ */
.scroll-container::-webkit-scrollbar {
    height: 4px;
}
.scroll-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}



        body { font-family: 'PingFang SC', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .card { background: white; padding: 18px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .hidden { display: none !important; }

        .nav-header { max-width: 800px; margin: 0 auto 15px; display: flex; justify-content: space-between; align-items: center; }
        button { border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 4px; }
        .btn-indigo { background: #6366f1; color: white; padding: 8px 16px; font-size: 13px; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #64748b; padding: 7px 14px; font-size: 13px; }
        .btn-mini-export { background: #f8fafc; color: #64748b; padding: 4px 10px; font-size: 12px; border: 1px solid #e2e8f0; justify-content: center; border-radius: 4px; }
        .btn-primary { background: var(--primary); color: white; padding: 10px; justify-content: center; width: 100%; }

        .container { max-width: 800px; margin: 0 auto;padding:0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; font-size: 14px; background: white; }

        .import-area { border: 2px dashed #cbd5e1; padding: 20px; border-radius: 10px; text-align: center; background: #fff; cursor: pointer; margin-bottom: 15px; transition: 0.3s; }
        .import-area:hover, .import-area.dragover { border-color: var(--primary); background: #f0f7ff; }
        #fileInput { display: none; }

/* å®¹å™¨æ”¯æŒæ¨ªå‘æ»šåŠ¨ */
.table-container {
    width: 100%;
    overflow-x: auto; /* å…³é”®ï¼šå¼€å¯æ¨ªå‘æ»šåŠ¨ */
    -webkit-overflow-scrolling: touch; /* æå‡ç§»åŠ¨ç«¯æ»‘åŠ¨æµç•…åº¦ */
    margin-top: 10px;

}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    white-space: nowrap; /* å…³é”®ï¼šå¼ºåˆ¶æ–‡å­—ä¸æ¢è¡Œ */
    min-width: 500px; /* å…³é”®ï¼šä¿è¯åœ¨çª„å±ä¸‹æ’‘å¼€å®¹å™¨äº§ç”Ÿæ»šåŠ¨æ¡ */
}

/* è®©æ“ä½œåˆ—å›ºå®šåœ¨å³ä¾§ï¼ˆå¯é€‰ï¼‰ */
th:last-child, td:last-child {
    position: sticky;
    right: 0;
    background: white; /* å¿…é¡»è®¾ç½®èƒŒæ™¯è‰²é®æŒ¡ä¸‹æ–¹æ–‡å­— */
    z-index: 10;
    box-shadow: -2px 0 5px rgba(0,0,0,0.05); /* åŠ ä¸ªé˜´å½±åŒºåˆ†è¾¹ç•Œ */
}

/* é’ˆå¯¹æ“ä½œæŒ‰é’®çš„å¾®è°ƒ */
.action-link {
    font-weight: bold;
    font-size: 12px;
    text-decoration: none;
    padding: 4px 8px;
}        th { background: #f8fafc; padding: 10px; text-align: left; color: #64748b; border-bottom: 1px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }

        .stat-item { flex: 1; padding: 10px; border-radius: 8px; background: #f8fafc; border-left: 4px solid var(--primary); }
        .stat-item h4 { margin: 0; font-size: 10px; color: #64748b; }
        .stat-item p { margin: 4px 0 0 0; font-size: 14px; font-weight: bold; }

.chart-wrap {
    position: relative;
    height: 300px; /* é»˜è®¤é«˜åº¦ */
    width: 100%;
    max-width: 100%; /* ç¡®ä¿ä¸è¶…å‡ºçˆ¶çº§ */
    margin: 10px auto;
    overflow: hidden; /* é˜²æ­¢æº¢å‡ºå†…å®¹æ˜¾ç¤º */
}

/* é’ˆå¯¹æ‰‹æœºç­‰çª„å±è¿›è¡Œä¼˜åŒ– */
@media (max-width: 600px) {
    .chart-wrap {
        height: 240px; /* å±å¹•çª„æ—¶å‡å°é«˜åº¦ */
    }
}

        .target-input-box { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #e2e8f0; }
        .highlight-success { color: var(--success); }
        .highlight-danger { color: var(--danger); }

.alert-box { padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px; line-height: 1.6;}
.alert-warn { background: #fff7ed; border: 1px solid #ffedd5; color: #9a3412; }
.alert-heart { background: #f0fdf4; border: 1px solid #dcfce7; color: #166534; }
.badge-name { display: inline-block; background: white; padding: 2px 8px; border-radius: 4px; margin: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

#pReminder {
    grid-column: span 2; /* å¼ºåˆ¶æé†’æ¡†æ¨ªè·¨ç½‘æ ¼çš„ä¸¤åˆ—ï¼Œå æ»¡æ•´è¡Œ */
    width: 100%;
}


/* æ—¥æœŸè¾“å…¥æ¡†é¢„è®¾æ–‡å­—æ ·å¼ */
.date-input {
    position: relative;
}

.date-input::before {
    content: attr(data-placeholder);
    position: absolute;
    color: #94a3b8; /* ç°åº¦æ–‡å­—é¢œè‰²ï¼Œä¸ placeholder ä¸€è‡´ */
    background-color: white;
    left: 10px;
    right: 30px; /* ç•™å‡ºæ¸…é™¤æŒ‰é’®å’Œå›¾æ ‡çš„ä½ç½® */
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none; /* ç¡®ä¿ç‚¹å‡»æ–‡å­—ä¹Ÿèƒ½è§¦å‘è¾“å…¥æ¡† */
}

/* å½“è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æˆ–å·²æœ‰å†…å®¹æ—¶ï¼Œéšè—ä¼ªå…ƒç´ æ–‡å­— */
.date-input:focus::before,
.date-input:not(:placeholder-shown)::before,
.date-input:valid::before {
    display: none;
}


/* å¦‚æœéœ€è¦æ›´ç²¾ç»†çš„æ ·å¼ï¼Œå¯ä»¥åœ¨ style æ ‡ç­¾ä¸­å¾®è°ƒ */
.btn-clear-danger {
    background: #fff;
    color: var(--danger);
    border: 1px solid #fee2e2;
    padding: 8px;
    width: 100%;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    transition: 0.2s;
}

.btn-clear-danger:hover {
    background: #fef2f2;
    border-color: var(--danger);
}

/* æµ®åŠ¨å®¹å™¨ */
.floating-container {
    position: fixed;
    right: 20px;
    bottom: 30px;
    z-index: 5000;
    display: flex;
    flex-direction: column-reverse;
    align-items: center;
    gap: 10px; /* æŒ‰é’®ä¹‹é—´çš„å‚ç›´é—´è· */
    touch-action: none; /* é‡è¦ï¼šé˜²æ­¢ç§»åŠ¨ç«¯è§¦å‘é¡µé¢æ»šåŠ¨ */
    cursor: move;    /* æç¤ºç”¨æˆ·å¯ä»¥ç§»åŠ¨ */
}

/* æŒ‰é’®é€æ˜åŒ–ä¸ç£¨ç ‚å¤„ç† */
.float-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.4) !important;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 1px solid rgba(226, 232, 240, 0.6) !important;
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(15px) scale(0);
    pointer-events: none;
    transition: transform 0.2s;
}

/* ä¸»æŒ‰é’®æ ·å¼ï¼šè“è‰²åŠé€æ˜ */
.btn-main {
    opacity: 0.6 !important;
    transform: translateY(0) scale(1) !important;
    pointer-events: auto !important;
    background: rgba(59, 130, 246, 0.5) !important;
    color: white !important;
    border: none !important;
}

.floating-container.active .btn-main { opacity: 1 !important; }
.floating-container.active .float-btn {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}

/* ç›®å½•å¼¹çª—åˆ—è¡¨æ ·å¼ */
.menu-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px 0;
}

.menu-item {
    padding: 15px;
    background: #f8fafc;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    color: var(--text);
    font-weight: 600;
    transition: 0.2s;
}



.menu-item:hover {
    background: #e2e8f0 !important;
    color: var(--primary) !important;
}

.menu-item span { font-size: 16px; } /* å›¾æ ‡å¤§å° */

    /* ç¡®ä¿ .hidden ç±»çš„æƒé‡è¶³å¤Ÿ */
.hidden { display: none !important; }

/* è®©åˆ‡æ¢æŒ‰é’®çœ‹èµ·æ¥åƒä¸€ä¸ªè¾…åŠ©åŠŸèƒ½ */
.btn-outline[onclick="toggleImportArea()"]:hover {
    background-color: #f1f5f9;
    border-color: var(--primary);
    color: var(--primary);
}
/* è®©æ‰€æœ‰è¡¨å•å…ƒç´ éƒ½éµå¾ªä¸€è‡´çš„å®½åº¦è®¡ç®—è§„åˆ™ */
/* é’ˆå¯¹ iOS Firefox çš„è¡¨å•ä¸€è‡´æ€§ä¿®å¤ */
#careLogPage input,
#careLogPage select,
#careLogPage textarea {
    box-sizing: border-box;
    width: 100%;
    /* æ ¸å¿ƒï¼šè®¾ç½®ç»Ÿä¸€çš„é«˜åº¦å’Œå†…è¾¹è· */
    height: 42px;
    padding: 8px 12px;

    /* æ¶ˆé™¤ iOS é»˜è®¤é˜´å½±å’Œåœ†è§’ */
    -webkit-appearance: none;
    appearance: none;

    /* å¼ºåˆ¶å­—ä½“å’Œè¡Œé«˜ä¸€è‡´ */
    font-size: 14px;
    line-height: normal;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background-color: white;
}

/* æ–‡æœ¬æ¡†ï¼ˆtextareaï¼‰é€šå¸¸éœ€è¦æ›´é«˜ï¼Œæ‰€ä»¥è¦†ç›–é«˜åº¦ */
#careLogPage textarea {
    height: 100px;
    line-height: 1.6;
    resize: none; /* é˜²æ­¢æ‰‹åŠ¨æ‹‰ä¼¸ç ´åå¸ƒå±€ */
}

/* é’ˆå¯¹ Select å…ƒç´ çš„ç‰¹æ®Šå¤„ç†ï¼ˆiOS ä¸‹éœ€è¦èƒŒæ™¯å›¾æ ‡æ¥æ›¿ä»£è¢«æ¶ˆé™¤çš„é»˜è®¤ç®­å¤´ï¼‰ */
#careLogPage select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
    padding-right: 30px; /* ä¸ºç®­å¤´ç•™å‡ºç©ºé—´ */
}

/* è§£å†³ iOS ç‚¹å‡»è¾“å…¥æ¡†è‡ªåŠ¨æ”¾å¤§çš„é—®é¢˜ */
@media screen and (max-width: 768px) {
    input,
    select,
    textarea,
    #careLogPage input,
    #careLogPage select,
    #careLogPage textarea,
    #anaYearSelect {
        font-size: 16px !important; /* å¼ºåˆ¶è®¾ä¸º 16px é˜»æ­¢ç¼©æ”¾ */
    }

    /* å¦‚æœè§‰å¾— 16px æ–‡å­—åœ¨å°å±ä¸Šå¤ªå¤§ï¼Œå¯ä»¥ç”¨ transform ç¼©å°è§†è§‰æ•ˆæœï¼Œä½†ä¿æŒç‰©ç†å°ºå¯¸ä¸º 16px */
    /* æˆ–è€…ä¿æŒç°çŠ¶ï¼Œ16px æ˜¯ iOS ä½“éªŒæœ€èˆ’é€‚çš„å°ºå¯¸ */
}

    </style>

</head>
<body>

<div class="floating-container" id="floatContainer">
    <button class="float-btn btn-main" onclick="openNavMenu()" id="mainFloatBtn" style="opacity:1; pointer-events:auto; transform: scale(1);">
        <svg id="menuIcon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
</div>

<div id="navMenuModal" class="modal-overlay hidden" onclick="closeNavMenu()">
    <div class="modal-content" style="max-width: 260px; padding: 16px;" onclick="event.stopPropagation()">
        <div class="modal-header" style="margin-bottom: 12px; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9;">
            <h3 style="margin:0; font-size:15px; color: #475569;">ğŸš€ å¿«é€Ÿå¯¼èˆª</h3>
            <div style="display: flex; gap: 8px;">
                <button onclick="scrollToTop()" style="padding: 8px; background: #f1f5f9; border-radius: 8px; color: #64748b; border: 1px solid #e2e8f0; cursor: pointer;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 15l-6-6-6 6"/></svg>
                </button>
                <button onclick="scrollToBottom()" style="padding: 8px; background: #f1f5f9; border-radius: 8px; color: #64748b; border: 1px solid #e2e8f0; cursor: pointer;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                </button>
            </div>
        </div>

        <div class="modal-body menu-list">
            <div class="menu-item" onclick="jumpTo('index')"><span>ğŸ </span> é¦–é¡µ</div>
            <div class="menu-item" onclick="jumpTo('home')"><span>ğŸ“‹</span> æ”¯æŒè®°å½•</div>
            <div class="menu-item" onclick="jumpTo('analysis')"><span>ğŸ“Š</span> è´¢åŠ¡åˆ†æ</div>
            <div class="menu-item" onclick="jumpTo('supporter')"><span>ğŸ‘¥</span> æ”¯æŒè€…åå†Œ</div>
            <div class="menu-item" onclick="jumpTo('supporterAnalysisPage')"><span>ğŸ‘¤</span> ç”»åƒåˆ†æ</div>
            <div class="menu-item" onclick="jumpTo('careLog')"><span>ğŸ“</span> å…³æ€€æ—¥å¿—</div>
            <div class="menu-item" onclick="jumpTo('budget')"><span>ğŸ’°</span> é¢„ç®—çœ‹æ¿</div>
        </div>
    </div>
</div>

<div id="usageModal" class="modal-overlay hidden" onclick="toggleUsageModal(false)">
    <div class="modal-content" style="max-width: 400px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 style="margin:0; font-size:16px; color: #1e293b;">ğŸ“˜ ç³»ç»Ÿä½¿ç”¨é¡»çŸ¥</h3>
        </div>
        <div class="modal-body" style="font-size: 14px; color: #475569; line-height: 1.8;">
1ã€è¯·ä½¿ç”¨æµè§ˆå™¨**æ— ç—•æ¨¡å¼**æ‰“å¼€ï¼›æˆ–è€…æ¯æ¬¡ç”¨å®Œåï¼Œè¿”å›ã€é¦–é¡µã€‘å¯¼å‡ºæ•°æ®åº“ï¼Œç„¶åæ¸…ç©ºæ•°æ®ã€‚
<br><br>
2ã€æœ¬ç³»ç»Ÿä¸ä¿å­˜ä»»ä½•æ•°æ®ï¼Œå…³æµè§ˆå™¨æˆ–æ¸…ç©ºæ•°æ®å‰ï¼Œè¯·åŠ¡å¿…**ä¸€é”®å¯¼å‡ºæ•°æ®åº“âš ï¸** åˆæ¬¡ä½¿ç”¨åï¼Œä»¥åæ¯æ¬¡æ‰“å¼€ç³»ç»Ÿæ—¶è¯·å…ˆå¯¼å…¥æ•°æ®åº“ã€‚
<br><br>
3ã€æœ¬ç³»ç»Ÿé‡‡ç”¨æ•°æ®åŠ å¯†ï¼Œæ¯æ¬¡æ•°æ®åº“å¯¼å‡ºæ—¶è®¾å®šå¯†ç ï¼ˆ**ä¸å°‘äº8ä½**ï¼Œå¦åˆ™æ˜“è¢«ç ´è§£ï¼å¯†ç å¯ä»¥ä¸å˜ã€‚ï¼‰ä¸ºäº†å®‰å…¨å› ç´ ï¼Œå¯¼å‡ºæ•°æ®åº“å±äºåŠ å¯†æ ¼å¼ï¼Œå¯¼å…¥æœ¬ç³»ç»Ÿåå¯ä»¥æ­£å¸¸æŸ¥çœ‹ã€‚
<br>
=========================================
        </div>
        <div class="modal-footer">
            <button class="btn-indigo" style="width: 100%; justify-content: center;" onclick="toggleUsageModal(false)">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>

<div class="container">

    <div class="nav-header hidden">
    <h3 id="mainTitle" style="margin:0; flex-grow: 1;">æ”¯æŒç®¡ç†ç³»ç»Ÿ</h3>

<div id="navButtons" style="display: flex; gap: 8px; align-items: center;">
    <button id="toHome" class="btn-outline hidden" onclick="showPage('home')">ğŸ  æ”¯æŒè®°å½•</button>

    <button id="toSupporter" class="btn-outline hidden" onclick="showPage('supporter')">ğŸ‘¥ æ”¯æŒè€…ç®¡ç†</button>

    <button id="toCareLog" class="btn-outline hidden" onclick="showPage('careLog')">ğŸ“ å…³æ€€æ—¥å¿—</button>

    <button id="toIndex" class="btn-outline hidden" onclick="showPage('index')">ğŸ  è¿”å›é¦–é¡µ</button>
</div>
</div>

<div id="indexPage" class="container" style="max-width: 800px; display: flex; flex-direction: column; align-items: center; padding-top: 40px;">

    <div style="text-align: center; margin-bottom: 40px; width: 100%;">
        <h2 style="margin: 0; color: var(--text); font-size: 1.8rem;">æ”¯æŒç®¡ç†ç³»ç»Ÿ</h2>
<p style="color: #64748b; margin-top: 10px; font-size: 14px;">æ™ºèƒ½åŒ–æ”¶æ”¯åˆ†æä¸æ”¯æŒè€…å…³ç³»ç»´æŠ¤</p>
<p style="margin-top: -5px;">
    <a href="javascript:void(0)" onclick="toggleUsageModal(true)" style="color: #94a3b8; font-size: 11px; text-decoration: underline;">ä½¿ç”¨é¡»çŸ¥</a>
</p>    </div>

    <div style="width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 15px;">

          <div class="card" onclick="showPage('home')" style="cursor: pointer; display: flex; align-items: center; padding: 22px; transition: 0.3s; border-left: 6px solid var(--primary); margin-bottom: 0;" onmouseover="this.style.backgroundColor='#eff6ff'; this.style.transform='translateX(5px)'" onmouseout="this.style.backgroundColor='white'; this.style.transform='translateX(0)'">
            <div style="font-size: 30px; margin-right: 20px;">ğŸ </div>
            <div style="text-align: left;">
                <h3 style="margin: 0; color: #1d4ed8; font-size: 17px;">æ”¯æŒè®°å½•ç³»ç»Ÿ</h3>
                <p style="font-size: 12px; color: #64748b; margin-top: 4px;">æ—¥å¸¸å¥‰çŒ®å½•å…¥ä¸è´¢åŠ¡è¶‹åŠ¿ä¸­å¿ƒ</p>
            </div>
        </div>



        <div class="card" onclick="showPage('supporter')" style="cursor: pointer; display: flex; align-items: center; padding: 22px; transition: 0.3s; border-left: 6px solid #6366f1; margin-bottom: 0;" onmouseover="this.style.backgroundColor='#f5f3ff'; this.style.transform='translateX(5px)'" onmouseout="this.style.backgroundColor='white'; this.style.transform='translateX(0)'">
            <div style="font-size: 30px; margin-right: 20px;">ğŸ‘¥</div>
            <div style="text-align: left;">
                <h3 style="margin: 0; color: #4338ca; font-size: 17px;">æ”¯æŒè€…ç®¡ç†ç³»ç»Ÿ</h3>
                <p style="font-size: 12px; color: #64748b; margin-top: 4px;">ç®¡ç†åå†Œã€æ‰¿è¯ºé¢åº¦ä¸ç”»åƒåˆ†æ</p>
            </div>
        </div>

         <div class="card" onclick="showPage('budget')" style="cursor: pointer; display: flex; align-items: center; padding: 22px; transition: 0.3s; border-left: 6px solid #f59e0b; margin-bottom: 0;" onmouseover="this.style.backgroundColor='#fffbeb'; this.style.transform='translateX(5px)'" onmouseout="this.style.backgroundColor='white'; this.style.transform='translateX(0)'">
            <div style="font-size: 30px; margin-right: 20px;">ğŸ’°</div>
            <div style="text-align: left;">
                <h3 style="margin: 0; color: #b45309; font-size: 17px;">æ”¶æ”¯é¢„ç®—çœ‹æ¿</h3>
                <p style="font-size: 12px; color: #64748b; margin-top: 4px;">é…ç½®éœ€æ±‚ï¼Œè‡ªåŠ¨æ¨å¯¼ç­¹æ¬¾ç›®æ ‡</p>
            </div>
        </div>





<div style="width: 100%; max-width: 100%; box-sizing: border-box; margin-top: 30px; display: flex; flex-direction: column; gap: 12px;">

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button class="btn-mini-export" onclick="exportSystemToZip()" 
            style="background: #059669; color: #fff; height: 50px; border: none; border-radius: 12px; font-size: 13px; box-shadow: 0 4px 6px rgba(5, 150, 105, 0.2); cursor: pointer;">
            ğŸ“¦ ä¸€é”®å¯¼å‡ºæ•°æ®åº“(zip)
        </button>
        
        <button class="btn-mini-export" onclick="document.getElementById('zipImportInput').click()" 
            style="background: #3b82f6; color: #fff; height: 50px; border: none; border-radius: 12px; font-size: 13px; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2); cursor: pointer;">
            ğŸ“¤ ä¸€é”®å¯¼å…¥æ•°æ®åº“(zip)
        </button>
        <input type="file" id="zipImportInput" accept=".zip" style="display:none;" onchange="importSystemFromZip(this)">
    </div>

    <div style="display: grid; grid-template-columns: 1fr;">
        <button class="btn-mini-export" onclick="clearAllGlobalData()" 
            style="background: #fff5f5; border: 1px solid #feb2b2; color: #c53030; height: 50px; border-radius: 12px; font-size: 13px; width: 100%; cursor: pointer;">
            âš  ä¸€é”®æ¸…ç©ºæ‰€æœ‰æ•°æ®
        </button>
    </div>

    <p style="text-align: center; color: #a0aec0; font-size: 11px; margin-top: 5px;">
        æœ¬ç³»ç»Ÿä¸ä¿å­˜ä»»ä½•æ•°æ®ï¼Œå…³æµè§ˆå™¨æˆ–æ¸…ç©ºæ•°æ®å‰ï¼Œ<br>è¯·åŠ¡å¿…ä¸€é”®å¯¼å‡ºæ•°æ®åº“âš ï¸
    </p>
</div>

    </div>
</div>

<div id="supporterPage" class="hidden">
<div class="card">
    <h4>ğŸ“‹ æ–°å¢/ç¼–è¾‘æ”¯æŒè€…æ¡£æ¡ˆ</h4>
    <form id="supporterForm">
        <div class="grid-2">
            <input type="text" id="supStartDate" placeholder="å¼€å§‹æ—¥æœŸ" required onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">
            <input type="text" id="supEndDate" placeholder="ç»“æŸæ—¥æœŸ" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">
        </div>
        <div class="grid-2">
            <input type="text" id="supName" list="supNameList" placeholder="å§“å" required onmousedown="forceShowAllSupporterNames(this)" oninput="autoFillSupporterProfile()">
            <datalist id="supNameList"></datalist>
            <input type="text" id="supGender" list="genderList" placeholder="æ€§åˆ«" onmousedown="forceShowAll(this)" required>
            <datalist id="genderList"><option value="ç”·"><option value="å¥³"><option value="å…¶ä»–"></option></datalist>
        </div>
        <div class="grid-2">
            <input type="text" id="supCity" list="supCityList" placeholder="åŸå¸‚" onmousedown="forceShowAllCities(this)">
            <datalist id="supCityList"></datalist>
            <input type="text" id="supFreq" list="supFreqList" placeholder="é¢‘ç‡" onmousedown="forceShowAll(this)" required>
            <datalist id="supFreqList"><option value="æŒ‰æœˆ"><option value="æŒ‰å¹´"><option value="ä¸å®šæœŸ"></datalist>
        </div>
        <div class="grid-2" style="margin-top:10px;">
            <input type="number" id="supAmount" placeholder="æ‰¿è¯ºé‡‘é¢" step="0.01">
            <input type="text" id="supRemark" placeholder="å¤‡æ³¨">
        </div>
        <button type="submit" class="btn-primary" style="margin-top:10px;">ä¿å­˜æ”¯æŒè€…æ¡£æ¡ˆ</button>
    </form>

    <div style="margin-top: 10px;">
        <button type="button" class="btn-outline" style="width: 100%; justify-content: center; background: #f0fdf4; border-color: #bbf7d0; color: #166534;" onclick="openBulkImportModal()">
            âš¡ å¿«é€Ÿæ‰¹é‡ç²˜è´´å½•å…¥
        </button>
    </div>

     <div style="margin-top: 10px;">
            <button type="button" class="btn-outline" style="width: 100%; justify-content: center; border-style: dashed; color: #64748b;" onclick="toggleSupImportArea()">
                ğŸ‘¤ å±•å¼€/éšè—æ‰¹é‡å¯¼å…¥åå†Œ (CSV)
            </button>
        </div>

    <div id="supImportWrapper" class="hidden" style="margin-top: 15px;">
        <div id="supDropZone" class="import-area" onclick="document.getElementById('supFileInput').click()" ondragover="handleDrag(event, true, 'supDropZone')" ondragleave="handleDrag(event, false, 'supDropZone')" ondrop="handleSupDrop(event)">
            <p style="margin:0; font-size:14px; color:#475569; font-weight: bold;">ğŸ‘¤ ç‚¹å‡»å¯¼å…¥æ”¯æŒè€…åå†Œ (CSV)</p>
            <input type="file" id="supFileInput" accept=".csv" style="display:none;" onchange="processSupFile(this.files[0])">
        </div>
        <div style="text-align: right; margin-top: -5px;">
            <a href="javascript:void(0)" onclick="downloadSupTemplate()" style="font-size: 11px; color: var(--primary);">ä¸‹è½½æ”¯æŒè€…æ¨¡ç‰ˆ</a>
        </div>
    </div>
</div>

<div id="bulkImportModal" class="modal-overlay hidden" onclick="closeBulkImportModal()">
    <div class="modal-content" style="max-width: 850px; width: 95%; padding: 20px;" onclick="event.stopPropagation()">
        <div class="modal-header" style="margin-bottom: 12px; padding-bottom: 10px;">
            <h3 style="margin:0; font-size: 16px;">âš¡ å¿«é€Ÿæ‰¹é‡å½•å…¥</h3>
            <p style="font-size: 11px; color: #64748b; margin: 4px 0 0 0;">
                å›è½¦æ¢è¡Œæ·»åŠ æ–°è®°å½•<br><br>
                æ ¼å¼ï¼šå¼€å§‹æ—¥æœŸ, ç»“æŸæ—¥æœŸ, å§“å, æ€§åˆ«<strong style="color: #9a3412;">ï¼ˆç”·ã€å¥³ã€å…¶ä»–ï¼‰</strong>, åŸå¸‚, é¢‘ç‡<strong style="color: #9a3412;">ï¼ˆæŒ‰æœˆã€æŒ‰å¹´ã€ä¸å®šæœŸï¼‰</strong>, é‡‘é¢, å¤‡æ³¨<br><br>
                <strong>ç¤ºä¾‹ï¼š</strong>2026-01-01,2026-12-31 , å¼ ä¸‰, ç”·, åŒ—äº¬, æŒ‰æœˆ, 100, æ—¥å¸¸æ”¯æŒ
            </p>
        </div>

        <div class="modal-body" style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
            <textarea id="bulkInputArea" wrap="off" placeholder="åœ¨æ­¤ç²˜è´´å¤šè¡Œæ•°æ®..."
                style="
                    width: 95%;
                    height: 150px;
                    resize: none;      /* ç¦æ­¢ç”¨æˆ·æ‰‹åŠ¨æ‹–æ‹½å³ä¸‹è§’ */
                    overflow-y: auto;  /* å†…å®¹å¤šæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ï¼Œè€Œä¸æ˜¯æ’‘å¼€å®¹å™¨ */
                    margin: 0 auto 15px auto;
                    display: block;
                    padding: 12px;
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    font-family: 'Courier New', monospace;
                    font-size: 11px;
                    box-sizing: border-box;
                    flex-shrink: 0;
                    background: #fff;
                    outline: none;
                    white-space: pre;
                    overflow: auto;
                " oninput="previewBulkData()"></textarea>

                <p style=" font-size: 12px; color: #64748b;">å®æ—¶è§£æé¢„è§ˆ (å…± <span id="previewCount">0</span> æ¡)ï¼š</p>
                <div class="table-container" style="max-height: 250px; border: 1px solid #f1f5f9; border-radius: 8px; overflow-x: auto;">
                    <table style="min-width: 100%; background: #f8fafc; white-space: nowrap;margin-top: 0;">
                        <thead style="position: sticky; top: 0; z-index: 10;">
                           <tr style="font-size: 11px; background: #f1f5f9;">
            <th style="width: 40px;">å¼€å§‹æ—¥æœŸ</th>
            <th style="width: 40px;">ç»“æŸæ—¥æœŸ</th>
            <th style="width: 12px;">å§“å</th>
            <th style="width: 12px;">æ€§åˆ«</th>
            <th style="width: 12px;">åŸå¸‚</th>
            <th style="width: 12px;">é¢‘ç‡</th>
            <th style="width: 12px;">é‡‘é¢</th>
            <th>å¤‡æ³¨</th> </tr>
                        </thead>
                        <tbody id="bulkPreviewBody" style="font-size: 11px; background: #fff;">
                            <tr><td colspan="8" style="text-align:center; color:#94a3b8; padding: 20px;">ç­‰å¾…è¾“å…¥æ•°æ®...</td></tr>
                        </tbody>
                    </table>
                </div>


        </div>

        <div class="modal-footer" style="margin-top: 15px;">
            <button class="btn-outline" onclick="closeBulkImportModal()">å–æ¶ˆ</button>
            <button class="btn-indigo" onclick="confirmBulkImport()">ç¡®è®¤å¯¼å…¥è‡³åå†Œ</button>
        </div>
    </div>
</div>


    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
            <h4 style="margin:0">æ”¯æŒè€…åå†Œ <span id="supRecordCount" style="font-size:12px; color:#64748b; font-weight:normal;"></span></h4>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>å¼€å§‹æ—¥æœŸ</th><th>å§“å</th><th>æ€§åˆ«</th><th>åŸå¸‚</th><th>é¢‘ç‡</th><th>é‡‘é¢</th><th>çŠ¶æ€</th><th style="text-align:center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="supporterBody"></tbody>
            </table>
        </div>
    </div>

    <div style="display: flex; gap: 8px; margin-top: 12px;">
        <button type="button" class="btn-outline" style="flex: 1; justify-content: center; padding: 8px;" id="btnSupShowAll" onclick="toggleSupShowAll()">æ˜¾ç¤ºå…¨éƒ¨è®°å½•</button>

        <button type="button" class="btn-outline" style="flex: 1; justify-content: center; padding: 8px;" onclick="exportSupportersToCSV()">ğŸ“¤ å¯¼å‡º CSV</button>
        <button type="button" class="btn-outline" style="color: var(--danger); border-color: #fecaca; flex: 1; justify-content: center; padding: 8px;" onclick="clearAllSupporters()">ğŸ—‘ï¸ æ¸…ç©ºæ¡£æ¡ˆ</button>
    </div>

    <br>

    <button id="tosupAnalysis" class="btn-primary" style="background-color: #6366f1;" onclick="showPage('supporterAnalysisPage')">ğŸ“Š æ”¯æŒè€…åˆ†æ</button>

</div>

<div id="supporterAnalysisPage" class="hidden">



  <div class="card">

    <div class="grid-2">
    <div class="stat-item" style="border-left-color: #6366f1;">
        <h4>æ”¯æŒè€…æ€»äººæ•°</h4>
        <p id="anaTotalCount">0 ä½ (æ”¯æŒä¸­)</p>
    </div>
    <div class="stat-item" style="border-left-color: #22c55e;">
        <h4>æ‰¿è¯ºæœˆæ€»é¢ (æ´»è·ƒ)</h4>
        <p id="anaTotalPromise">Â¥ 0.00</p>
    </div>
</div>

<div class="grid-2" style="margin-top: 10px; align-items: center;">
    <div class="stat-item" style="border-left-color: #f59e0b; background: #fffbeb;">
        <h4>è®¾å®šæœˆç­¹æ¬¾ç›®æ ‡</h4>
        <input type="number" id="manualMonthlyTarget" placeholder="ç‚¹å‡»è¾“å…¥ç›®æ ‡é‡‘é¢"
               oninput="calculateGoalProgress()"
               style="border:none; background:transparent; padding:0; font-size:14px; font-weight:bold; color:var(--text); width:100%; outline:none;">
    </div>
    <div class="stat-item" id="goalGapItem" style="border-left-color: #cbd5e1;">
        <h4>æœˆç­¹æ¬¾å·®é¢</h4>
        <p id="anaGoalGap">Â¥ 0.00</p>
    </div>
</div>

<div style="margin-top: 15px; padding: 0 5px;">
    <div style="display:flex; justify-content:space-between; font-size:11px; color:#64748b; margin-bottom:5px;">
        <span>ç­¹æ¬¾è¾¾æˆè¿›åº¦</span>
        <span id="anaProgressPercent">0%</span>
    </div>
    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
        <div id="anaProgressBar" style="width: 0%; height: 100%; background: var(--success); transition: 0.5s;"></div>
    </div>
</div>
</div>


<div class="card" style="padding: 10px; text-align: center; margin-bottom: 15px;">
    <div style="display: inline-flex; background: #f1f5f9; padding: 4px; border-radius: 8px; gap: 8px; align-items: center;">

        <button id="btnViewAmount" class="btn-indigo"
            style="width: 80px; height: 32px; padding: 0; font-size: 12px; border:none; display: flex; align-items: center; justify-content: center;"
            onclick="switchSupAnalysisView('amount')">æŒ‰é‡‘é¢</button>

        <button id="btnViewCount" class="btn-outline"
            style="width: 80px; height: 32px; padding: 0; font-size: 12px; display: flex; align-items: center; justify-content: center; border-radius: 6px;"
            onclick="switchSupAnalysisView('count')">æŒ‰äººæ•°</button>

        <select id="anaYearSelect" onchange="renderSupporterAnalysis()"
            style="width: 80px; height: 32px; padding: 0; font-size: 12px; border: 1px solid #cbd5e1; border-radius: 6px; background: white; cursor: pointer; text-align: center;
                   /* æ ¸å¿ƒï¼šéšè—ç®­å¤´ */
                   -webkit-appearance: none; /* Chrome/Safari */
                   -moz-appearance: none;    /* Firefox */
                   appearance: none;         /* æ ‡å‡† */">
        </select>

    </div>
</div>

<div class="card">
    <h5 style="text-align:center; font-size:12px; color:#64748b; margin-bottom:8px;">æ”¯æŒè€…æ‰¿è¯ºæœˆæ€»é¢æ’å (Top 10)</h5>
    <div style="height:300px;">
        <canvas id="chartSupRank"></canvas>
    </div>
</div>

<div class="card">
    <div style="margin-top:20px;">
        <h5 style="text-align:center; font-size:12px; color:#64748b;">åŸå¸‚åˆ†å¸ƒ (Top 5)</h5>
        <div style="height:220px;"><canvas id="chartCity"></canvas></div>
    </div>
</div>

<div class="card" id="sunburstCard" style="cursor: pointer; transition: 0.3s;">
    <div id="sunburstPlaceholder" style="text-align: center; padding: 20px;" onclick="toggleSunburst()">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸŒ</div>
        <h4 style="margin: 0; color: #1e293b;">ç‚¹å‡»æŸ¥çœ‹ï¼šåŸå¸‚-æ”¯æŒè€…é‡‘é¢å æ¯”</h4>
        <p style="font-size: 12px; color: #64748b; margin-top: 5px;">æŸ¥çœ‹å„åŸå¸‚æ”¯æŒè€…çš„è¯¦ç»†è´¢åŠ¡è´¡çŒ®æ¯”ä¾‹</p>
    </div>

    <div id="sunburstContent" class="hidden">
        <h4 style="text-align:center; color:#1e293b; margin-bottom:15px;">ğŸŒ åŸå¸‚-æ”¯æŒè€…é‡‘é¢å æ¯” (æ—­æ—¥å›¾)</h4>
        <div style="position: relative; height: 350px; width: 100%;">
            <canvas id="chartSunburst"></canvas>
        </div>
        <div style="text-align: center; margin-top: 10px;">
             <button class="btn-mini-export" onclick="toggleSunburst()">æ”¶èµ·å›¾è¡¨</button>
        </div>
    </div>
</div>



<div class="card">
   <div class="scroll-container" style="
    display: flex;
    flex-wrap: wrap; /* å…³é”®ï¼šå±å¹•å¤Ÿå®½æ—¶å¹¶æ’ï¼Œä¸å¤Ÿå®½æ—¶è‡ªåŠ¨æ¢è¡Œæˆ–ç¼©æ”¾ */
    gap: 15px;
    margin-top: 20px;
    width: 100%;
    box-sizing: border-box;
">
    <div class="scroll-item" style="
        flex: 1 1 240px; /* æœ€å°å®½åº¦240pxï¼Œå‰©ä½™ç©ºé—´å¹³åˆ† */
        max-width: 100%;
        min-width: 0; /* å…è®¸ flex é¡¹ç›®ç¼©å°åˆ°æ¯”å†…å®¹æ›´å°ï¼Œé˜²æ­¢æº¢å‡º */
    ">
        <h5 style="text-align:center; font-size:12px; color:#64748b; margin-bottom:8px;">æ€§åˆ«åˆ†å¸ƒ</h5>
        <div style="position: relative; height: 180px; width: 100%;">
            <canvas id="chartGender"></canvas>
        </div>
    </div>

    <div class="scroll-item" style="
        flex: 1 1 240px;
        max-width: 100%;
        min-width: 0;
    ">
        <h5 style="text-align:center; font-size:12px; color:#64748b; margin-bottom:8px;">æ”¯æŒé¢‘ç‡</h5>
        <div style="position: relative; height: 180px; width: 100%;">
            <canvas id="chartFreq"></canvas>
        </div>
    </div>
</div>


</div>
<div class="card" style="border-top: 4px solid #6366f1; margin-top: 20px;">
    <h4 style="color: #1e293b; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
        ğŸ‘¤ æ”¯æŒè€…ä¸ªäººæ·±åº¦ç”»åƒ
    </h4>

    <div class="grid-2" style="margin-bottom: 20px;">
        <div class="input-group">

<input type="text" id="individualSearch" list="supNameList" placeholder="è¾“å…¥å§“å..."
       oninput="renderIndividualProfile()"
       onchange="renderIndividualProfile()">
    </div>

    </div>
 <div class="stat-item" style="border-left-color: #6366f1; background: #f0f4ff;">
    <h4>æ¡£æ¡ˆå¤‡æ³¨</h4>
    <p id="individualRemark" style="font-size: 13px; color: #475569; font-weight: normal; min-height: 20px;">è¯·å…ˆé€‰æ‹©æ”¯æŒè€…</p>
</div>
<br>
<div id="individualLatestCare" style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
    </div>
<br>
    <div style="margin-top: 10px;">
        <h5 style="text-align:center; font-size:12px; color:#64748b; margin-bottom:8px;">è¿‘ 5 å¹´æœˆåº¦æ”¯æŒè¶‹åŠ¿ (æ‰¿è¯ºé¢ vs å®é™…å¥‰çŒ®)</h5>
        <div style="height:260px;">
            <canvas id="individualTrendChart"></canvas>
        </div>
    </div>
</div>

    </div>


<div id="budgetPage" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin:0; color:#1e293b; font-size:22px; font-weight:bold;">é¢„ç®—ç®¡ç†ç³»ç»Ÿ</h2>
        <button class="btn-outline" onclick="showPage('index')" >
            ğŸ  è¿”å›é¦–é¡µ
        </button>
    </div>

    <div class="card" style="padding:12px; margin-bottom:20px; background:#f8fafc; display:flex; justify-content: space-between; align-items: center;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:12px; color:#64748b;">æ—¥æœŸ</span>
            <input type="date" id="budgetDate" style="padding:4px 8px; font-size:12px; border-radius:6px; border:1px solid #cbd5e1;">
        </div>
        <div style="display:flex; gap:6px;">
            <button class="btn-mini-export" onclick="loadBudgetPresets()" style="background:#fefce8; color:#854d0e; border-color:#fef08a;">é¢„è®¾</button>
            <button class="btn-mini-export" onclick="clearBudgetInputs()" style="background:#fff1f2; color:#be123c; border-color:#fecdd3;">æ¸…ç©º</button>
        </div>
    </div>

    <div class="card" style="border-top: 4px solid #f59e0b;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h4 style="margin:0; color:#b45309;">å·¥èµ„/ç”Ÿæ´»å¼€æ”¯ (æœˆåº¦)</h4>
            <b id="salary_m_total" style="color:#ea580c; font-size:15px; background:#fff7ed; padding:2px 10px; border-radius:12px;">Â¥ 0</b>
        </div>
        <div id="salaryForm" class="grid-2">
            <div class="input-group"><label>é¥®é£Ÿæ¥å¾… (1300)</label><input type="number" class="calc-salary" id="b_food" oninput="calculateBudget()"></div>
            <div class="input-group"><label>ä¸ªé•¿åŸºé‡‘ (50)</label><input type="number" class="calc-salary" id="b_growth" oninput="calculateBudget()"></div>
            <div class="input-group"><label>å¸‚å†…äº¤é€š (100)</label><input type="number" class="calc-salary" id="b_traffic" oninput="calculateBudget()"></div>
            <div class="input-group"><label>ç”µè¯é€šè®¯ (50)</label><input type="number" class="calc-salary" id="b_phone" oninput="calculateBudget()"></div>
            <div class="input-group"><label>æ—¥å¸¸ç”¨å“ (50)</label><input type="number" class="calc-salary" id="b_daily" oninput="calculateBudget()"></div>
            <div class="input-group"><label>å¨±ä¹ä¹¦çº¦ (50)</label><input type="number" class="calc-salary" id="b_fun" oninput="calculateBudget()"></div>
            <div class="input-group"><label>ç¤¼ç‰©æ”¯å‡º (50)</label><input type="number" class="calc-salary" id="b_gift" oninput="calculateBudget()"></div>
            <div class="input-group"><label>è¡£é‹çœ¼é•œ (100)</label><input type="number" class="calc-salary" id="b_cloth" oninput="calculateBudget()"></div>
            <div class="input-group"><label>æˆ¿ç§Ÿç‰©ä¸š (2700)</label><input type="number" class="calc-salary" id="b_rent" oninput="calculateBudget()"></div>
            <div class="input-group"><label>æ°´ç”µæ°”æš– (300)</label><input type="number" class="calc-salary" id="b_util" oninput="calculateBudget()"></div>
            <div class="input-group"><label>å¥‰çŒ®è´£ä»» (1000)</label><input type="number" class="calc-salary" id="b_tithing" oninput="calculateBudget()"></div>
            <div class="input-group"><label>çˆ¶æ¯èµ¡å…» (1000)</label><input type="number" class="calc-salary" id="b_parents" oninput="calculateBudget()"></div>
            <div class="input-group"><label>å‚¨è“„è®¡åˆ’ (1000)</label><input type="number" class="calc-salary" id="b_saving" oninput="calculateBudget()"></div>
            <div class="input-group"><label>çªå‘å¤‡ç”¨ (100)</label><input type="number" class="calc-salary" id="b_emergency" oninput="calculateBudget()"></div>
            <div class="input-group"><label>å…¬å…±ç”¨å“ (100)</label><input type="number" class="calc-salary" id="b_public" oninput="calculateBudget()"></div>
            <div class="input-group"><label>å­©å­æ•™è‚² (0)</label><input type="number" class="calc-salary" id="b_child" oninput="calculateBudget()"></div>
        </div>
    </div>

    <div class="card" style="border-top: 4px solid #10b981;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h4 style="margin:0; color:#065f46;">æŠ¥é”€æ”¯å‡º (æœˆåº¦/å¹´åº¦)</h4>
            <b id="reim_y_total" style="color:#059669; font-size:15px; background:#f0fdf4; padding:2px 10px; border-radius:12px;">Â¥ 0</b>
        </div>
        <div id="reimForm">
            <p style="font-size:11px; color:#94a3b8; margin:0 0 8px 0;">æ¯æœˆå›ºå®šé¡¹ï¼š</p>
            <div class="grid-2">
                <div class="input-group"><label>ç¤¾ä¿ (1360)</label><input type="number" class="calc-reim-m" id="b_social" oninput="calculateBudget()"></div>
                <div class="input-group"><label>å•†ä¿ (540)</label><input type="number" class="calc-reim-m" id="b_insure" oninput="calculateBudget()"></div>
            </div>
            <p style="font-size:11px; color:#94a3b8; margin:15px 0 8px 0;">å¹´åº¦ä¸€æ¬¡æ€§é¡¹ç›®ï¼š</p>
            <div class="grid-2">
                <div class="input-group"><label>ç­¾è¯ (300)</label><input type="number" class="calc-reim-y" id="b_visa" oninput="calculateBudget()"></div>
                <div class="input-group"><label>ä¼šè®®å·®æ—… (8000)</label><input type="number" class="calc-reim-y" id="b_travel" oninput="calculateBudget()"></div>
                <div class="input-group"><label>ç¥å­¦è¯¾ç¨‹ (2000)</label><input type="number" class="calc-reim-y" id="b_study" oninput="calculateBudget()"></div>
                <div class="input-group"><label>çŸ­å®£æ”¯å‡º (5000)</label><input type="number" class="calc-reim-y" id="b_mission" oninput="calculateBudget()"></div>
                <div class="input-group"><label>è¡Œæ”¿ç®¡ç† (5600)</label><input type="number" class="calc-reim-y" id="b_admin" oninput="calculateBudget()"></div>
                <div class="input-group"><label>VPN (650)</label><input type="number" class="calc-reim-y" id="b_vpn" oninput="calculateBudget()"></div>
                <div class="input-group"><label>MPD (1000)</label><input type="number" class="calc-reim-y" id="b_mpd" oninput="calculateBudget()"></div>
                <div class="input-group"><label>å›å®¶æ—…è´¹ (1000)</label><input type="number" class="calc-reim-y" id="b_home" oninput="calculateBudget()"></div>
            </div>
        </div>
    </div>

    <div class="card" style="background: #ffffff; color: #1e293b; border: 1px solid #e2e8f0; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); position: relative; overflow: hidden;">

    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: #3b82f6;"></div>

    <h4 style="margin:0 0 25px 0; color:#3b82f6; text-align:center; letter-spacing: 2px; font-size: 16px; font-weight: bold;">ğŸ“Š è´¢åŠ¡é¢„ç®—æ‰§è¡Œç»ˆè¡¨</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9;">
                <div style="font-size: 11px; color: #64748b; margin-bottom: 8px;">å·¥èµ„å¹´æ”¯å‡ºåˆè®¡</div>
                <b id="final_salary_y" style="font-size: 20px; color: #f59e0b;">Â¥ 0.00</b>
            </div>
            <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9;">
                <div style="font-size: 11px; color: #64748b; margin-bottom: 8px;">æŠ¥é”€å¹´æ€»é¢æŠ˜ç®—</div>
                <b id="final_reim_y" style="font-size: 20px; color: #10b981;">Â¥ 0.00</b>
            </div>
        </div>
        <div style="text-align: center; border-top: 1px dashed #e2e8f0; padding-top: 25px;">
            <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">å¹´åº¦æ”¯å‡ºæ€»é¢„ç®— (æŠ˜ç®—)</div>
            <b id="final_annual_total" style="font-size: 34px; color: #0f172a;">Â¥ 0.00</b>
            <div style="margin: 25px auto; width: 60px; height: 3px; background: #3b82f6; border-radius: 2px; opacity: 0.3;"></div>
            <div style="font-size: 14px; color: #2563eb; font-weight: bold; margin-bottom: 10px;">ğŸ¯ å»ºè®®æœˆç­¹æ¬¾ç›®æ ‡</div>
            <b id="final_monthly_avg" style="font-size: 42px; color: #2563eb;">Â¥ 0.00</b>
        </div>
        <div style="display:grid; grid-template-columns: 1fr; gap:15px; margin-top: 40px;">
            <button class="btn-primary" onclick="saveBudget()" style="background:#3b82f6; border-radius:10px; height:55px; font-weight: bold; color: white;">ğŸ’¾ ä¿å­˜å¹¶è®°å½•æ–¹æ¡ˆ</button>
        </div>
    </div>

  <div class="card" style="background: #ffffff; border: 1px solid #e2e8f0; margin-top: 20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #f1f5f9; padding-bottom:10px;">
        <h4 style="margin:0; color:#1e293b; font-size:16px;">ğŸ“œå†å²è®°å½•</h4>
        <div style="display:flex; gap:8px;">
    <button class="btn-mini-export" onclick="exportBudgetHistory()" style="background:#f0fdf4; color:#166534; border-color:#bbf7d0;">ğŸ“¤ å¯¼å‡ºå†å²</button>
    <button class="btn-mini-export" onclick="document.getElementById('historyCsvInput').click()" style="background:#f0f9ff; color:#0369a1; border-color:#bae6fd;">ğŸ“¥ å¯¼å…¥å†å²</button>
    <input type="file" id="historyCsvInput" accept=".csv" style="display:none;" onchange="importBudgetHistory(this)">

    <button class="btn-mini-export" onclick="clearBudgetHistory()" style="background:#fff1f2; color:#be123c; border-color:#fecdd3;">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
</div>

<div style="text-align: right; margin-top: 5px; padding-right: 10px;">
    <a href="javascript:void(0)" onclick="downloadBudgetHistoryTemplate()" style="font-size: 11px; color: var(--primary);">ä¸‹è½½å†å²å¯¼å…¥æ¨¡æ¿</a>
</div>
    </div>
    <div id="budgetHistoryList" style="max-height: 400px; overflow-y: auto;"></div>
</div>
</div>

<style>
    .input-group { display: flex; flex-direction: column; margin-bottom: 8px; }
    .input-group label { font-size: 11px; color: #64748b; margin-bottom: 3px; }
    .input-group input { padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 13px; }
    .input-group input:focus { border-color: var(--primary); outline: none; background: #f8fafc; }
</style>

<style>
    .input-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
    .input-group label { font-size: 12px; color: #64748b; font-weight: 500; }
    .input-group input { border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; font-size: 14px; transition: 0.2s; }
    .input-group input:focus { border-color: #f59e0b; outline: none; box-shadow: 0 0 0 3px rgba(245,158,11,0.1); }
</style>


    <div id="homePage" class="hidden">

        <br>

        <div class="card">
            <h4>ğŸ“‹ æ–°å¢/ç¼–è¾‘æ”¯æŒè®°å½•</h4>
            <form id="recordForm">
                <div class="grid-2">
                    <input type="text" id="date" placeholder="æ—¥æœŸ" required onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">

<input type="text" id="name" list="supNameList" placeholder="å§“åï¼ˆä¸é«˜æ˜ä¸€è‡´ï¼‰" required
       onmousedown="forceShowAllSupporterNames(this)"
       oninput="autoFillSupporterInfo()">
                </div>

                <div class="grid-2">
   <input type="text" id="method" list="methodList" placeholder="æ–¹å¼" onmousedown="forceShowAll(this)">
    <datalist id="methodList">
        <option value="é“¶è¡Œè½¬è´¦">
        <option value="å¾®ä¿¡">
        <option value="æ”¯ä»˜å®">
        <option value="ç°é‡‘">
    </datalist>

    <input type="text" id="gender" list="homeGenderList" placeholder="æ€§åˆ«" onmousedown="forceShowAll(this)">
    <datalist id="homeGenderList">
        <option value="ç”·">
        <option value="å¥³">
        <option value="å…¶ä»–">

    </datalist>
</div>

                <div class="grid-2">
                    <input type="text" id="frequency" list="freqList" placeholder="é¢‘ç‡" onmousedown="forceShowAll(this)" ondblclick="this.value='';" required>
                    <datalist id="freqList">
                        <option value="æŒ‰æœˆ"><option value="æŒ‰å¹´"><option value="ä¸å®šæœŸ">
                    </datalist>

                    <input type="text" id="remark" list="remarkList" placeholder="å¤‡æ³¨" onmousedown="forceShowAll(this)">
                    <datalist id="remarkList">
                        <option value="æ—¥å¸¸"><option value="çŸ­å®£"><option value="å…¶ä»–">
                    </datalist>
                </div>

                <div class="grid-2">
                    <input type="text" id="area" list="areaList" placeholder="åœ°åŒº" required onmousedown="forceShowAll(this)">
                    <datalist id="areaList"></datalist>
                    <input type="number" id="amount" step="0.01" placeholder="é‡‘é¢" required>
                </div>

                <button type="submit" class="btn-primary">ä¿å­˜è®°å½•</button>
            </form>

            <div style="margin-top: 10px;">
                <button type="button" class="btn-outline" style="width: 100%; justify-content: center; border-style: dashed; color: #64748b;" onclick="toggleImportArea()">
                    ğŸ“¥ å±•å¼€/éšè—æ‰¹é‡å¯¼å…¥è®°å½• (CSV)
                </button>
            </div>

            <div id="batchImportWrapper" class="hidden" style="margin-top: 15px;">
                <div id="dropZone" class="import-area">
                    <p style="margin:0; font-size:14px; color:#475569; font-weight: bold;">ğŸ“„ ç‚¹å‡»é€‰æ‹© æˆ– æ‹–æ‹½ CSV æ–‡ä»¶è¿›è¡Œå¯¼å…¥</p>
                    <p style="margin:5px 0 0 0; font-size:11px; color:#94a3b8;">æ”¯æŒæ ¼å¼ï¼šæ—¥æœŸ, å§“å, åœ°åŒº, é‡‘é¢, é¢‘ç‡, å¤‡æ³¨</p>
                    <input type="file" id="fileInput" accept=".csv" style="display:none;">
                </div>
                <div style="text-align: right; margin-top: 5px;">
                    <a href="javascript:void(0)" onclick="downloadTemplate(event)" style="font-size: 11px; color: var(--primary); text-decoration: underline;">
                        ä¸‹è½½ CSV å¯¼å…¥æ¨¡ç‰ˆ
                    </a>
                </div>
            </div>
        </div> <br>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                <h4 style="margin:0">è®°å½•ç®¡ç† <span id="recordCount" style="font-size:12px; color:#64748b; font-weight:normal;"></span></h4>
            </div>

            <div class="table-container">
                <table>
                    <thead>
    <tr>
        <th>æ—¥æœŸ</th>
        <th>å§“å</th>
        <th>æ€§åˆ«</th> <th>æ–¹å¼</th> <th>åœ°åŒº</th>
        <th>é‡‘é¢</th>
        <th>é¢‘ç‡</th> <th>å¤‡æ³¨</th> <th style="text-align:center">æ“ä½œ</th>
    </tr>
</thead>
                    <tbody id="recordBody"></tbody>
                </table>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;">
                <button class="btn-mini-export" onclick="toggleShowAll()" id="btnShowAll">æ˜¾ç¤ºå…¨éƒ¨</button>
                <button class="btn-mini-export" onclick="exportToCSV()">ğŸ“¤ å¯¼å‡º CSV</button>
                <button class="btn-mini-export" onclick="exportToGaomingCSV()" style="background: #f0fdf4; color: #166534;">âœ¨ å¯¼å‡ºé«˜æ˜æ ¼å¼</button>
                <button class="btn-mini-export" onclick="clearAllData()" style="color:var(--danger);">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
            </div>
        </div> <button id="toAnalysis" class="btn-primary" style="background-color: #6366f1; margin-top: 10px;" onclick="showPage('analysis')">ğŸ“Š è´¢åŠ¡åˆ†æä¸­å¿ƒ</button>

    </div>

<div id="careLogPage" class="hidden">
 <div class="card">
    <h4>ğŸ“ æ–°å¢å…³æ€€è®°å½•</h4>
    <form id="careForm">
        <div class="grid-2" style="margin-bottom: 10px;">
            <input type="text" id="careDate" placeholder="æ—¥æœŸ" required
                   onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">
            <input type="text" id="careName" list="supNameList" placeholder="å§“å"
                   onmousedown="forceShowAllSupporterNames(this)" required>
        </div>

        <div style="margin-bottom: 10px;">
            <select id="careType">
                <option value="å¸¸è§„é—®å€™">å¸¸è§„é—®å€™</option>
                <option value="ä»£ç¥·è·Ÿè¿›ğŸ™">ä»£ç¥·è·Ÿè¿›</option>
                <option value="èŠ‚æ—¥ç¥ç¦">èŠ‚æ—¥ç¥ç¦</option>
                <option value="è§é¢æ²Ÿé€šğŸ€">è§é¢æ²Ÿé€š</option>
                <option value="è´¢åŠ¡æ„Ÿè°¢">è´¢åŠ¡æ„Ÿè°¢</option>
            </select>
        </div>

        <textarea id="careContent" placeholder="è®°å½•å…³æ€€ç»†èŠ‚..."></textarea>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
            <button type="submit" class="btn-primary" style="background:#8b5cf6; height: 42px; margin:0;">
                <span style="display:flex; flex-direction:column; align-items:center;">
                    <span>ğŸ’¾ ä¿å­˜è®°å½•</span>
                </span>
            </button>
            <button type="button" class="btn-mini-export" onclick="clearAllCareLogs()"
                    style="background: #fff1f2; color: #be123c; border-color: #fecdd3; height: 42px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <span>ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</span>
            </button>

            <button type="button" class="btn-mini-export" onclick="exportCareLogsToCSV()" style="height:42px;">ğŸ“¤ å¯¼å‡º CSV</button>
            <button type="button" class="btn-mini-export" onclick="document.getElementById('careCsvInput').click()" style="height:42px;">ğŸ“¥ å¯¼å…¥ CSV</button>
        </div>
        <input type="file" id="careCsvInput" accept=".csv" style="display:none;" onchange="importCareLogsFromCSV(this)">
    </form>
</div>
<br>



<br>
<div class="card" style="border-top: 4px solid #8b5cf6;">
    <h4 style="margin: 0 0 15px 0; color: #1e293b;">ğŸ” æ—¥å¿—é«˜çº§ç­›é€‰</h4>
    <div style="display: flex; flex-direction: column; gap: 12px;">
        <div class="grid-2">
            <input type="text" id="filterCareName" list="supNameList" placeholder="æ”¯æŒè€…å§“å (å…¨éƒ¨)"
                   style="box-sizing: border-box;" oninput="filterCareLogs()" onmousedown="forceShowAllSupporterNames(this)">

            <select id="filterCareType" style="box-sizing: border-box;" onchange="filterCareLogs()">
                <option value="">å…¨éƒ¨å…³æ€€ç±»å‹</option>
                <option value="å¸¸è§„é—®å€™">å¸¸è§„é—®å€™</option>
                <option value="ä»£ç¥·è·Ÿè¿›ğŸ™">ä»£ç¥·è·Ÿè¿›</option>
                <option value="èŠ‚æ—¥ç¥ç¦">èŠ‚æ—¥ç¥ç¦</option>
                <option value="è§é¢æ²Ÿé€šğŸ€">è§é¢æ²Ÿé€š</option>
                <option value="è´¢åŠ¡æ„Ÿè°¢">è´¢åŠ¡æ„Ÿè°¢</option>
            </select>
        </div>

        <div class="grid-2">
            <input type="text" id="filterCareStart" placeholder="å¼€å§‹æ—¥æœŸ"
                   style="box-sizing: border-box;" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" onchange="filterCareLogs()">

            <input type="text" id="filterCareEnd" placeholder="ç»“æŸæ—¥æœŸ"
                   style="box-sizing: border-box;" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" onchange="filterCareLogs()">
        </div>

        <input type="text" id="filterCareKeyword" placeholder="å†…å®¹å…³é”®å­—æ£€ç´¢..."
               style="box-sizing: border-box;" oninput="filterCareLogs()">

<button class="btn-mini-export" onclick="resetCareFilters()"
                style="width: 100%; height: auto; min-height: 45px; padding: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; margin:0;">
            <span>é‡ç½®æ‰€æœ‰ç­›é€‰æ¡ä»¶</span>
            <span id="careFilterStat" style="font-size: 11px; opacity: 0.8; font-weight: normal;">
                (æ‰€æœ‰è®°å½• 0 æ¡)
            </span>
        </button>
    </div>
</div>

<div id="filterResultArea" class="hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 5px;">
        <h4 style="margin: 0; font-size: 14px; color: #64748b;">ğŸ¯ ç­›é€‰ç»“æœ <span id="filterMatchCount" style="color: var(--primary);">0</span></h4>
    </div>
    <div id="careGridContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; margin-bottom: 30px;">
        </div>
</div>

</div>




    <div id="analysisPage" class="hidden">
        <div class="card">
            <h4>ğŸ“ˆ å…¨å±€æ¦‚è§ˆ</h4>
            <div class="grid-2">
                <div class="stat-item"><h4>ä»Šå¹´ç´¯è®¡</h4><p id="totalYear">Â¥ 0.00</p></div>
                <div class="stat-item"><h4>æœ€åæ”¯æŒ</h4><p id="lastDetail">-</p></div>
            </div>
            <div class="chart-wrap"><canvas id="mainDoughnut"></canvas></div>
        </div>


<div class="card">
    <h4>ğŸ¯ ç­¹æ¬¾ç›®æ ‡åˆ†æ</h4>
 <div class="grid-2" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
    <div class="stat-item" style="border-left-color:var(--primary)">
        <h4>12æœˆå¹³å‡å¥‰çŒ®</h4>
        <p id="avgMonthlyAmt">Â¥ 0.00</p>
    </div>

    <div id="avgAchievementItem" class="stat-item" style="border-left-color: #cbd5e1;">
        <h4>å¹³å‡è¾¾æˆç‡</h4>
        <p id="avgAchievement">0%</p>
    </div>

    <div class="stat-item" style="border-left-color:var(--danger)">
        <h4>å¹³å‡æ¯æœˆç¼ºå£</h4>
        <p id="avgGap">Â¥ 0.00</p>
    </div>
</div>

    <div class="chart-wrap"><canvas id="monthlyGoalChart"></canvas></div>

    <div class="target-input-box">
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <label style="font-size:11px; font-weight:bold;">æœˆç­¹æ¬¾ç›®æ ‡: </label>
                    <input type="number" id="monthlyTargetInput" placeholder="è¾“å…¥é‡‘é¢" oninput="updateGoals()" style="width:90px; display:inline-block; padding:5px; margin-left:5px;">
                </div>
                <div style="text-align: right;">
                    <span style="font-size:11px; color:#64748b;">å¹´åº¦æ€»ç›®æ ‡: </span>
                    <b id="annualTargetDisplay" style="font-size:13px;">Â¥ 0.00</b>
                </div>
            </div>

            <div style="margin-top: 5px;">
                <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 5px; color:#1e293b;">
                    <span>å¹´åº¦ç­¹æ¬¾å®Œæˆè¿›åº¦</span>
                    <b id="annualProgressTextDisplay">0%</b>
                </div>
                <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                    <div id="annualProgressBar" style="width: 0%; height: 100%; background: #6366f1; transition: 0.6s cubic-bezier(0.4, 0, 0.2, 1);"></div>
                </div>
            </div>
        </div>
    </div>
</div>

        <div class="card">
            <h4>ğŸ“Š ç»´åº¦ç»Ÿè®¡å¯¹æ¯”</h4>
            <div class="grid-2">
                <select id="vDimension" onchange="handleDimensionChange()">
                    <option value="person">æŒ‰æ”¯æŒè€…æ’å</option>
                    <option value="city">æŒ‰åŸå¸‚åˆ†å¸ƒ</option>
                    <option value="time">æ—¶é—´è¶‹åŠ¿å›¾</option>
                </select>
                <select id="vRange" onchange="updateDimensionChart()">
                    <option value="12m">è¿‡å» 12 ä¸ªæœˆæ€»é¢</option>
                    <option value="year">ä»Šå¹´æ€»é¢</option>
                    <option id="optPersonAvg" value="personAvg">è¿‡å» 1 å¹´æœˆå‡å¯¹æ¯”</option>
                    <option id="opt5y" value="5y">è¿‡å»5å¹´æœˆå‡è¶‹åŠ¿</option>
                </select>
            </div>
            <div class="chart-wrap"><canvas id="vBarChart"></canvas></div>
        </div>

<div class="card">
    <h4>ğŸ¤ å…³ç³»ç»´æŠ¤çœ‹æ¿</h4>
    <div id="maintenancePanel">
        <div class="alert-box alert-warn">
            <strong>âš ï¸ éœ€å…³æ³¨ï¼ˆé€¾ 2 ä¸ªæœˆæœªæ”¯æŒï¼‰ï¼š</strong>
            <div id="dormantList" style="margin-top:5px;">è®¡ç®—ä¸­...</div>
        </div>
        <div class="alert-box alert-heart" style="margin-top:10px;">
            <strong>â¤ï¸ ç‰¹åˆ«è‡´è°¢ï¼ˆè¿‘ 6 ä¸ªæœˆæŒç»­æ”¯æŒï¼‰ï¼š</strong>
            <div id="loyalList" style="margin-top:5px;">è®¡ç®—ä¸­...</div>
        </div>
    </div>
</div>


        <div class="card">
            <h4>ğŸ‘¤ æ”¯æŒè®°å½•ç”»åƒ</h4>
            <div class="grid-2">
                <input type="text" id="pSearch" list="pSearchList" placeholder="æœç´¢å§“å..." oninput="analyzePerson()"
	onmousedown="forceShowAll(this)">
                <datalist id="pSearchList"></datalist>
               <select id="pRange" onchange="analyzePerson()">
    <option value="12m">è¿‡å» 12 ä¸ªæœˆè¶‹åŠ¿</option>
    <option value="monthly">å»å¹´æ¯æœˆæ˜ç»†</option>
    <option value="yearly">æŸ¥çœ‹æ¯å¹´æ€»é¢</option>
    <option value="yearlyAvg">è¿‡å»5å¹´æœˆå‡è¶‹åŠ¿</option>
</select>
<div id="pReminder" style="width:100%; margin-top:10px;"></div>
            </div>

<div id="pStats" style="display:none; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
    <div class="stat-item" style="border-left-color:var(--success)"><h4>ç´¯è®¡æ€»é¢</h4><p id="pTotalAmount">Â¥ 0.00</p></div>
    <div class="stat-item" style="border-left-color:#6366f1"><h4>æœ€è¿‘1ç¬”</h4><p id="pLastRecord">-</p></div>
    <div class="stat-item" style="border-left-color:var(--warn)"><h4>è®¾å®šæœˆæ‰¿è¯ºé¢</h4><p id="pMonthlyPromise">Â¥ 0.00</p></div>
    <div class="stat-item" style="border-left-color:#f59e0b"><h4>æœ¬å¹´åº¦æœˆå¹³å‡</h4><p id="pAvgYearly">Â¥ 0.00</p></div>
</div>


            <div class="chart-wrap"><canvas id="pBarChart"></canvas></div>
        </div>

       <div class="card">
    <h4>ğŸ’³ æ”¯ä»˜æ–¹å¼æ—¶é—´æ®µç»Ÿè®¡</h4>
    <div class="grid-2">
        <input type="date" id="mStart" onchange="calculateMethodStats()">
        <input type="date" id="mEnd" onchange="calculateMethodStats()">
    </div>

    <div id="methodStatsResult" style="margin-top: 15px;">
        <p style="text-align: center; color: #94a3b8; font-size: 13px;">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´ä»¥æŸ¥çœ‹ç»Ÿè®¡</p>
    </div>

    <div class="chart-wrap" style="height: 150px; margin-top: 10px;">
        <canvas id="methodDonutChart"></canvas>
    </div>
</div>
    </div>

</div>

<script>

Chart.register(ChartDataLabels);

let supporters = JSON.parse(localStorage.getItem('sup_members_v1')) || [];
let records = JSON.parse(localStorage.getItem('sup_v14')) || [];



window.addEventListener('storage', (e) => {
    if (e.key === 'sup_members_v1') {
        // ä»å­˜å‚¨åŠ è½½æœ€æ–°æ•°æ®
        supporters = JSON.parse(e.newValue) || [];
        // å®æ—¶åˆ·æ–°æ‰€æœ‰ç»„ä»¶
        renderSupporters();
        renderSupporterAnalysis();
    }
});

/**
 * å…¨ç³»ç»Ÿé€šç”¨ CSV è§£æå™¨
 * æ ¸å¿ƒé€»è¾‘ï¼šæ­£ç¡®å¤„ç†åŒå¼•å·åŒ…è£¹çš„å†…å®¹ï¼ˆå…è®¸å†…å®¹ä¸­åŒ…å«é€—å·ã€æ¢è¡Œå’Œè½¬ä¹‰åŒå¼•å· ""ï¼‰
 */
function robustCSVParser(text) {
    const rawText = text.replace(/^\ufeff/, '').trim();
    if (!rawText) return [];

    const rows = [];
    let currentRow = [];
    let currentCell = "";
    let inQuotes = false;

    for (let i = 0; i < rawText.length; i++) {
        const char = rawText[i];
        const nextChar = rawText[i + 1];

        if (char === '"') {
            if (inQuotes && nextChar === '"') {
                // å¤„ç†è½¬ä¹‰åŒå¼•å· "" -> "
                currentCell += '"';
                i++;
            } else {
                // åˆ‡æ¢å¼•å·çŠ¶æ€
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            // å•å…ƒæ ¼ç»“æŸ
            currentRow.push(currentCell.trim());
            currentCell = "";
        } else if ((char === '\r' || char === '\n') && !inQuotes) {
            // è¡Œç»“æŸ
            if (char === '\r' && nextChar === '\n') i++; // å¤„ç† CRLF
            currentRow.push(currentCell.trim());
            if (currentRow.length > 0) rows.push(currentRow);
            currentCell = "";
            currentRow = [];
        } else {
            currentCell += char;
        }
    }
    // æœ€åä¸€é¡¹å¤„ç†
    if (currentCell || currentRow.length > 0) {
        currentRow.push(currentCell.trim());
        rows.push(currentRow);
    }
    return rows;
}


//é¦–é¡µ

/**
 * åˆ‡æ¢ä½¿ç”¨é¡»çŸ¥å¼¹çª—æ˜¾éš
 * @param {boolean} show - æ˜¯å¦æ˜¾ç¤º
 */
function toggleUsageModal(show) {
    const modal = document.getElementById('usageModal');
    if (show) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // é”å®šèƒŒæ™¯æ»šåŠ¨
    } else {
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
    }
}


// --- æŒ‰é’®ç§»åŠ¨ä¸ç‚¹å‡»æ‹¦æˆªç³»ç»Ÿ ---

const floatContainer = document.getElementById('floatContainer');
let isDragging = false;
let startX, startY;
let initialX, initialY;
let moveDistance = 0; // å…¨å±€å£°æ˜ä½ç§»è®°å½•

function dragStart(e) {
    isDragging = true;
    moveDistance = 0; // æ¯æ¬¡æŒ‰ä¸‹é‡ç½®ä½ç§»
    
    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
    const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

    startX = clientX;
    startY = clientY;
    
    const rect = floatContainer.getBoundingClientRect();
    initialX = rect.left;
    initialY = rect.top;

    floatContainer.style.transition = 'none'; // ç§»åŠ¨æ—¶å…³é—­åŠ¨ç”»
}

function dragMove(e) {
    if (!isDragging) return;
    
    // åªæœ‰åœ¨éè¢«åŠ¨ç›‘å¬ä¸‹æ‰é˜»æ­¢é»˜è®¤è¡Œä¸º
    if (e.cancelable) e.preventDefault();

    const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
    const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

    const dx = clientX - startX;
    const dy = clientY - startY;

    // --- æ ¸å¿ƒä¿®æ­£ï¼šå®æ—¶è®¡ç®—ç§»åŠ¨è·ç¦» ---
    moveDistance = Math.sqrt(dx * dx + dy * dy);

    let newX = initialX + dx;
    let newY = initialY + dy;

    // è¾¹ç•Œæ£€æŸ¥
    const padding = 10;
    const bWidth = floatContainer.offsetWidth;
    const bHeight = floatContainer.offsetHeight;
    
    newX = Math.max(padding, Math.min(newX, window.innerWidth - bWidth - padding));
    newY = Math.max(padding, Math.min(newY, window.innerHeight - bHeight - padding));

    floatContainer.style.left = `${newX}px`;
    floatContainer.style.top = `${newY}px`;
    floatContainer.style.right = 'auto'; 
    floatContainer.style.bottom = 'auto';
}

function dragEnd() {
    isDragging = false;
    // æ¢å¤å¹³æ»‘åŠ¨ç”»ï¼ˆå¸¦ä¸€ç‚¹å¼¹æ€§æ•ˆæœï¼‰
    floatContainer.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; 
}

// ç»Ÿä¸€ç»‘å®šäº‹ä»¶
function initFloatBtn() {
    // é¼ æ ‡äº‹ä»¶
    floatContainer.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', dragMove);
    document.addEventListener('mouseup', dragEnd);

    // è§¦æ‘¸äº‹ä»¶
    floatContainer.addEventListener('touchstart', dragStart, { passive: false });
    document.addEventListener('touchmove', dragMove, { passive: false });
    document.addEventListener('touchend', dragEnd);

    // æ‹¦æˆªç‚¹å‡»ï¼šå¦‚æœåœ¨æ‹–æ‹½è¿‡ç¨‹ä¸­ä½ç§»è¶…è¿‡10pxï¼Œä¸æ‰§è¡ŒæŒ‰é’®æœ¬èº«çš„ onclick
    floatContainer.addEventListener('click', function(e) {
        if (moveDistance > 10) {
            e.stopImmediatePropagation();
            e.preventDefault();
        }
    }, true); 
}

initFloatBtn();

// ä¿®æ­£ Z-Index æ ·å¼
const styleFix = document.createElement('style');
styleFix.innerHTML = `
    .modal-overlay { z-index: 6000 !important; }
    .floating-container { z-index: 5500 !important; }
`;
document.head.appendChild(styleFix);


// æ‰“å¼€å¯¼èˆªèœå•
function openNavMenu() {
    const modal = document.getElementById('navMenuModal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
}

// å…³é—­å¯¼èˆªèœå•
function closeNavMenu() {
    const modal = document.getElementById('navMenuModal');
    modal.classList.add('hidden');
    document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
}

// ä¿®æ­£åçš„ç½®é¡¶å‡½æ•°
function scrollToTop() {
    window.scrollTo({top: 0, behavior: 'instant'});
    closeNavMenu();
}

// ä¿®æ­£åçš„ç½®åº•å‡½æ•°
function scrollToBottom() {
    window.scrollTo({top: document.documentElement.scrollHeight, behavior: 'instant'});
    closeNavMenu();
}

// ä¿®æ­£é¡µé¢è·³è½¬å‡½æ•°
function jumpTo(pageId) {
    showPage(pageId);
    closeNavMenu();
    window.scrollTo({ top: 0, behavior: 'instant' });
}


// ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶è‡ªåŠ¨æŠ˜å èœå•
document.addEventListener('click', function(e) {
    const container = document.getElementById('floatContainer');
    if (!container.contains(e.target) && container.classList.contains('active')) {
        toggleFloatMenu();
    }
});

/**
 * è·å–è®¾å¤‡å½“å‰çš„æ—¥æœŸå­—ç¬¦ä¸² (æ ¼å¼: YYYY-MM-DD)
 */
function getTodayStr() {
    return new Date().toISOString().slice(0, 10);
}

function updateAnaYearOptions() {
    const yearSelect = document.getElementById('anaYearSelect');
    if (!yearSelect) return;

    // è·å–æ‰€æœ‰æ”¯æŒè€…çš„å¼€å§‹å¹´ä»½
    const years = supporters.map(s => new Date(s.startDate.replace(/-/g, '/')).getFullYear());
    const uniqueYears = [...new Set(years)].sort((a, b) => b - a); // é™åºæ’

    // æ·»åŠ â€œå…¨éƒ¨å¹´åº¦â€å’Œå…·ä½“å¹´ä»½
    let html = '<option value="all">æŒ‰å¹´åº¦</option>';
    uniqueYears.forEach(y => {
        html += `<option value="${y}">${y} å¹´</option>`;
    });
    yearSelect.innerHTML = html;
}

//indexé¡µé¢

/**
 * æ ¸å¿ƒåŠŸèƒ½ï¼šä¸€é”®æ‰“åŒ…å¯¼å‡ºå…¨ç³»ç»Ÿå››ä¸ªæ ¸å¿ƒæ¨¡å—çš„æ•°æ®
 */
function exportFullSystemBackup() {
    console.log("å¼€å§‹å…¨ç³»ç»Ÿå¤‡ä»½...");
    const now = new Date().toISOString().slice(0, 10).replace(/-/g, '');

    // ä»»åŠ¡é˜Ÿåˆ—ï¼šå‡½æ•°å + æ–‡ä»¶ååç¼€
    const backupTasks = [
        { action: exportToCSV, name: "æ”¯æŒè®°å½•" },
        { action: exportToGaomingCSV, name: "æ”¯æŒè®°å½•é«˜æ˜ç‰ˆ" }, // æ–°å¢
        { action: exportSupportersToCSV, name: "æ”¯æŒè€…åå†Œ" },
        { action: exportBudgetHistory, name: "é¢„ç®—æ–¹æ¡ˆå†å²" },
        { action: exportCareLogsToCSV, name: "å…³æ€€æ—¥å¿—" }
    ];

    let successCount = 0;

    backupTasks.forEach((task, index) => {
        // ä½¿ç”¨ setTimeout é”™å¼€æ‰§è¡Œï¼Œé˜²æ­¢æµè§ˆå™¨æ‹¦æˆªå¤šæ–‡ä»¶ä¸‹è½½
        setTimeout(() => {
            try {
                task.action();
                successCount++;
                console.log(`å·²è§¦å‘ä¸‹è½½: ${task.name}`);

                // å½“æœ€åä¸€ä¸ªä»»åŠ¡å°è¯•å®Œæˆåå¼¹å‡ºæç¤º
                if (index === backupTasks.length - 1) {
                    alert("å…¨ç³»ç»Ÿå¤‡ä»½æŒ‡ä»¤å·²å…¨éƒ¨å‘å‡ºï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨çš„ä¸‹è½½åˆ—è¡¨ã€‚\n\nåŒ…å«ï¼šè®°å½•ã€åå†Œã€é¢„ç®—ã€æ—¥å¿—å…±5ä¸ªæ–‡ä»¶ã€‚");
                }
            } catch (err) {
                console.error(`${task.name} å¯¼å‡ºå¤±è´¥:`, err);
            }
        }, index * 800); // æ¯éš”0.8ç§’è§¦å‘ä¸€ä¸ªï¼Œç¨³å®šæ€§æœ€é«˜
    });
}


async function exportSystemToZip() {
    const password = prompt("è¯·è¾“å…¥åŠ å¯†å¯†ç ï¼ˆè§£å¯†å¯¼å…¥æ—¶å¿…é¡»ä½¿ç”¨ï¼‰ï¼š");
    if (!password) {
        alert("å¿…é¡»è®¾ç½®å¯†ç æ‰èƒ½å¯¼å‡º");
        return;
    }

    const btn = event.currentTarget;
    btn.innerText = "æ­£åœ¨æ‰“åŒ…åŠ å¯†...";
    btn.disabled = true;

    try {
        const zip = new JSZip();
        const now = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        
        const getEncryptedData = (type) => {
            let content = "";
            if (type === 'records') {
                content = "\ufeffæ—¥æœŸ,å§“å,æ€§åˆ«,æ–¹å¼,åœ°åŒº,é‡‘é¢,é¢‘ç‡,å¤‡æ³¨\n" + 
                          records.map(r => [r.date, r.name, r.gender, r.method, r.area, r.amount, r.frequency, r.remark].join(",")).join("\n");
            } else if (type === 'supporters') {
                content = "\ufeffå¼€å§‹æ—¥æœŸ,ç»“æŸæ—¥æœŸ,å§“å,æ€§åˆ«,åŸå¸‚,é¢‘ç‡,é‡‘é¢,å¤‡æ³¨\n" + 
                          supporters.map(s => [s.startDate, s.endDate, s.name, s.gender, s.city, s.freq, s.amount, s.remark].join(",")).join("\n");
            } else if (type === 'careLogs') {
                content = "\ufeffæ—¥æœŸ,æ”¯æŒè€…å§“å,å…³æ€€ç±»å‹,è®°å½•å†…å®¹\n" + 
                          careLogs.map(l => [l.date, l.name, l.type, `"${l.content.replace(/"/g, '""')}"`].join(",")).join("\n");
            } else if (type === 'budget') {
                // --- å¼ºåŒ–ï¼šç›´æ¥åºåˆ—åŒ– JSON å­—ç¬¦ä¸²ä»¥ä¿è¯ details å¯¹è±¡ç»“æ„ä¸ä¸¢å¤± ---
                const history = localStorage.getItem('budget_history_records') || '[]';
                content = history; 
            }
            return CryptoJS.AES.encrypt(content, password).toString();
        };

        zip.file("1_æ”¯æŒè®°å½•.txt", getEncryptedData('records'));
        zip.file("2_æ”¯æŒè€…åå†Œ.txt", getEncryptedData('supporters'));
        zip.file("3_å…³æ€€æ—¥å¿—.txt", getEncryptedData('careLogs'));
        zip.file("4_é¢„ç®—å†å².txt", getEncryptedData('budget')); // æ·»åŠ é¢„ç®—å†å²

        const content = await zip.generateAsync({type: "blob"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = `æ”¯æŒç³»ç»Ÿå…¨å¤‡ä»½_${now}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        alert("âœ… å¤‡ä»½å·²æˆåŠŸå¯¼å‡ºï¼åŒ…å«ï¼šè®°å½•ã€åå†Œã€æ—¥å¿—ã€é¢„ç®—å†å²ã€‚");
    } catch (err) {
        console.error(err);
        alert("âŒ å¤‡ä»½å¤±è´¥");
    } finally {
        btn.innerText = "ğŸ“¦ ä¸€é”®å¯¼å‡º ZIP å¤‡ä»½";
        btn.disabled = false;
    }
}


// å®Œæ•´ä¿®å¤ç‰ˆï¼šå¯¼å…¥åŠ å¯† ZIP å¹¶æ¢å¤æ•°æ®
async function importSystemFromZip(input) {
    const file = input.files[0];
    if (!file) return;

    const password = prompt("è¯·è¾“å…¥è¯¥ ZIP å¤‡ä»½çš„è§£å¯†å¯†ç ï¼š");
    if (!password) return;

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const zip = await JSZip.loadAsync(e.target.result);
            
            const getDecryptedText = async (fileObj) => {
                if (!fileObj) return null;
                const encryptedStr = await fileObj.async("string");
                const bytes = CryptoJS.AES.decrypt(encryptedStr, password);
                const decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                if (!decryptedText) throw new Error("å¯†ç é”™è¯¯");
                return decryptedText;
            };

            let modules = 0;


// 1. æ¢å¤æ”¯æŒè®°å½•
const t1 = await getDecryptedText(zip.file(/æ”¯æŒè®°å½•/)[0]);
if(t1) {
    const rows = robustCSVParser(t1); // æ›¿æ¢åŸæ¥çš„ split
    const data = rows.slice(1).map(c => ({
        date:c[0], name:c[1], gender:c[2], method:c[3], area:c[4], 
        amount:parseFloat(c[5])||0, frequency:c[6], remark:c[7], 
        ts: new Date(c[0].replace(/-/g,'/')).getTime()
    }));
    localStorage.setItem('sup_v14', JSON.stringify(data));
    modules++;
}

// 2. æ¢å¤æ”¯æŒè€…åå†Œ
const t2 = await getDecryptedText(zip.file(/æ”¯æŒè€…åå†Œ/)[0]);
if(t2) {
    const rows = robustCSVParser(t2); // æ›¿æ¢åŸæ¥çš„ split
    const data = rows.slice(1).map((c, i) => ({
        id:Date.now()+i, startDate:c[0], endDate:c[1], name:c[2], 
        gender:c[3], city:c[4], freq:c[5], amount:parseFloat(c[6])||0, remark:c[7]
    }));
    localStorage.setItem('sup_members_v1', JSON.stringify(data));
    modules++;
}

// 3. æ¢å¤å…³æ€€æ—¥å¿—
const t3 = await getDecryptedText(zip.file(/å…³æ€€æ—¥å¿—/)[0]);
if(t3) {
    const rows = robustCSVParser(t3); // æ›¿æ¢åŸæ¥çš„åŒ¹é…æ­£åˆ™
    const data = rows.slice(1).map((c, i) => ({
        id: Date.now() + i, date: c[0], name: c[1], type: c[2], content: c[3]
    }));
    localStorage.setItem('sup_care_logs_v1', JSON.stringify(data));
    modules++;
}
            // 4. ã€æ ¸å¿ƒé€»è¾‘ï¼šæ¢å¤é¢„ç®—å¹¶è‡ªåŠ¨ä¿å­˜æœ€æ–°ç›®æ ‡ã€‘
            const f4 = zip.file(/é¢„ç®—å†å²/)[0];
            const t4 = await getDecryptedText(f4);
            if(t4 && t4 !== "[]") {
                try {
                    const budgetData = JSON.parse(t4);
                    if (Array.isArray(budgetData)) {
                        localStorage.setItem('budget_history_records', JSON.stringify(budgetData));
                        
                        // --- è‡ªåŠ¨æå–æœ€æ–°çš„ä¸€æ¡è®°å½• ---
                        if (budgetData.length > 0) {
                            const latestPlan = budgetData[0]; // æ•°ç»„ç¬¬ä¸€é¡¹é€šå¸¸æ˜¯æœ€æ–°ä¿å­˜çš„
                            // æ¸…æ´—é‡‘é¢å­—ç¬¦ä¸²ï¼ˆå»æ‰ Â¥ å’Œ é€—å·ï¼‰ï¼Œè½¬ä¸ºæµ®ç‚¹æ•°
                            const goalValue = parseFloat(latestPlan.monthlyGoal.replace(/[^\d.]/g, '')) || 0;
                            
                            if (goalValue > 0) {
                                // åŒæ­¥åˆ°ç³»ç»Ÿæ ¸å¿ƒç›®æ ‡ Key
                                localStorage.setItem('sup_target', goalValue);
                                localStorage.setItem('sup_manual_goal', goalValue);
                                console.log("ç³»ç»Ÿå·²è‡ªåŠ¨åŒæ­¥æœ€æ–°æœˆç­¹æ¬¾ç›®æ ‡: Â¥" + goalValue);
                            }
                        }
                        modules++;
                    }
                } catch(e) { console.error("é¢„ç®—è§£æå¤±è´¥:", e); }
            }

            if(modules > 0) {
                alert(`âœ… å¯¼å…¥æˆåŠŸï¼å…±æ¢å¤ ${modules} ä¸ªæ¨¡å—ã€‚\næœ€æ–°ç­¹æ¬¾ç›®æ ‡å·²è‡ªåŠ¨åŒæ­¥ã€‚é¡µé¢å³å°†åˆ·æ–°...`);
                window.location.reload();
            } else {
                alert("æœªå‘ç°æœ‰æ•ˆæ•°æ®ã€‚");
            }

        } catch (err) {
            alert("âŒ å¯¼å…¥å¤±è´¥ï¼šå¯†ç é”™è¯¯æˆ–æ–‡ä»¶æŸåã€‚");
        }
    };
    reader.readAsArrayBuffer(file);
}




/**
 * ç»ˆææ“ä½œï¼šä¸€é”®æ¸…ç©ºå…¨å±€æ‰€æœ‰ä¸šåŠ¡æ•°æ®
 */
function clearAllGlobalData() {
    // ç¬¬ä¸€é‡ç¡®è®¤
    const confirm1 = confirm("ã€è­¦å‘Šã€‘æ‚¨æ­£åœ¨æ‰§è¡Œå…¨å±€æ¸…ç©ºæ“ä½œï¼\n\nè¿™å°†æ°¸ä¹…åˆ é™¤ï¼š\n1. æ‰€æœ‰æ”¯æŒè®°å½•\n2. æ‰€æœ‰æ”¯æŒè€…æ¡£æ¡ˆ\n3. æ‰€æœ‰é¢„ç®—æ–¹æ¡ˆä¸å†å²\n4. æ‰€æœ‰å…³æ€€æ—¥å¿—\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ");

    if (confirm1) {
        // ç¬¬äºŒé‡ç¡®è®¤ï¼ˆé˜²æ­¢æ‰‹æŠ–ï¼‰
        const confirm2 = confirm("å†æ¬¡ç¡®è®¤ï¼šæ•°æ®ä¸€æ—¦åˆ é™¤å°†æ— æ³•æ¢å¤ï¼Œå»ºè®®æ‚¨å…ˆæ‰§è¡Œå„ä¸ªé¡µé¢çš„å¯¼å‡º CSV åŠŸèƒ½è¿›è¡Œå¤‡ä»½ã€‚\n\nçœŸçš„è¦æ¸…ç©ºå…¨éƒ¨æ•°æ®å—ï¼Ÿ");

        if (confirm2) {
            // 1. å®šä¹‰ç³»ç»Ÿä¸­ç”¨åˆ°çš„æ‰€æœ‰ Key
            const keys = [
                'sup_v14',                // æ”¯æŒè®°å½•
                'sup_members_v1',         // æ”¯æŒè€…æ¡£æ¡ˆ
                'budget_history_records', // é¢„ç®—æ–¹æ¡ˆ
                'sup_care_logs_v1',       // å…³æ€€æ—¥å¿—
                'sup_target',             // ç­¹æ¬¾ç›®æ ‡
                'sup_manual_goal'         // æ‰‹åŠ¨è®¾å®šçš„ç›®æ ‡
            ];

            // 2. æ‰§è¡Œåˆ é™¤
            keys.forEach(key => localStorage.removeItem(key));

            // 3. é‡ç½®å†…å­˜ä¸­çš„å˜é‡ï¼Œé˜²æ­¢é¡µé¢ä¸åˆ·æ–°çš„æƒ…å†µä¸‹ç»§ç»­æ“ä½œæ—§æ•°æ®
            records = [];
            supporters = [];
            careLogs = [];

            // 4. åé¦ˆå¹¶å¼ºåˆ¶åˆ·æ–°é¡µé¢ä»¥é‡ç½®æ‰€æœ‰ UI çŠ¶æ€
            alert("å…¨å±€æ•°æ®å·²å½»åº•æ¸…ç©ºã€‚ç³»ç»Ÿå°†é‡æ–°åŠ è½½ã€‚");
            window.location.reload();
        }
    }
}

//æ”¯æŒè®°å½•é¡µé¢
/**
 * ä¸“é—¨ä»â€œè®°å½•ç®¡ç†â€çš„å†å²æ•°æ®ä¸­æå–ä¿¡æ¯
 * @param {string} name - è¾“å…¥çš„å§“å
 * @returns {Object|null} - è¿”å›åŒ¹é…åˆ°çš„æœ€è¿‘ä¸€æ¡è®°å½•å¯¹è±¡
 */
function getInfoFromHistoryRecords(name) {
    // ç›´æ¥è¯»å–å­˜å‚¨ï¼Œç¡®ä¿æ•°æ®æœ€å®æ—¶
    const allRecords = JSON.parse(localStorage.getItem('sup_v14')) || [];

    // ç”±äºè®°å½•æ˜¯æŒ‰æ—¶é—´å€’åºæ’åˆ—çš„ï¼Œfind æ‰¾åˆ°çš„ç¬¬ä¸€æ¡å°±æ˜¯è¯¥å§“åæœ€æ–°çš„è®°å½•
    return allRecords.find(r => r.name === name) || null;
}

/**
 * è´Ÿè´£æ‰§è¡Œå¡«å……åŠ¨ä½œçš„ç‹¬ç«‹å‡½æ•°
 */
function autoFillSupporterProfileFromHistory() {
    const nameInput = document.getElementById('name');
    const name = nameInput.value.trim();

    if (!name) return;

    const lastData = getInfoFromHistoryRecords(name);

    if (lastData) {
        // å®šä¹‰æ”¯æŒè®°å½•é¡µé¢çš„ ID æ˜ å°„
        const fieldMapping = {
            'gender': lastData.gender,
            'method': lastData.method,
            'frequency': lastData.frequency,
            'remark': lastData.remark,
            'area': lastData.area,
            'amount': lastData.amount
        };

        // éå†å¹¶å¡«å……
        Object.keys(fieldMapping).forEach(id => {
            const el = document.getElementById(id);
            if (el && fieldMapping[id] !== undefined && fieldMapping[id] !== null) {
                el.value = fieldMapping[id];

                // è§†è§‰åé¦ˆï¼šæ”¯æŒè®°å½•ç³»ç»Ÿä¸“å±æ·¡ç´«è‰²é—ªçƒ
                el.style.transition = 'background 0.4s';
                el.style.backgroundColor = '#f5f3ff';
                setTimeout(() => { el.style.backgroundColor = 'white'; }, 800);
            }
        });
        console.log(`[æ”¯æŒè®°å½•ç³»ç»Ÿ] å·²ä»å†å²è®°å½•è‡ªåŠ¨å¡«å……: ${name}`);
    }
}





//æ”¯æŒè€…ç®¡ç†ç³»ç»Ÿé¡µé¢


/**
 * åœ¨æ”¯æŒè€…ç®¡ç†é¡µé¢ï¼šè¾“å…¥å§“ååè‡ªåŠ¨åŒ¹é…å†å²æ¡£æ¡ˆæˆ–è®°å½•å¹¶å¡«å……ï¼ˆåŒ…å«å¤‡æ³¨ï¼‰
 */
function autoFillSupporterProfile() {
    const nameInput = document.getElementById('supName');
    const name = nameInput.value.trim();

    if (!name) return;

    // 1. ä¼˜å…ˆæŸ¥æ‰¾ç°æœ‰æ¡£æ¡ˆ (ä» supporters æ•°ç»„)
    let profile = supporters.find(s => s.name === name);

    // 2. å¦‚æœæ¡£æ¡ˆé‡Œæ²¡æœ‰ï¼Œå°è¯•ä»å†å²è®°å½•é‡Œæ‰¾æœ€è¿‘çš„ä¸€æ¬¡ (ä» records æ•°ç»„)
    if (!profile) {
        // records å·²ç»æŒ‰æ—¶é—´æ’å¥½åºï¼Œfind æ‰¾åˆ°çš„å°±æ˜¯æœ€æ–°çš„
        const lastRec = records.find(r => r.name === name);
        if (lastRec) {
            profile = {
                gender: lastRec.gender || '',
                city: lastRec.area || '',      // è®°å½•é‡Œçš„ area æ˜ å°„åˆ°åå†Œçš„ city
                freq: lastRec.frequency || '',
                amount: lastRec.amount || '',
                remark: lastRec.remark || ''   // è·å–è®°å½•å¤‡æ³¨
            };
        }
    }

    // 3. æ‰§è¡Œå¡«å……é€»è¾‘
    if (profile) {
        // å»ºç«‹ ID æ˜ å°„å…³ç³»
        const fields = {
            'supGender': profile.gender || '',
            'supCity': (profile.city || profile.area) || '',
            'supFreq': (profile.freq || profile.frequency) || '',
            'supAmount': profile.amount || '',
            'supRemark': profile.remark || ''  // --- æ–°å¢ï¼šå¤‡æ³¨è‡ªåŠ¨å¡«å…… ---
        };

        for (let id in fields) {
            const el = document.getElementById(id);
            // å¡«å……é€»è¾‘ï¼šå¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œåˆ™è‡ªåŠ¨è¡¥å…¥
            if (el && fields[id] !== undefined && fields[id] !== '') {
                el.value = fields[id];

                // è§†è§‰åé¦ˆï¼šèƒŒæ™¯é—ªçƒç»¿è‰²æç¤º
                el.style.transition = 'background 0.5s';
                el.style.backgroundColor = '#f0fdf4';
                setTimeout(() => { el.style.backgroundColor = 'white'; }, 600);
            }
        }
    }
}
/**
 * é¢„ç®—ç®¡ç†ç³»ç»Ÿæ ¸å¿ƒ JS
 */

const BUDGET_PRESETS = {
    b_food: 1300, b_growth: 50, b_traffic: 100, b_phone: 50, b_daily: 50,
    b_fun: 50, b_gift: 50, b_cloth: 100, b_rent: 2700, b_util: 300,
    b_tithing: 1000, b_parents: 1000, b_saving: 1000, b_emergency: 100,
    b_public: 100, b_child: 0, b_social: 1360, b_insure: 540,
    b_visa: 300, b_travel: 8000, b_study: 2000, b_mission: 5000,
    b_admin: 5600, b_vpn: 650, b_mpd: 1000, b_home: 1000
};

// 1. åˆå§‹åŒ–
if (document.getElementById('budgetDate')) {
    document.getElementById('budgetDate').value = new Date().toISOString().slice(0, 10);
}

// å½“é¡µé¢åŠ è½½å®Œæˆæ—¶æ‰§è¡Œ
document.addEventListener('DOMContentLoaded', () => {
    // 1. åˆå§‹åŒ–æ¸²æŸ“ä¾§è¾¹æ æˆ–ä¸»åˆ—è¡¨
    if (typeof renderCareLogs === 'function') {
        renderCareLogs();
    }

    // 2. æ ¸å¿ƒï¼šè‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ç­›é€‰ï¼Œä»¥æ˜¾ç¤ºâ€œæœ€æ–°2æ¡â€
    if (typeof filterCareLogs === 'function') {
        filterCareLogs();
    }
});

// 2. è½½å…¥é¢„è®¾
function loadBudgetPresets() {
    if(confirm("åŠ è½½é¢„è®¾å‚è€ƒå€¼ï¼Ÿ")) {
        Object.keys(BUDGET_PRESETS).forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = BUDGET_PRESETS[id];
        });
        calculateBudget();
    }
}

// 3. æ¸…ç©º
function clearBudgetInputs() {
    if(confirm("æ¸…ç©ºæ‰€æœ‰è¾“å…¥ï¼Ÿ")) {
        document.querySelectorAll('#budgetPage input[type="number"]').forEach(el => el.value = '');
        calculateBudget();
    }
}

// 4. å®æ—¶è®¡ç®—
function calculateBudget() {
    // 1. åˆ†ç±»åˆè®¡å˜é‡
    let salaryMonthlySum = 0;   // å·¥èµ„ç±»æœˆè®¡
    let reimMonthlySum = 0;     // æŠ¥é”€ç±»æœˆè®¡
    let reimAnnualOnlySum = 0;  // æŠ¥é”€ç±»å¹´åº¦é¡¹åˆè®¡

    // è®¡ç®—å·¥èµ„éƒ¨åˆ†
    document.querySelectorAll('.calc-salary').forEach(input => {
        salaryMonthlySum += parseFloat(input.value) || 0;
    });

    // è®¡ç®—æŠ¥é”€-æœˆåº¦å›ºå®šéƒ¨åˆ†
    document.querySelectorAll('.calc-reim-m').forEach(input => {
        reimMonthlySum += parseFloat(input.value) || 0;
    });

    // è®¡ç®—æŠ¥é”€-å¹´åº¦å•æ¬¡éƒ¨åˆ†
    document.querySelectorAll('.calc-reim-y').forEach(input => {
        reimAnnualOnlySum += parseFloat(input.value) || 0;
    });

    // 2. æ±‡æ€»è®¡ç®—
    const totalSalaryAnnual = salaryMonthlySum * 12;
    const totalReimAnnual = (reimMonthlySum * 12) + reimAnnualOnlySum;
    const totalAnnualCombined = totalSalaryAnnual + totalReimAnnual;
    const avgMonthlyGoal = totalAnnualCombined / 12;

    // 3. è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ•°å€¼åˆ°ä¸ªä½å¹¶å¸¦åƒåˆ†ä½
    const formatToUnit = (num) => {
        return Math.round(num).toLocaleString('zh-CN');
    };

    // 4. å®æ—¶æ›´æ–°ç•Œé¢ UI æ˜¾ç¤º
    // å¡ç‰‡å†…å°è®¡ (é¡¶éƒ¨é»„è‰²/ç»¿è‰²å¡ç‰‡)
    const salaryTotalEl = document.getElementById('salary_m_total');
    const reimTotalEl = document.getElementById('reim_y_total');
    if (salaryTotalEl) salaryTotalEl.innerText = `Â¥ ${formatToUnit(salaryMonthlySum)}`;
    if (reimTotalEl) reimTotalEl.innerText = `Â¥ ${formatToUnit(totalReimAnnual)}`;

    // æ±‡æ€»å¡ç‰‡æ˜ç»† (ç™½è‰²ç»ˆè¡¨)
    const finalSalY = document.getElementById('final_salary_y');
    const finalReimY = document.getElementById('final_reim_y');
    const finalAnnual = document.getElementById('final_annual_total');
    const finalMonthly = document.getElementById('final_monthly_avg');

    if (finalSalY) finalSalY.innerText = `Â¥ ${formatToUnit(totalSalaryAnnual)}`;
    if (finalReimY) finalReimY.innerText = `Â¥ ${formatToUnit(totalReimAnnual)}`;
    if (finalAnnual) finalAnnual.innerText = `Â¥ ${formatToUnit(totalAnnualCombined)}`;
    if (finalMonthly) finalMonthly.innerText = `Â¥ ${formatToUnit(avgMonthlyGoal)}`;

    return avgMonthlyGoal;
}
// 5. ä¿å­˜è®°å½•ï¼ˆå«å†å²åˆ—è¡¨ï¼‰
function saveBudget() {
    const avg = calculateBudget();
    const roundedAvg = Math.ceil(avg);
    const date = document.getElementById('budgetDate').value;

    // ä¿å­˜æ˜ç»†ç”¨äºåˆ—è¡¨å±•ç¤º
    const details = {};
    document.querySelectorAll('#budgetPage input[type="number"]').forEach(el => details[el.id] = el.value);

    const history = JSON.parse(localStorage.getItem('budget_history_records') || '[]');
    history.unshift({
        id: Date.now(),
        date: date,
        monthlyGoal: document.getElementById('final_monthly_avg').innerText,
        annualTotal: document.getElementById('final_annual_total').innerText,
        details: details
    });
    localStorage.setItem('budget_history_records', JSON.stringify(history));
    localStorage.setItem('sup_manual_goal', roundedAvg); // åŒæ­¥ç³»ç»Ÿç›®æ ‡
    localStorage.setItem('sup_target', roundedAvg);
   // 2. ã€å…³é”®ã€‘åŒæ­¥åˆ·æ–°ä¸¤ä¸ªé¡µé¢çš„è¾“å…¥æ¡†å€¼
    const anaInput = document.getElementById('monthlyTargetInput'); // è´¢åŠ¡åˆ†æé¡µè¾“å…¥æ¡†
    const manInput = document.getElementById('manualMonthlyTarget'); // ç”»åƒåˆ†æé¡µè¾“å…¥æ¡†

    if (anaInput) anaInput.value = roundedAvg;
    if (manInput) manInput.value = roundedAvg;

    // 3. å¼ºåˆ¶è§¦å‘é€»è¾‘é‡ç®—ï¼ˆå¦‚æœå‡½æ•°å·²åŠ è½½ï¼‰
    if (typeof updateGoals === 'function') updateGoals();
    if (typeof calculateGoalProgress === 'function') calculateGoalProgress();

    renderBudgetHistory();
    alert("æ–¹æ¡ˆå·²ä¿å­˜ï¼Œç­¹æ¬¾ç›®æ ‡å·²åŒæ­¥è‡³å…¨ç³»ç»Ÿï¼");
}

// 6. æ¸²æŸ“å†å²
function renderBudgetHistory() {
    const history = JSON.parse(localStorage.getItem('budget_history_records') || '[]');
    const container = document.getElementById('budgetHistoryList');
    if (!container) return;

    if (history.length === 0) {
        container.innerHTML = `<p style="text-align:center; color:#94a3b8; font-size:13px; padding:20px;">æš‚æ— å†å²è®°å½•</p>`;
        return;
    }

    // å†…éƒ¨æ•°å€¼å¤„ç†å‡½æ•°ï¼Œç¡®ä¿æ˜¾ç¤ºä¸ºæ•´æ•°
    const toIntStr = (str) => {
        const num = parseFloat(str.replace(/[^\d.-]/g, '')) || 0;
        return Math.round(num).toLocaleString('zh-CN');
    };

    container.innerHTML = history.map(item => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #f8fafc;">
            <div>
                <div style="font-weight:bold; font-size:14px; color:#1e293b;">${item.date} æ–¹æ¡ˆ</div>
                <div style="font-size:12px; color:#64748b; margin-top:4px;">
                    æœˆæ ‡: <span style="color:#2563eb; font-weight:500;">Â¥ ${toIntStr(item.monthlyGoal)}</span> |
                    å¹´æ€»: Â¥ ${toIntStr(item.annualTotal)}
                </div>
            </div>
            <div style="display:flex; gap:5px;">
                <button onclick="loadRecordToEdit(${item.id})" class="btn-mini-export" style="color:#3b82f6; border-color:#dbeafe;">ç¼–è¾‘</button>
                <button onclick="deleteBudgetRecord(${item.id})" class="btn-mini-export" style="color:#ef4444; border-color:#fee2e2;">åˆ é™¤</button>
            </div>
        </div>
    `).join('');
}

// 7. è½½å…¥ç¼–è¾‘
function loadRecordToEdit(id) {
    const history = JSON.parse(localStorage.getItem('budget_history_records') || '[]');
    const record = history.find(i => i.id === id);
    if (record && confirm("è½½å…¥æ­¤æ–¹æ¡ˆï¼Ÿ")) {
        document.getElementById('budgetDate').value = record.date;
        Object.keys(record.details).forEach(k => {
            const el = document.getElementById(k);
            if (el) el.value = record.details[k];
        });
        calculateBudget();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// 8. åˆ é™¤è®°å½•
function deleteBudgetRecord(id) {
    if (confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
        let history = JSON.parse(localStorage.getItem('budget_history_records') || '[]');
        history = history.filter(i => i.id !== id);
        localStorage.setItem('budget_history_records', JSON.stringify(history));
        renderBudgetHistory();
    }
}

/**
 * æ¸…ç©ºæ‰€æœ‰é¢„ç®—å†å²è®°å½•
 */
function clearBudgetHistory() {
    // åŒé‡ç¡®è®¤ï¼Œé˜²æ­¢è¯¯åˆ 
    if (confirm("âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é¢„ç®—å†å²æ–¹æ¡ˆå—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå»ºè®®æ“ä½œå‰å…ˆç‚¹å‡»â€œå¯¼å‡ºå†å²â€è¿›è¡Œå¤‡ä»½ã€‚")) {
        // 1. ä»æœ¬åœ°å­˜å‚¨ä¸­ç§»é™¤
        localStorage.removeItem('budget_history_records');

        // 2. é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆä¼šè‡ªåŠ¨æ˜¾ç¤ºâ€œæš‚æ— å†å²è®°å½•â€ï¼‰
        renderBudgetHistory();

        alert("å†å²è®°å½•å·²å…¨éƒ¨æ¸…ç©ºã€‚");
    }
}

/**
 * ä¸‹è½½é¢„ç®—å†å²è®°å½•å¯¼å…¥æ¨¡æ¿
 */
function downloadBudgetHistoryTemplate() {
    // 1. åŸºç¡€è¡¨å¤´ï¼šæ–¹æ¡ˆæ—¥æœŸ, å¹´åº¦æ€»é¢, æœˆç›®æ ‡
    const baseHeaders = ["æ–¹æ¡ˆæ—¥æœŸ", "å¹´åº¦æ€»é¢", "æœˆç›®æ ‡"];

    // 2. è·å–å½“å‰é¡µé¢æ‰€æœ‰çš„é¢„ç®—é¡¹ ID
    const detailKeys = [];
    const detailLabels = [];
    document.querySelectorAll('#budgetPage input[type="number"]').forEach(el => {
        // æå– label æ–‡å­—ï¼Œå»é™¤æ‹¬å·å†…å®¹
        const label = el.parentElement.querySelector('label') ?
                      el.parentElement.querySelector('label').innerText.split('(')[0].trim() :
                      el.id;
        detailKeys.push(el.id);
        detailLabels.push(label);
    });

    // 3. æ„å»º CSV å†…å®¹ (æ·»åŠ  \ufeff è§£å†³ Excel ä¹±ç )
    const csvHeader = "\ufeff" + baseHeaders.concat(detailLabels).join(",") + "\n";
    const exampleRow = ["2026-01-01", "120000", "10000"].concat(Array(detailKeys.length).fill("0")).join(",") + "\n";
    const csvContent = csvHeader + exampleRow;

    // 4. å…³é”®ï¼šé’ˆå¯¹ç§»åŠ¨ç«¯ Firefox ä¼˜åŒ– Blob é…ç½®
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    // 5. å…³é”®ï¼šåˆ›å»ºå¹¶æŒ‚è½½éšè—é“¾æ¥
    const link = document.createElement('a');
    link.href = url;
    link.download = "é¢„ç®—å†å²å¯¼å…¥æ¨¡æ¿.csv";
    link.style.display = 'none'; // ç¡®ä¿ä¸å½±å“å¸ƒå±€

    // å¿…é¡»æ·»åŠ åˆ° bodyï¼Œå¦åˆ™æ‰‹æœºæµè§ˆå™¨å¯èƒ½æ‹¦æˆªç‚¹å‡»
    document.body.appendChild(link);

    // 6. ä½¿ç”¨è½»å¾®å»¶è¿Ÿè§¦å‘ï¼Œæå‡æ‰‹æœºç«¯å…¼å®¹æ€§
    setTimeout(() => {
        try {
            link.click();
        } catch (e) {
            console.error("ä¸‹è½½è§¦å‘å¤±è´¥:", e);
        }

        // 7. å»¶æ—¶æ¸…ç† DOM
        setTimeout(() => {
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }, 100);
    }, 50);
}
/**
 * å¯¼å…¥é¢„ç®—å†å²è®°å½• CSV
 */
function importBudgetHistory(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const lines = e.target.result.split(/\r?\n/).filter(l => l.trim());
        if (lines.length <= 1) return alert("æ–‡ä»¶å†…æ— æ•°æ®");

        // å»ºç«‹ä¸­æ–‡ Label åˆ° ID çš„æ˜ å°„
        const labelToIdMap = {};
        document.querySelectorAll('#budgetPage input[type="number"]').forEach(el => {
            const label = el.parentElement.querySelector('label').innerText.split('(')[0].trim();
            labelToIdMap[label] = el.id;
        });

        const headers = lines[0].replace("\ufeff", "").split(',').map(h => h.trim());
        const history = JSON.parse(localStorage.getItem('budget_history_records') || '[]');
        let importCount = 0;

        for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',').map(c => c.trim());
            if (cols.length < 3) continue;

            const record = {
                id: Date.now() + i,
                date: cols[0] || new Date().toISOString().slice(0, 10),
                annualTotal: "Â¥ " + (parseFloat(cols[1]) || 0).toLocaleString(),
                monthlyGoal: "Â¥ " + (parseFloat(cols[2]) || 0).toLocaleString(),
                details: {}
            };

            // å¡«å……è¯¦ç»†é¢„ç®—é¡¹
            headers.forEach((header, index) => {
                const id = labelToIdMap[header];
                if (id) {
                    record.details[id] = cols[index] || "0";
                }
            });

            history.unshift(record);
            importCount++;
        }

        localStorage.setItem('budget_history_records', JSON.stringify(history));
        renderBudgetHistory();
        alert(`æˆåŠŸå¯¼å…¥ ${importCount} æ¡å†å²æ–¹æ¡ˆ`);
        input.value = ""; // æ¸…ç©º input
    };
    reader.readAsText(file, 'UTF-8');
}

/**
 * æ¸…ç©ºé¢„ç®—å†å²æ–¹æ¡ˆ
 */
function clearBudgetHistory() {
    if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é¢„ç®—å†å²æ–¹æ¡ˆå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
        localStorage.removeItem('budget_history_records');
        renderBudgetHistory();
    }
}

/**
 * å¯¼å‡ºæ‰€æœ‰é¢„ç®—å†å²è®°å½•åˆ° CSV
 */
function exportBudgetHistory() {
    const history = JSON.parse(localStorage.getItem('budget_history_records') || '[]');

    if (history.length === 0) {
        alert("æš‚æ— å†å²è®°å½•å¯å¯¼å‡º");
        return;
    }

    // 1. æå–æ‰€æœ‰å¯èƒ½çš„å­—æ®µåï¼ˆè¡¨å¤´ï¼‰
    // åŸºç¡€ä¿¡æ¯ + è¯¦æƒ…ä¸­çš„æ‰€æœ‰ key
    const baseHeaders = ["æ–¹æ¡ˆæ—¥æœŸ", "å¹´åº¦æ€»é¢", "æœˆç›®æ ‡"];
    const detailKeys = Object.keys(history[0].details); // å‡è®¾æ‰€æœ‰è®°å½•çš„é¡¹ç›®ä¸€è‡´

    // è·å–å¯¹åº”çš„ä¸­æ–‡ Label
    const keyToLabelMap = {};
    document.querySelectorAll('#budgetPage input[type="number"]').forEach(el => {
        const label = el.parentElement.querySelector('label') ? el.parentElement.querySelector('label').innerText.split('(')[0].trim() : el.id;
        keyToLabelMap[el.id] = label;
    });

    const csvHeader = "\ufeff" + baseHeaders.concat(detailKeys.map(k => keyToLabelMap[k] || k)).join(",");

    // 2. è½¬æ¢æ•°æ®è¡Œ
    const rows = history.map(item => {
        const baseData = [
            item.date,
            item.annualTotal.replace(/[^\d.-]/g, ''),
            item.monthlyGoal.replace(/[^\d.-]/g, '')
        ];

        const detailData = detailKeys.map(k => item.details[k] || 0);

        return baseData.concat(detailData).join(",");
    });

    const csvContent = csvHeader + "\n" + rows.join("\n");

    // 3. è§¦å‘ä¸‹è½½
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');

    a.href = url;
    a.download = `é¢„ç®—æ–¹æ¡ˆå†å²æ±‡æ€»_${dateStr}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}



// å®šä¹‰ä¸€ç»„ç¾è§‚ä¸”å¯¹æ¯”é²œæ˜çš„é¢œè‰²
const METHOD_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#8b5cf6', '#ec4899', '#94a3b8'];

// å…¨å±€å˜é‡ç”¨äºå­˜å‚¨åˆ†æå›¾è¡¨å®ä¾‹ï¼Œé˜²æ­¢é‡å¤æ¸²æŸ“å†²çª
let supCharts = {};


let currentSupViewMode = 'amount'; // 'count' æˆ– 'amount'

function renderCoreChart(labels, vals, isFiveYearTrend, isHorizontal) {
    const ctx = document.getElementById('vBarChart').getContext('2d');
    if (charts.v) charts.v.destroy();

    // åŸºç¡€æ•°æ®é›†
    const datasets = [{
        label: isFiveYearTrend ? 'å¹´åº¦æœˆå¹³å‡' : 'æ”¯æŒé‡‘é¢',
        data: vals,
        backgroundColor: isFiveYearTrend ? 'rgba(99, 102, 241, 0.2)' : getColors(vals),
        borderColor: isFiveYearTrend ? '#6366f1' : 'transparent',
        borderWidth: isFiveYearTrend ? 2 : 0,
        borderRadius: 6,
        order: 2
    }];

    // åªæœ‰åœ¨â€œæ—¶é—´è¶‹åŠ¿å›¾+è¿‡å»5å¹´â€æ—¶æ‰æ·»åŠ æŠ˜çº¿å±‚
    if (isFiveYearTrend) {
        datasets.push({
            label: 'å¢é•¿è¶‹åŠ¿',
            data: vals,
            type: 'line', // å¤åˆæŠ˜çº¿
            borderColor: '#f97316',
            backgroundColor: '#f97316',
            borderWidth: 2,
            pointRadius: 4,
            tension: 0.3,
            fill: false,
            order: 1
        });
    }

    charts.v = new Chart(ctx, {
        type: 'bar', // åŸºç¡€ç±»å‹ä¸ºæŸ±çŠ¶å›¾
        data: { labels, datasets },
        options: {
            ...chartBase,
            indexAxis: isHorizontal ? 'y' : 'x', // æ ¹æ®æ’åæˆ–è¶‹åŠ¿è‡ªåŠ¨åˆ‡æ¢æ¨ªçºµ
            plugins: {
                datalabels: { display: false }, // ç¦ç”¨æ­¤å›¾è¡¨çš„æ–‡å­—æ ‡ç­¾
                legend: { display: isFiveYearTrend }, // åªæœ‰è¶‹åŠ¿å›¾æ˜¾ç¤ºå›¾ä¾‹
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const val = isHorizontal ? context.parsed.x : context.parsed.y;
                            return ` Â¥${val.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 10 } }
                },
                y: {
                    grid: { display: !isHorizontal }, // æ’åæ¨¡å¼ï¼ˆæ¨ªå‘ï¼‰æ—¶ä¸æ˜¾ç¤ºYè½´ç½‘æ ¼
                    beginAtZero: true,
                    ticks: { font: { size: 10 } }
                }
            }
        }
    });
}

function autoFillSupporterInfo() {
    const nameInput = document.getElementById('name').value.trim();
    if (!nameInput) return;

    // ä» records æ•°ç»„ä¸­å¯»æ‰¾è¯¥æ”¯æŒè€…çš„æœ€è¿‘ä¸€æ¡å†å²è®°å½•
    // å› ä¸º records æ˜¯æŒ‰æ—¶é—´å€’åºæ’åˆ—çš„ï¼Œfind æ‰¾åˆ°çš„ç¬¬ä¸€æ¡å°±æ˜¯æœ€è¿‘çš„
    const lastRecord = records.find(r => r.name === nameInput);

    if (lastRecord) {
        // è‡ªåŠ¨å¡«å†™å„ä¸ªå­—æ®µ
        if (lastRecord.gender) document.getElementById('gender').value = lastRecord.gender;
        if (lastRecord.method) document.getElementById('method').value = lastRecord.method;
        if (lastRecord.frequency) document.getElementById('frequency').value = lastRecord.frequency;
        if (lastRecord.area) document.getElementById('area').value = lastRecord.area;
        if (lastRecord.remark) document.getElementById('remark').value = lastRecord.remark;
        // è§†è§‰æç¤ºï¼ˆå¯é€‰ï¼‰ï¼šå°†è¾¹æ¡†çŸ­æš‚å˜ç»¿ï¼Œæç¤ºç”¨æˆ·å·²è‡ªåŠ¨åŒ¹é…
        const fields = ['gender', 'method', 'frequency', 'area'];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.style.transition = '0.3s';
                el.style.backgroundColor = '#f0fdf4'; // æ·¡æ·¡çš„ç»¿è‰²èƒŒæ™¯
                setTimeout(() => el.style.backgroundColor = 'white', 500);
            }
        });
    }
}

function calculateMethodStats() {
    const start = document.getElementById('mStart').value;
    const end = document.getElementById('mEnd').value;
    const resultDiv = document.getElementById('methodStatsResult');

    if (!start || !end) return;

    const startTime = new Date(start.replace(/-/g, '/')).getTime();
    const endTime = new Date(end.replace(/-/g, '/')).getTime() + 86400000;

    const filtered = records.filter(r => r.ts >= startTime && r.ts < endTime);

    if (filtered.length === 0) {
        resultDiv.innerHTML = `<p style="text-align:center; color:var(--danger); padding:20px;">è¯¥æ—¶æ®µå†…æ— è®°å½•</p>`;
        if(charts.method) charts.method.destroy();
        return;
    }

    // æŒ‰æ–¹å¼èšåˆ
    const stats = filtered.reduce((obj, r) => {
        const m = r.method || "æœªå¡«å†™";
        obj[m] = (obj[m] || 0) + r.amount;
        return obj;
    }, {});

    const sortedStats = Object.entries(stats).sort((a, b) => b[1] - a[1]);
    const totalRangeAmount = filtered.reduce((s, r) => s + r.amount, 0);

    // ç”Ÿæˆè¿›åº¦æ¡ HTML
    let html = `<div style="background:#f8fafc; padding:12px; border-radius:8px;">
                    <div style="font-size:12px; color:#64748b; margin-bottom:12px;">
                        æ—¶æ®µæ€»è®¡ï¼š<b style="color:var(--text); font-size:14px;">Â¥ ${totalRangeAmount.toFixed(0)}</b>
                    </div>`;

   sortedStats.forEach(([method, amt], i) => {
        const percent = ((amt / totalRangeAmount) * 100).toFixed(1);
        const currentColor = METHOD_COLORS[i % METHOD_COLORS.length];

        html += `
            <div style="margin-bottom: 12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; font-size:13px;">
                    <span>${method}</span>
                    <span><b>Â¥ ${amt.toFixed(0)}</b></span>
                </div>
                <div style="width:100%; height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden;">
                    <div style="width:${percent}%; height:100%; background:${currentColor}; border-radius:3px; transition: width 0.6s ease;"></div>
                </div>
            </div>`;
    });
    html += `</div>`;
    resultDiv.innerHTML = html;

    // åŒæ­¥æ¸²æŸ“åœ†ç¯å›¾
// ä¿®æ­£åçš„ renderMethodChart å†…éƒ¨è°ƒç”¨é€»è¾‘
function renderMethodChart(sortedData) {
    const ctx = document.getElementById('methodDonutChart').getContext('2d');
    if (charts.method) charts.method.destroy();

    // å…³é”®ç‚¹ï¼šsortedData æ˜¯ [ [key, value], [key, value] ] æ ¼å¼
    const labels = sortedData.map(item => item[0]);
    const values = sortedData.map(item => item[1]);

    charts.method = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: METHOD_COLORS.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#ffffff'

            }]
        },
        options: {
                responsive: true,
                maintainAspectRatio: false,
             plugins: {
                // å¿…é¡»åœ¨ options.plugins æ ¹çº§åˆ«æ˜ç¡®ç¦ç”¨
                datalabels: {
                    display: false // å¼ºåˆ¶å…³é—­æ•°å­—æ ‡ç­¾
                },
                legend: {
                    display: true,
                    position: 'right',
                    labels: { boxWidth: 10, font: { size: 10 } }
                },
                tooltip: {
                    enabled: true // ä¿ç•™æ‚¬åœæç¤º
                }
            }
        }
    });
}

renderMethodChart(sortedStats);
}

// æ§åˆ¶é¦–é¡µæ‰¹é‡å¯¼å…¥åŒºåŸŸçš„æ˜¾ç¤ºä¸éšè—
function toggleImportArea() {
    const wrapper = document.getElementById('batchImportWrapper');
    wrapper.classList.toggle('hidden');
}
// åˆ‡æ¢æ”¯æŒè€…åå†Œå¯¼å…¥åŒºåŸŸ
function toggleSupImportArea() {
    const wrapper = document.getElementById('supImportWrapper');
    wrapper.classList.toggle('hidden');
}
// å»ºè®®ï¼šåœ¨ processFile å‡½æ•°æˆåŠŸå¯¼å…¥åï¼Œè‡ªåŠ¨éšè—è¯¥åŒºåŸŸ
// æ‰¾åˆ°åŸæœ¬çš„ processFile å‡½æ•°ï¼Œåœ¨ alert(`å¯¼å…¥æˆåŠŸ...`) åé¢åŠ ä¸Šï¼š
// document.getElementById('batchImportWrapper').classList.add('hidden');

function switchSupAnalysisView(mode) {
    currentSupViewMode = mode;
    // åˆ‡æ¢æŒ‰é’®æ ·å¼
    const btnCount = document.getElementById('btnViewCount');
    const btnAmt = document.getElementById('btnViewAmount');

    if (mode === 'count') {
        btnCount.className = 'btn-indigo';
        btnAmt.className = 'btn-outline';
        btnAmt.style.border = 'none';
    } else {
        btnCount.className = 'btn-outline';
        btnCount.style.border = 'none';
        btnAmt.className = 'btn-indigo';
    }

    // é‡æ–°æ¸²æŸ“
    renderSupporterAnalysis();
}

/**
 * ä¿®å¤ç‰ˆï¼šè®¡ç®—å¹¶æ›´æ–°æœˆç­¹æ¬¾è¿›åº¦ä¸å·®é¢
 */
function calculateGoalProgress() {
    // 1. æ ¸å¿ƒä¿®å¤ï¼šç›´æ¥ä»æ”¯æŒè€…æ•°ç»„ä¸­å®æ—¶è®¡ç®—æ´»è·ƒæ‰¿è¯ºæ€»é¢ï¼Œä¸ä¾èµ–é¡µé¢å…ƒç´ çš„æ–‡æœ¬
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const totalActiveAmount = supporters.reduce((sum, s) => {
        // åˆ¤æ–­æ”¯æŒè€…æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…
        const start = new Date(s.startDate.replace(/-/g, '/'));
        const end = s.endDate ? new Date(s.endDate.replace(/-/g, '/')) : null;
        const isActive = start <= today && (!end || end >= today);

        if (isActive) {
            let amt = parseFloat(s.amount) || 0;
            // æ¢ç®—ä¸ºæœˆé¢ï¼šæŒ‰å¹´æ”¯æŒçš„é™¤ä»¥12
            let m_amt = s.freq === 'æŒ‰å¹´' ? amt / 12 : (s.freq === 'æŒ‰æœˆ' ? amt : 0);
            return sum + m_amt;
        }
        return sum;
    }, 0);

    // 2. è·å–æ‰‹åŠ¨è¾“å…¥çš„ç›®æ ‡
    const targetInput = document.getElementById('manualMonthlyTarget');
    if (!targetInput) return;

    // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨æ¢å¤
    if (!targetInput.value) {
        const savedGoal = localStorage.getItem('sup_manual_goal');
        if (savedGoal) targetInput.value = savedGoal;
    }

    const targetAmount = parseFloat(targetInput.value) || 0;

    // ä¿å­˜ç›®æ ‡åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('sup_manual_goal', targetAmount);

    const gapEl = document.getElementById('anaGoalGap');
    const gapItem = document.getElementById('goalGapItem');
    const barEl = document.getElementById('anaProgressBar');
    const percentEl = document.getElementById('anaProgressPercent');

    if (targetAmount <= 0) {
        if (gapEl) gapEl.innerText = "æœªè®¾å®šç›®æ ‡";
        if (gapItem) gapItem.style.borderLeftColor = "#cbd5e1";
        if (barEl) barEl.style.width = "0%";
        if (percentEl) percentEl.innerText = "0%";
        return;
    }

    // 3. è®¡ç®—å·®é¢ (ç›®æ ‡ - å®é™…)
    const gap = targetAmount - totalActiveAmount;

    // ä½¿ç”¨ Math.abs(Math.round(gap)) ç¡®ä¿æ˜¾ç¤ºçš„æ˜¯å››èˆäº”å…¥åçš„æ•´æ•°ä¸ªä½
    const gapFormatted = Math.abs(Math.round(gap)).toLocaleString();

    if (gap <= 0) {
        gapEl.innerText = "å·²è¾¾æ ‡ (ç›ˆä½™ Â¥" + gapFormatted + ")";
        gapItem.style.borderLeftColor = "var(--success)";
        gapEl.style.color = "var(--success)";
    } else {
        gapEl.innerText = "Â¥" + gapFormatted;
        gapItem.style.borderLeftColor = "var(--danger)";
        gapEl.style.color = "var(--danger)";
    }

    // 4. è®¡ç®—ç™¾åˆ†æ¯”å¹¶æ›´æ–°è¿›åº¦æ¡
    let percent = Math.round((totalActiveAmount / targetAmount) * 100);
    percentEl.innerText = percent + "%";
    barEl.style.width = Math.min(percent, 100) + "%";
    barEl.style.background = percent >= 100 ? "#059669" : "var(--success)";
}



/**
 * å®Œæ•´ç‰ˆï¼šæ”¯æŒè€…ç¾¤ä½“ç”»åƒåˆ†æå‡½æ•°
 * é€»è¾‘ï¼šä»…ç»Ÿè®¡â€œæ”¯æŒä¸­â€çš„æ¡£æ¡ˆï¼Œé‡‘é¢ä¸å«å·²ç»“æŸæ•°æ®
 */
function renderSupporterAnalysis() {
    const yearFilter = document.getElementById('anaYearSelect').value;
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // 1. åŸºç¡€è¿‡æ»¤ï¼šé¦–å…ˆè¿‡æ»¤å‡ºåœ¨è¯¥å¹´ä»½â€œæ´»è·ƒâ€çš„æ”¯æŒè€…
    let filteredSupporters = supporters.filter(s => {
        const start = new Date(s.startDate.replace(/-/g, '/'));
        const end = s.endDate ? new Date(s.endDate.replace(/-/g, '/')) : null;

        if (yearFilter === 'all') {
            // åŸæœ‰é€»è¾‘ï¼šå½“å‰ä»æœ‰æ•ˆçš„
            return !end || end >= today;
        } else {
            // å¹´ä»½é€»è¾‘ï¼šæ”¯æŒè€…åœ¨è¯¥å¹´ä»½å†…è‡³å°‘æœ‰ä¸€æ®µå¤„äºæ”¯æŒçŠ¶æ€
            const targetYear = parseInt(yearFilter);
            const yearStart = new Date(targetYear, 0, 1);
            const yearEnd = new Date(targetYear, 11, 31);

            // åˆ¤æ–­æ—¶é—´æ®µæ˜¯å¦æœ‰é‡å ï¼š[start, end] å’Œ [yearStart, yearEnd]
            const supportEnd = end || new Date(2099, 11, 31); // å¦‚æœæ²¡å†™ç»“æŸæ—¥æœŸï¼Œè§†ä¸ºæ°¸ä¹…
            return start <= yearEnd && supportEnd >= yearStart;
        }
    });

    // 2. æ›´æ–°é¡¶éƒ¨çœ‹æ¿æ•°æ®
    const countEl = document.getElementById('anaTotalCount');
    const promiseEl = document.getElementById('anaTotalPromise');

    // è®¡ç®—æœˆæ‰¿è¯ºæ€»é¢ï¼ˆæŒ‰é‡‘é¢æ¨¡å¼ï¼‰
    const totalAmt = filteredSupporters.reduce((sum, s) => {
        let amt = parseFloat(s.amount) || 0;
        return sum + (s.freq === 'æŒ‰æœˆ' ? amt : (s.freq === 'æŒ‰å¹´' ? amt / 12 : 0));
    }, 0);

    countEl.innerText = `${filteredSupporters.length} ä½ (${yearFilter === 'all' ? 'æ”¯æŒä¸­' : yearFilter + 'å¹´åº¦'})`;
    promiseEl.innerText = `Â¥ ${totalAmt.toLocaleString(undefined, {maximumFractionDigits: 0})}`;

    // 3. è¿™é‡Œçš„èšåˆå‡½æ•°ä¹Ÿå¿…é¡»åŸºäºè¿‡æ»¤åçš„ filteredSupporters è¿è¡Œ
    // ç¡®ä¿ä½ å‡½æ•°å†…éƒ¨çš„èšåˆé€»è¾‘ä½¿ç”¨çš„æ˜¯ filteredSupporters è€Œä¸æ˜¯åŸå§‹çš„ activeSupporters
    const aggregate = (key) => {
        return filteredSupporters.reduce((obj, s) => {
            let label = s[key] || 'æœªçŸ¥';
            if (currentSupViewMode === 'count') {
                obj[label] = (obj[label] || 0) + 1;
            } else {
                let amt = parseFloat(s.amount) || 0;
                let m_amt = s.freq === 'æŒ‰å¹´' ? amt / 12 : (s.freq === 'æŒ‰æœˆ' ? amt : 0);
                obj[label] = (obj[label] || 0) + m_amt;
            }
            return obj;
        }, {});
    };

    // åˆ·æ–°æ‰€æœ‰å›¾è¡¨
    renderPie('chartGender', aggregate('gender'), ['#fb923c', '#93c5fd', '#cbd5e1'], true);
    renderPie('chartFreq', aggregate('freq'), ['#6366f1', '#10b981', '#f59e0b'], true);
    renderCityBar('chartCity', aggregate('city'));

    // å¦‚æœæœ‰æ’åå›¾ï¼Œä¹Ÿæ›´æ–°
    const supRankData = filteredSupporters.reduce((obj, s) => {
        let amt = parseFloat(s.amount) || 0;
        let m_amt = s.freq === 'æŒ‰æœˆ' ? amt : (s.freq === 'æŒ‰å¹´' ? amt / 12 : 0);
        if (m_amt > 0) obj[s.name] = (obj[s.name] || 0) + m_amt;
        return obj;
    }, {});
    if (typeof renderSupRankBar === 'function') renderSupRankBar('chartSupRank', supRankData);

    // è¿›åº¦è®¡ç®—
    calculateGoalProgress();

    // æ—­æ—¥å›¾æ‡’åŠ è½½å¤„ç†
    if (document.getElementById('sunburstContent') && !document.getElementById('sunburstContent').classList.contains('hidden')) {
        renderSunburstChart(filteredSupporters); // ä¼ é€’è¿‡æ»¤åçš„æ•°æ®
    }

// åœ¨ renderSupporterAnalysis å‡½æ•°çš„æœ«å°¾æ·»åŠ ï¼š
const sunburstContent = document.getElementById('sunburstContent');
if (sunburstContent && !sunburstContent.classList.contains('hidden')) {
    // ä¼ å…¥å½“å‰å¹´ä»½è¿‡æ»¤åçš„ filteredSupporters
    renderSunburstChart(filteredSupporters);
} else {
    // å¦‚æœæ˜¯éšè—çš„ï¼Œé‡ç½®åˆå§‹åŒ–æ ‡è®°ï¼Œç¡®ä¿ä¸‹æ¬¡æ‰“å¼€æ—¶åŠ è½½çš„æ˜¯æ–°æ•°æ®
    sunburstInitialized = false;
}

}
let sunburstInitialized = false; // æ ‡è®°æ˜¯å¦å·²åˆå§‹åŒ–ç»˜å›¾

function toggleSunburst() {
    const placeholder = document.getElementById('sunburstPlaceholder');
    const content = document.getElementById('sunburstContent');

    if (content.classList.contains('hidden')) {
        placeholder.classList.add('hidden');
        content.classList.remove('hidden');

        // è·å–å½“å‰å¹´ä»½è¿‡æ»¤åçš„æ•°æ®ï¼ˆå¤ç”¨è¿‡æ»¤é€»è¾‘ï¼‰
        const yearFilter = document.getElementById('anaYearSelect').value;
        const today = new Date();
        today.setHours(0,0,0,0);

        const filtered = supporters.filter(s => {
            const start = new Date(s.startDate.replace(/-/g, '/'));
            const end = s.endDate ? new Date(s.endDate.replace(/-/g, '/')) : null;
            if (yearFilter === 'all') return !end || end >= today;
            const targetYear = parseInt(yearFilter);
            const yearEnd = new Date(targetYear, 11, 31);
            const supportEnd = end || new Date(2099, 11, 31);
            return start <= yearEnd && supportEnd >= new Date(targetYear, 0, 1);
        });

        setTimeout(() => {
            renderSunburstChart(filtered);
            sunburstInitialized = true;
        }, 150);
    } else {
        placeholder.classList.remove('hidden');
        content.classList.add('hidden');
    }
}
/**
 * æ¸²æŸ“æ—­æ—¥å›¾ - æ”¯æŒå¹´ä»½è¿‡æ»¤å’Œæ¨¡å¼åˆ‡æ¢
 * @param {Array} dataList - ç»è¿‡å¹´ä»½è¿‡æ»¤åçš„æ”¯æŒè€…æ•°ç»„
 */

function renderSunburstChart(dataList) {
    if (!dataList || dataList.length === 0) return;

    const canvas = document.getElementById('chartSunburst');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (supCharts['sunburst']) supCharts['sunburst'].destroy();

    // --- 1. æ•°æ®èšåˆ ---
    const cityMap = {};
    dataList.forEach(s => {
        const city = s.city || "æœªçŸ¥åŸå¸‚";
        let val = 0;
        if (currentSupViewMode === 'amount') {
            let amt = parseFloat(s.amount) || 0;
            val = s.freq === 'æŒ‰å¹´' ? amt / 12 : (s.freq === 'æŒ‰æœˆ' ? amt : 0);
        } else {
            val = 1;
        }

        if (val > 0) {
            if (!cityMap[city]) cityMap[city] = { total: 0, members: [] };
            cityMap[city].total += val;
            cityMap[city].members.push({ name: s.name, value: val });
        }
    });

    // --- 2. æ„å»ºä¸¤ä¸ªå±‚çº§çš„æ•°æ®é›† ---
    const innerData = [], innerLabels = [], innerColors = []; // åŸå¸‚å±‚ (å†…åœˆ)
    const outerData = [], outerLabels = [], outerColors = []; // æˆå‘˜å±‚ (å¤–åœˆ)

    const cityNames = Object.keys(cityMap);
    cityNames.forEach((city, idx) => {
        const baseColor = METHOD_COLORS[idx % METHOD_COLORS.length];

        // å†…åœˆæ•°æ®
        innerData.push(cityMap[city].total);
        innerLabels.push(city);
        innerColors.push(baseColor);

        // å¤–åœˆæ•°æ®
        cityMap[city].members.forEach(m => {
            outerData.push(m.value);
            outerLabels.push(m.name);
            outerColors.push(baseColor + 'CC'); // å¤–åœˆé¢œè‰²ç¨æµ…
        });
    });

    const isAmt = currentSupViewMode === 'amount';

    supCharts['sunburst'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [
                {
                    // æ•°æ®é›† 0ï¼šå¤–åœˆ (æ”¯æŒè€…)
                    data: outerData,
                    labels: outerLabels,
                    backgroundColor: outerColors,
                    weight: 2,
                    datalabels: {
                        color: '#fff',
                        font: { size: 10 },
                        formatter: (value, context) => {
                            const label = context.dataset.labels[context.dataIndex];
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            // å æ¯”å¤§äº 5% æ‰æ˜¾ç¤ºï¼Œé¿å…æ‹¥æŒ¤
                            if (value / total < 0.05) return null;
                            return isAmt ? `${label}\nÂ¥${value.toFixed(0)}` : `${label}\n${value}äºº`;
                        }
                    }
                },
                {
                    // æ•°æ®é›† 1ï¼šå†…åœˆ (åŸå¸‚)
                    data: innerData,
                    labels: innerLabels,
                    backgroundColor: innerColors,
                    weight: 1.2,
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value, context) => {
                            const label = context.dataset.labels[context.dataIndex];
                            return isAmt ? `${label}\nÂ¥${value.toFixed(0)}` : `${label}\n${value}äºº`;
                        }
                    }
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '15%', // ç¼©å°ä¸­å¿ƒåœ†å­”ï¼Œç•™å‡ºæ›´å¤šç©ºé—´ç»™æ–‡å­—
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (item) => {
                            const label = item.dataset.labels[item.dataIndex];
                            const val = item.raw;
                            return ` ${label}: ${isAmt ? 'Â¥' + val.toFixed(2) : val + 'äºº'}`;
                        }
                    }
                }
            }
        }
    });
}



/**
 * æ¸²æŸ“ä¸ªäººç”»åƒæ·±åº¦åˆ†æ
 */
function renderIndividualProfile() {
    const name = document.getElementById('individualSearch').value.trim();
    const remarkEl = document.getElementById('individualRemark');
    const latestCareEl = document.getElementById('individualLatestCare');
    const ctx = document.getElementById('individualTrendChart').getContext('2d');

    if (supCharts['individualTrend']) supCharts['individualTrend'].destroy();

    // 1. åŒ¹é…åå†Œä¸­çš„å¤‡æ³¨
    const profile = supporters.find(s => s.name === name);
    if (!profile) {
        remarkEl.innerText = "æœªæ‰¾åˆ°è¯¥æ”¯æŒè€…æ¡£æ¡ˆ";
        latestCareEl.innerHTML = "";
        return;
    }
    remarkEl.innerText = profile.remark || "ï¼ˆæ— å¤‡æ³¨ï¼‰";

    // --- æ ¸å¿ƒä¿®æ”¹ï¼šæ˜¾ç¤ºâ€œæœ€è¿‘ä¸€å¤©â€çš„æ‰€æœ‰æ—¥å¿— ---
    // A. æ‰¾å‡ºè¯¥æ”¯æŒè€…çš„æ‰€æœ‰æ—¥å¿—
    const personLogs = careLogs.filter(l => l.name === name);

    if (personLogs.length > 0) {
        // B. æ‰¾åˆ°æœ€è¿‘è®°å½•çš„æ—¥æœŸï¼ˆç”±äº careLogs å·²æŒ‰æ—¶é—´é™åºï¼Œç¬¬ä¸€æ¡çš„æ—¥æœŸå°±æ˜¯æœ€æ–°çš„ï¼‰
        const latestDate = personLogs[0].date;

        // C. è¿‡æ»¤å‡ºè¯¥æ—¥æœŸä¸‹çš„æ‰€æœ‰è®°å½•
        const sameDayLogs = personLogs.filter(l => l.date === latestDate);

        // D. æ¸²æŸ“ HTML
        latestCareEl.innerHTML = `
            <div style="font-size: 11px; font-weight: bold; color: #8b5cf6; margin-bottom: 4px; display: flex; align-items: center; gap: 5px;">
                ğŸ“… æœ€æ–°å…³æ€€åŠ¨æ€ (${latestDate})
            </div>
            ${sameDayLogs.map(log => `
                <div class="card" style="margin: 0; padding: 10px 12px; border-left: 3px solid #8b5cf6; background:#f0f4ff; box-shadow: none; border: 1px solid #f1eefc; border-left-width: 3px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span style="padding: 1px 5px; background: #ede9fe; color: #7c3aed; border-radius: 3px; font-size: 10px; font-weight: bold;">${log.type}</span>
                    </div>
                    <div style="font-size: 13px; color: #1e293b; line-height: 1.5; white-space: pre-wrap;">${log.content}</div>
                </div>
            `).join('')}
        `;
    } else {
        latestCareEl.innerHTML = `
            <div style="font-size: 11px; color: #94a3b8; text-align: center; padding: 10px; border: 1px dashed #e2e8f0; border-radius: 8px;">
                æš‚æ— é’ˆå¯¹è¯¥æ”¯æŒè€…çš„å…³æ€€æ—¥å¿—
            </div>
        `;
    }
    // --- æ—¥å¿—é€»è¾‘ç»“æŸ ---

    // 2. å‡†å¤‡è¿‘ 5 å¹´çš„æ—¶é—´ç»´åº¦ (ä¿æŒä¸å˜)
    const currentYear = new Date().getFullYear();
    const years = [];
    for (let i = 4; i >= 0; i--) years.push(currentYear - i);

    // 3. æå–å®é™…æ”¯æŒæ•°æ® (ä¿æŒä¸å˜)
    const actualYearlyData = years.map(year => {
        const yearRecs = records.filter(r =>
            r.name === name &&
            new Date(r.date.replace(/-/g, '/')).getFullYear() === year
        );
        const total = yearRecs.reduce((sum, r) => sum + r.amount, 0);
        let months = (year === currentYear) ? (new Date().getMonth() + 1) : 12;
        return Number((total / months).toFixed(2));
    });

    // 4. è®¡ç®—æ‰¿è¯ºçº¿å¹¶æ¸²æŸ“å›¾è¡¨ (ä¿æŒä¸å˜)
    let promiseMonthly = 0;
    const amt = parseFloat(profile.amount) || 0;
    if (profile.freq === 'æŒ‰æœˆ') promiseMonthly = amt;
    else if (profile.freq === 'æŒ‰å¹´') promiseMonthly = amt / 12;

    supCharts['individualTrend'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: years.map(y => y + 'å¹´'),
            datasets: [
                {
                    label: 'å®é™…æœˆå‡å¥‰çŒ®',
                    data: actualYearlyData,
                    backgroundColor: 'rgba(99, 102, 241, 0.6)',
                    borderRadius: 4,
                    order: 2
                },
                {
                    label: 'åå†Œæ‰¿è¯ºæœˆé¢',
                    data: Array(5).fill(promiseMonthly),
                    type: 'line',
                    borderColor: '#10b981',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                datalabels: { display: false },
                legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
            },
            scales: {
                y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                x: { grid: { display: false } }
            }
        }
    });
}
/**
 * æ¸²æŸ“æ”¯æŒè€…æ‰¿è¯ºé¢æ’åå›¾ï¼ˆæ¨ªå‘æ¡å½¢å›¾ + çº¢ç»¿æ¸å˜ï¼‰
 */
function renderSupRankBar(canvasId, data) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (supCharts[canvasId]) supCharts[canvasId].destroy();

    // 1. æ•°æ®æ’åºå¹¶å– Top 10
    const sorted = Object.entries(data)
        .sort((a, b) => b[1] - a[1]) // ä»å¤§åˆ°å°æ’åº
        .slice(0, 10);

    const labels = sorted.map(e => e[0]);
    const values = sorted.map(e => e[1]);

    // 2. åˆ©ç”¨ç³»ç»Ÿç°æœ‰çš„ getColors å‡½æ•°ç”Ÿæˆæ¸å˜è‰²
    // getColors é€»è¾‘ï¼šæœ€å¤§å€¼(Max)ä¸ºçº¢è‰²ï¼Œæœ€å°å€¼(Min)ä¸ºç»¿è‰²
    const barColors = getColors(values);

    // 3. æ‰§è¡Œç»˜åˆ¶
    supCharts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: barColors,
                borderRadius: 4,
                maxBarThickness: 25
            }]
        },
        options: {
            indexAxis: 'y', // æ¨ªå‘æ¡å½¢å›¾
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                datalabels: { display: false }, // ç¦ç”¨æ­¤å›¾è¡¨çš„æ–‡å­—æ ‡ç­¾
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return ` æœˆæ‰¿è¯ºé¢: Â¥${context.parsed.x.toLocaleString(undefined, {minimumFractionDigits:1})}`;
                        }
                    }
                }

            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { color: '#f1f5f9' },
                    ticks: { font: { size: 10 } }
                },
                y: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 12, weight: 'bold' },
                        color: '#1e293b'
                    }
                }
            }
        }
    });
}
/**
 * æ¸²æŸ“çºµå‘æŸ±çŠ¶å›¾ï¼ˆçº¢ç»¿æ¸å˜ã€æ— ç½‘æ ¼çº¿ã€çºµåæ ‡æ•´æ•°ã€æ•°å­—+ç™¾åˆ†æ¯”æ˜¾ç¤ºï¼‰
 */
function renderCityBar(canvasId, data) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (supCharts[canvasId]) supCharts[canvasId].destroy();

    // æ•°æ®æ’åºå¹¶å–å‰ 8 å
    const sorted = Object.entries(data)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

    const labels = sorted.map(e => e[0]);
    const values = sorted.map(e => e[1]);

    // è°ƒç”¨å…¨å±€ getColors è®¡ç®—çº¢ç»¿æ¸å˜
    const barColors = getColors(values);

    supCharts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'äººæ•°',
                data: values,
                backgroundColor: barColors,
                borderRadius: 4,
                maxBarThickness: 40
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                datalabels: { display: false }, // ç¦ç”¨æ­¤å›¾è¡¨çš„æ–‡å­—æ ‡ç­¾
                legend: { display: false },
                tooltip: {
                    callbacks: {
            // åœ¨ renderCityBar çš„ options.plugins.tooltip.callbacks.label ä¸­ä¿®æ”¹ï¼š
label: function(context) {
    const rawValue = context.parsed.y || context.parsed; // å…¼å®¹æŸ±çŠ¶å›¾å’Œé¥¼å›¾
    const value = currentSupViewMode === 'count' ? Math.round(rawValue) : rawValue.toFixed(1);// å–æ•´
    const unit = currentSupViewMode === 'count' ? 'ä½' : 'å…ƒ';
    const displayValue = currentSupViewMode === 'count' ? value : 'Â¥' + value.toLocaleString();

    // è®¡ç®—ç™¾åˆ†æ¯”ä¿æŒä¸å˜
    const total = context.dataset.data.reduce((a, b) => a + b, 0);
    const percentage = ((rawValue / total) * 100).toFixed(0) + '%';

    return ` ${currentSupViewMode === 'count' ? 'æ•°é‡' : 'æœˆæŠ˜ç®—é¢'}: ${displayValue} ${unit} (${percentage})`;
}
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false }, // å·²å…³é—­ X è½´ç½‘æ ¼çº¿
                    border: { display: true }, // ä¿ç•™ X è½´åº•çº¿
                    ticks: { font: { size: 11 } }
                },
                y: {
                    beginAtZero: true,
                    // --- æ–°å¢ï¼šå…³é—­ Y è½´ç½‘æ ¼çº¿ ---
                    grid: { display: 0 },
                    // -----------------------
                    border: { display: 0 }, // å¦‚æœæƒ³å½»åº•å¹²æ‰å·¦ä¾§é‚£æ¡å‚ç›´çº¿ï¼Œè¿™é‡Œè®¾ä¸º false
                    ticks: {
                        // å¼ºåˆ¶æ­¥é•¿ä¸º 1ï¼ˆä»…åœ¨äººæ•°æ¨¡å¼ä¸‹ï¼‰
                        stepSize: currentSupViewMode === 'count' ? 1 : undefined,
                        // ç¡®ä¿ä¸æ˜¾ç¤ºå°æ•°ä½å¹¶å¤„ç†é‡‘é¢æ˜¾ç¤º
                        callback: function(value) {
                            if (currentSupViewMode === 'count') {
                                return value % 1 === 0 ? value : '';
                            }
                            // é‡‘é¢æ¨¡å¼ï¼šç¼©å†™å¤„ç† (1k, 2k...)
                            return value >= 1000 ? 'Â¥' + (value / 1000) + 'k' : 'Â¥' + value;
                        }
                    }
                }
            }
        }
    });
}


/**
 * æ¸²æŸ“ç¯çŠ¶å›¾ï¼ˆæ”¯æŒé”å®šé¢œè‰²ä¸ç™¾åˆ†æ¯”æ˜¾ç¤ºï¼‰
 */
function renderPie(canvasId, data, colors, isDoughnut = false) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (supCharts[canvasId]) supCharts[canvasId].destroy();

    supCharts[canvasId] = new Chart(ctx, {
        type: isDoughnut ? 'doughnut' : 'pie',
        data: {
            labels: Object.keys(data),
            datasets: [{
                data: Object.values(data),
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '50%',
            plugins: {
                datalabels: { display: false }, // ç¦ç”¨æ­¤å›¾è¡¨çš„æ–‡å­—æ ‡ç­¾
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 12, font: { size: 10 } }
                },
                tooltip: {
                    callbacks: {
                        // --- æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†ï¼šå¤„ç†äººæ•°æ˜¾ç¤ºåˆ°ä¸ªä½ ---
                        label: function(context) {
                            const rawValue = context.raw; // è·å–åŸå§‹æ•°å€¼
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((rawValue / total) * 100).toFixed(0) + '%';

                            let displayValue;
                            let unit;

                            if (currentSupViewMode === 'count') {
                                // äººæ•°æ¨¡å¼ï¼šå–æ•´ï¼Œä¸ä¿ç•™å°æ•°
                                displayValue = Math.round(rawValue);
                                unit = 'ä½';
                                return ` æ•°é‡: ${displayValue} ${unit} (${percentage})`;
                            } else {
                                // é‡‘é¢æ¨¡å¼ï¼šä¿ç•™ä¸€ä½å°æ•°å¹¶æ ¼å¼åŒ–
                                displayValue = rawValue.toLocaleString(undefined, {
                                    minimumFractionDigits: 1,
                                    maximumFractionDigits: 1
                                });
                                unit = 'å…ƒ';
                                return ` æœˆæŠ˜ç®—é¢: Â¥${displayValue} ${unit} (${percentage})`;
                            }
                        }
                        // --- ä¿®æ”¹ç»“æŸ ---
                    }
                }
            }
        }
    });
}



let isSupShowAll = false; // æ”¯æŒè€…åˆ—è¡¨çš„æ˜¾ç¤ºçŠ¶æ€

function toggleSupShowAll() {
    isSupShowAll = !isSupShowAll;
    renderSupporters(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
}


    let monthlyTarget = parseFloat(localStorage.getItem('sup_target')) || 0;
    let charts = {};

let isShowAll = false; // ç”¨äºåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€

    const chartBase = {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { x: { grid: { display: false } }, y: { grid: { display: false }, beginAtZero: true } }
    };


document.getElementById('supporterForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const member = {
        id: Date.now(),
        startDate: document.getElementById('supStartDate').value,
        endDate: document.getElementById('supEndDate').value,
        name: document.getElementById('supName').value.trim(),
        gender: document.getElementById('supGender').value,
        city: document.getElementById('supCity').value.trim(),
        freq: document.getElementById('supFreq').value,
        amount: parseFloat(document.getElementById('supAmount').value) || 0,
        remark: document.getElementById('supRemark').value.trim()
    };

    supporters.push(member);
    // æŒ‰å¼€å§‹æ—¥æœŸæ’åºï¼ˆå¯é€‰ï¼‰
    supporters.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

    saveSupporterData();

    // é‡ç½®è¡¨å•
    this.reset();

    // æ ¸å¿ƒï¼šå¼ºåˆ¶åˆ‡å› text ç±»å‹ä»¥æ˜¾ç¤ºâ€œå¼€å§‹æ—¥æœŸ/ç»“æŸæ—¥æœŸâ€é¢„è®¾æ–‡å­—
    document.getElementById('supStartDate').type = 'text';
    document.getElementById('supEndDate').type = 'text';

    alert("ä¿å­˜æˆåŠŸï¼");
});

/**
 * å¼ºåˆ¶æ˜¾ç¤ºæ”¯æŒè€…å§“ååˆ—è¡¨çš„æ‰€æœ‰é€‰é¡¹
 */
function forceShowAllSupporterNames(input) {
    updateSupNameList(); // å…ˆåˆ·æ–°åˆ—è¡¨
    const originalValue = input.value;
    input.value = ''; // ç¬é—´æ¸…ç©ºä»¥è¯±å¯¼æµè§ˆå™¨å¼¹å‡ºå…¨é‡åˆ—è¡¨

    const restoreValue = () => {
        if (input.value === '') {
            input.value = originalValue;
        }
        input.removeEventListener('blur', restoreValue);
    };
    input.addEventListener('blur', restoreValue);
    input.focus();
}

/**
 * å¼ºåŒ–ç‰ˆï¼šä»åå†Œå’Œå†å²è®°å½•ä¸­åŒæ—¶æå–å§“åå¹¶æ¸²æŸ“åˆ°å…¨å±€ datalist
 */
function updateSupNameList() {
    const nameList = document.getElementById('supNameList');
    if (!nameList) return;

    // 1. è·å–æ”¯æŒè€…åå†Œä¸­çš„å§“å
    const namesFromSupporters = supporters.map(s => s.name);
    
    // 2. è·å–å†å²è®°å½•ä¸­çš„å§“å
    const namesFromRecords = records.map(r => r.name);

    // 3. åˆå¹¶ã€å»é‡ã€è¿‡æ»¤ç©ºå€¼
    const allNames = [...new Set([...namesFromSupporters, ...namesFromRecords])]
                        .filter(n => n && n.trim() !== "");

    // 4. æ¸²æŸ“åˆ° datalist
    nameList.innerHTML = allNames.map(name => `<option value="${name}">`).join('');
    
    // åŒæ­¥æ›´æ–°ç»™è®°å½•é¡µé¢çš„å…¼å®¹æ€§åˆ—è¡¨ (å¦‚æœæŸäº›åœ°æ–¹è¿˜å¼•ç”¨äº† nameList)
    const oldNameList = document.getElementById('nameList');
    if (oldNameList) oldNameList.innerHTML = nameList.innerHTML;
}
/**
 * å¼ºåˆ¶æ˜¾ç¤ºåŸå¸‚åˆ—è¡¨çš„æ‰€æœ‰é€‰é¡¹
 * @param {HTMLInputElement} input
 */
function forceShowAllCities(input) {
    const originalValue = input.value;

    // 1. æ¸…ç©ºå½“å‰å€¼ï¼Œè¿™æ · datalist å°±ä¼šæ˜¾ç¤ºå…¨éƒ¨é€‰é¡¹
    input.value = '';

    // 2. è¿™é‡Œçš„ trick æ˜¯ï¼šå¦‚æœç”¨æˆ·ç›´æ¥ç‚¹å‡»åˆ«å¤„ï¼ˆæ²¡é€‰ï¼‰ï¼Œæˆ‘ä»¬è¦æŠŠæ—§å€¼å¡«å›å»
    const restoreValue = () => {
        if (input.value === '') {
            input.value = originalValue;
        }
        input.removeEventListener('blur', restoreValue);
    };

    input.addEventListener('blur', restoreValue);

    // 3. éƒ¨åˆ†æµè§ˆå™¨éœ€è¦æ‰‹åŠ¨èšç„¦
    input.focus();
}



// æ¸…ç©ºæ‰€æœ‰æ”¯æŒè€…æ•°æ®
function clearAllSupporters() {
    if (confirm("âš ï¸ è­¦å‘Šï¼šè¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ”¯æŒè€…åå†Œæ¡£æ¡ˆï¼Œæ— æ³•æ’¤é”€ï¼\næ“ä½œå‰å»ºè®®å…ˆå¤‡ä»½æ•°æ®ã€‚ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ")) {
        supporters = []; // æ¸…ç©ºæ•°ç»„

        // æ›´æ–°æœ¬åœ°å­˜å‚¨
        localStorage.removeItem('sup_members_v1');

        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        renderSupporters();

        // å¦‚æœæœ‰è¡¨å•å†…å®¹ï¼Œä¹Ÿä¸€å¹¶é‡ç½®
        document.getElementById('supporterForm').reset();

        // æ¢å¤æ—¥æœŸè¾“å…¥æ¡†ç±»å‹
        document.getElementById('supStartDate').type = 'text';
        document.getElementById('supEndDate').type = 'text';

        alert("æ”¯æŒè€…æ¡£æ¡ˆå·²å…¨éƒ¨æ¸…ç©ºã€‚");
    }
}



// å¯¼å‡ºæ”¯æŒè€…æ¡£æ¡ˆä¸º CSV
function exportSupportersToCSV() {
    if (!supporters || supporters.length === 0) {
        alert("æ²¡æœ‰å¯å¯¼å‡ºçš„æ”¯æŒè€…æ•°æ®");
        return;
    }

    // 1. å®šä¹‰è¡¨å¤´
    const header = "\ufeffå¼€å§‹æ—¥æœŸ,ç»“æŸæ—¥æœŸ,å§“å,æ€§åˆ«,åŸå¸‚,é¢‘ç‡,é‡‘é¢,å¤‡æ³¨";

    // 2. æ•°æ®è½¬æ¢ä¸è½¬ä¹‰
    const rows = supporters.map(s => {
        const escape = (field) => {
            const str = String(field || '');
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        return [
            escape(s.startDate),
            escape(s.endDate),
            escape(s.name),
            escape(s.gender),
            escape(s.city),
            escape(s.freq),
            escape(s.amount.toFixed(2)),
            escape(s.remark)
        ].join(",");
    });

    const csvContent = header + "\n" + rows.join("\n");

    // 3. æ‰§è¡Œä¸‹è½½
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');

    // ç”Ÿæˆæ–‡ä»¶åï¼šYYYYMMDD_æ”¯æŒè€…åå†Œå¤‡ä»½.csv
    const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    a.href = url;
    a.download = `${dateStr}_æ”¯æŒè€…åå†Œå¤‡ä»½.csv`;

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


// åœ¨ä¿å­˜æˆ–åŠ è½½æ•°æ®åè°ƒç”¨æ­¤é€»è¾‘
function refreshDatePlaceholders() {
    document.querySelectorAll('.date-input').forEach(input => {
        if (input.value) {
            input.setAttribute('placeholder', ' '); // è§¦å‘ CSS ä¸­çš„ :not(:placeholder-shown)
        } else {
            input.removeAttribute('placeholder');
        }
    });
}




function saveSupporterData() {
    console.log("æ­£åœ¨åŒæ­¥æ•°æ®å¹¶åˆ·æ–°ç”»åƒ..."); // è°ƒè¯•æ—¥å¿—

    // 1. æ ‡å‡†åŒ–æ—¥æœŸ
    supporters.forEach(s => {
        s.startDate = formatDateStandard(s.startDate);
        s.endDate = formatDateStandard(s.endDate);
    });

    // 2. æ’åº
    supporters.sort((a, b) => {
        const timeA = a.startDate ? new Date(a.startDate.replace(/-/g, '/')).getTime() : 0;
        const timeB = b.startDate ? new Date(b.startDate.replace(/-/g, '/')).getTime() : 0;
        return timeB - timeA;
    });

    // 3. æ°¸ä¹…ä¿å­˜
    localStorage.setItem('sup_members_v1', JSON.stringify(supporters));

    // 4. ç•Œé¢å…¨é‡å®æ—¶åˆ·æ–°
    renderSupporters();           // åˆ·æ–°åå†Œè¡¨æ ¼å†…å®¹
    updateSupCityList();          // åˆ·æ–°åŸå¸‚ä¸‹æ‹‰åˆ—è¡¨
    updateSupNameList();          // åˆ·æ–°å§“åä¸‹æ‹‰åˆ—è¡¨

    // å…³é”®ï¼šå¼ºåˆ¶åˆ·æ–°ç”»åƒåˆ†ææ¨¡å—
    if (typeof renderSupporterAnalysis === 'function') {
        renderSupporterAnalysis();
    }
}




function updateSupCityList() {
    const cityList = document.getElementById('supCityList');
    if (!cityList) return;

    // ä»æ”¯æŒè€…åå†Œä¸­æå–æ‰€æœ‰éç©ºçš„åŸå¸‚ï¼Œå¹¶å»é‡
    const cities = [...new Set(supporters.map(s => s.city).filter(c => c))];

    // æ¸²æŸ“åˆ° datalist
    cityList.innerHTML = cities.map(city => `<option value="${city}">`).join('');
}



function renderSupporters() {
    const body = document.getElementById('supporterBody');
    const btn = document.getElementById('btnSupShowAll');
    const countSpan = document.getElementById('supRecordCount');

    // --- å†…éƒ¨æ—¥æœŸæ ‡å‡†åŒ–å·¥å…·ï¼šè¡¥å…¨ yyyy-mm-dd ---
    const formatDate = (dateStr) => {
        if (!dateStr || dateStr.trim() === "") return '-';
        // å…¼å®¹å¤„ç†ï¼šæ–œæ è½¬æ¨ªæ ï¼Œå¹¶å°è¯•è§£æ
        const d = new Date(dateStr.replace(/-/g, '/'));
        if (isNaN(d.getTime())) return dateStr;
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    };

    if(countSpan) {
        countSpan.innerText = `(å…± ${supporters.length} ä½)`;
    }

    const displayList = isSupShowAll ? supporters : supporters.slice(0, 10);

    if(btn) {
        btn.innerText = isSupShowAll ? "æ”¶èµ·è®°å½•" : "æ˜¾ç¤ºå…¨éƒ¨è®°å½•";
    }

    body.innerHTML = displayList.map((s, index) => {
        // åˆ¤æ–­çŠ¶æ€æ—¶ä¹Ÿéœ€è¦æ ‡å‡†åŒ–çš„æ—¥æœŸå¯¹è±¡
        const isActive = !s.endDate || new Date(s.endDate.replace(/-/g, '/')) > new Date();
        return `
            <tr>
                <td style="color: #64748b;">${formatDate(s.startDate)}</td>
                <td><b>${s.name}</b></td>
                <td>${s.gender}</td>
                <td>${s.city}</td>
                <td>${s.freq}</td>
                <td>Â¥${s.amount.toFixed(2)}</td>
                <td>${isActive ? '<span style="color:var(--success)">æ”¯æŒä¸­</span>' : '<span style="color:#94a3b8">å·²ç»“æŸ</span>'}</td>
                <td style="text-align:center">
                    <a href="javascript:void(0)" onclick="editSupporter(${index})" style="color:var(--primary); margin-right:8px; text-decoration:none; font-weight:bold;">ç¼–è¾‘</a>
                    <a href="javascript:void(0)" onclick="deleteSupporter(${index})" style="color:var(--danger); text-decoration:none; font-weight:bold;">åˆ é™¤</a>
                </td>
            </tr>
        `;
    }).join('');

    updateSupCityList();
}





function formatDateStandard(dateStr) {
    if (!dateStr) return '';
    // å°†æ‰€æœ‰ / æ›¿æ¢ä¸º -
    let cleanStr = dateStr.replace(/\//g, '-');
    let parts = cleanStr.split('-');

    if (parts.length === 3) {
        let y = parts[0];
        let m = parts[1].padStart(2, '0'); // è¡¥é½ä¸¤ä½æ•°
        let d = parts[2].padStart(2, '0'); // è¡¥é½ä¸¤ä½æ•°
        return `${y}-${m}-${d}`;
    }
    return dateStr;
}







function editSupporter(index) {
    const s = supporters[index];

    // 1. å›å¡«åŸºæœ¬ä¿¡æ¯
    document.getElementById('supName').value = s.name;
    document.getElementById('supGender').value = s.gender;
    document.getElementById('supCity').value = s.city;
    document.getElementById('supFreq').value = s.freq;
    document.getElementById('supAmount').value = s.amount;
    document.getElementById('supRemark').value = s.remark;

    // 2. å¤„ç†æ—¥æœŸå›å¡«ï¼ˆå¤„ç†ä¹‹å‰æåˆ°çš„ç±»å‹åˆ‡æ¢é€»è¾‘ï¼‰
    const startInput = document.getElementById('supStartDate');
    const endInput = document.getElementById('supEndDate');

    if (s.startDate) {
        startInput.type = 'date';
        startInput.value = s.startDate;
    }
    if (s.endDate) {
        endInput.type = 'date';
        endInput.value = s.endDate;
    }

    // 3. ä»æ•°ç»„ä¸­ç§»é™¤å½“å‰é¡¹ï¼ˆä»¥ä¾¿ä¿å­˜æ—¶ä½œä¸ºæ–°æ•°æ®å­˜å…¥ï¼Œæˆ–è€…ä½ å¯ä»¥å¢åŠ ä¸€ä¸ªå…¨å±€å˜é‡ editIndex æ¥æ ‡è®°ï¼‰
    supporters.splice(index, 1);

    // 4. æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨æ–¹ä¾¿ç¼–è¾‘
    window.scrollTo({ top: 0, behavior: 'smooth' });

    renderSupporters(); // åˆ·æ–°åˆ—è¡¨æŸ¥çœ‹æ•ˆæœ
}

// 4. åˆ é™¤æ”¯æŒè€…
function deleteSupporter(index) {
    if(confirm("ç¡®å®šåˆ é™¤è¯¥æ”¯æŒè€…æ¡£æ¡ˆå—ï¼Ÿ")) {
        supporters.splice(index, 1);
        saveSupporterData();
    }
}



function exportToGaomingCSV() {
    if (!records || records.length === 0) {
        alert("æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®");
        return;
    }

    // --- æ ¸å¿ƒï¼šå†…éƒ¨æ—¥æœŸæ ¼å¼åŒ–è¾…åŠ©å·¥å…· ---
    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr.replace(/-/g, '/')); // å…¼å®¹æ€§è§£æ
        if (isNaN(d.getTime())) return dateStr;

        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    };

    // 1. å®šä¹‰è¡¨å¤´
    const header = "\ufeffæ—¥æœŸ,é‡‘é¢,ç§ç±»,æ”¯æŒè€…,æè¿°";

    // 2. æ•°æ®è½¬æ¢é€»è¾‘
    const rows = records.map(r => {
        // è½¬æ¢ç§ç±»ï¼šæŒ‰æœˆ -> Monthlyï¼Œå…¶ä»– -> One-time
        const type = (r.frequency === 'æŒ‰æœˆ') ? 'Monthly' : 'One-time';

        const escape = (field) => {
            const str = String(field || '');
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        return [
            escape(formatDate(r.date)), // <--- è¿™é‡Œå¼ºåˆ¶æ ¼å¼åŒ–ä¸º yyyy-mm-dd
            escape(r.amount.toFixed(2)),
            escape(type),
            escape(r.name),
            escape(r.remark)
        ].join(",");
    });

    const csvContent = header + "\n" + rows.join("\n");

    // 3. æ‰§è¡Œä¸‹è½½
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');

    const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    a.href = url;
    a.download = `${dateStr}_é«˜æ˜æ ¼å¼æ”¯æŒè¡¨.csv`;

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


function downloadTemplate(event) {
    if (event) event.preventDefault(); // é˜²æ­¢é¡µé¢è·³è½¬

    // 1. å®šä¹‰è¡¨å¤´ï¼šå¿…é¡»ä¸ exportToCSV å‡½æ•°ä¸­çš„åˆ—åºå®Œå…¨ä¸€è‡´
    // åŒ…å«ï¼šæ—¥æœŸ, å§“å, æ€§åˆ«, æ–¹å¼, åœ°åŒº, é‡‘é¢, é¢‘ç‡, å¤‡æ³¨
    const header = "\ufeffæ—¥æœŸ,å§“å,æ€§åˆ«,æ–¹å¼,åœ°åŒº,é‡‘é¢,é¢‘ç‡,å¤‡æ³¨\n";

    // 2. å®šä¹‰ç¤ºä¾‹è¡Œï¼šæ–¹ä¾¿ç”¨æˆ·å‚è€ƒæ ¼å¼å½•å…¥
    const example = "2026-01-20,å¼ ä¸‰,ç”·,å¾®ä¿¡,ä¸Šæµ·,100.00,æŒ‰æœˆ,æ—¥å¸¸æ”¯æŒ\n";

    const csvContent = header + example;

    // 3. åˆ›å»º Blob å¯¹è±¡ï¼ˆæŒ‡å®šç¼–ç ä¸º UTF-8 å¸¦æœ‰ BOMï¼Œç¡®ä¿ Excel æ‰“å¼€ä¸ä¹±ç ï¼‰
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    // 4. åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥å¹¶è§¦å‘
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "æ”¯æŒè®°å½•å¯¼å…¥æ¨¡ç‰ˆ.csv");
    document.body.appendChild(link);

    link.click();

    // 5. æ¸…ç†ç°åœº
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}


function forceShowAll(input) {
    // åªæœ‰å½“æ¡†å†…æœ‰å†…å®¹æ—¶æ‰æ‰§è¡Œç‰¹æ®Šé€»è¾‘
    if (input.value !== '') {
        const originalValue = input.value;
        input.value = ''; // ç¬é—´æ¸…ç©ºï¼Œè¯±å¯¼æµè§ˆå™¨å¼¹å‡ºå…¨é‡ datalist

        // ç›‘å¬ä¸‹ä¸€æ¬¡è¾“å…¥æˆ–å¤±å»ç„¦ç‚¹ï¼Œå¦‚æœç”¨æˆ·æ²¡é€‰æ–°å€¼ï¼Œå°±è¿˜åŸæ—§å€¼
        const restoreValue = () => {
            if (input.value === '') {
                input.value = originalValue;
            }
            input.removeEventListener('blur', restoreValue);
        };
        input.addEventListener('blur', restoreValue);
    }
}

    // --- æ ¸å¿ƒä¿®å¤ï¼šCSV å¯¼å…¥å¼•æ“ ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
        if (this.files[0]) processFile(this.files[0]);
    });

document.getElementById('dropZone').addEventListener('click', function() {
    document.getElementById('fileInput').click();
});

function processFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const rows = robustCSVParser(e.target.result); // ä½¿ç”¨é€šç”¨è§£æå™¨
        let count = 0;

        for (let i = 1; i < rows.length; i++) {
            const cols = rows[i];
            if (cols.length >= 6 && cols[1]) { // å§“åå’Œé‡‘é¢å¿…é¡»æœ‰
                records.push({
                    date: cols[0],
                    name: cols[1],
                    gender: cols[2] || '',
                    method: cols[3] || '',
                    area: cols[4] || '',
                    amount: parseFloat(cols[5]) || 0,
                    frequency: cols[6] || 'æŒ‰æœˆ',
                    remark: cols[7] || '',
                    ts: new Date(cols[0].replace(/-/g, '/')).getTime() || Date.now()
                });
                count++;
            }
        }
        // ... åŸæœ‰çš„ä¿å­˜é€»è¾‘ ...
        if (count > 0) {
            records.sort((a, b) => b.ts - a.ts);
            saveData();
            alert(`âœ… å¯¼å…¥æˆåŠŸï¼å…±æ–°å¢ ${count} æ¡è®°å½•ã€‚`);
            document.getElementById('batchImportWrapper').classList.add('hidden');
        }
    };
    reader.readAsText(file, 'UTF-8');
}


// --- å…¶ä»–åŠŸèƒ½ç»´æŠ¤ ---
   function handleDrag(e, over, id) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById(id).classList.toggle('dragover', over);
}

function handleSupDrop(e) {
    e.preventDefault(); e.stopPropagation();
    handleDrag(e, false, 'supDropZone');
    if (e.dataTransfer.files[0]) processSupFile(e.dataTransfer.files[0]);
}


function processSupFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        // 1. å…¼å®¹å¤šç§æ¢è¡Œç¬¦å¹¶è¿‡æ»¤ç©ºè¡Œ
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
        let count = 0;

        lines.forEach((line, i) => {
            if (i === 0) return; // è·³è¿‡è¡¨å¤´

            // 2. ç®€å•çš„ CSV è§£æï¼ˆå¤„ç†é€—å·åˆ†éš”ï¼‰
            const cols = line.split(',').map(c => c.replace(/^["']|["']$/g, '').trim());

            // 3. æ ¡éªŒå§“åå’Œæ—¥æœŸï¼ˆè‡³å°‘è¦æœ‰ç¬¬3åˆ—å§“åå’Œç¬¬1åˆ—å¼€å§‹æ—¥æœŸï¼‰
            if (cols.length >= 3 && cols[2]) {
                supporters.push({
                    id: Date.now() + i,
                    startDate: formatDateStandard(cols[0]),
                    endDate: formatDateStandard(cols[1]) || '',
                    name: cols[2],
                    gender: cols[3] || 'ç”·',
                    city: cols[4] || '',
                    freq: cols[5] || 'æŒ‰æœˆ',
                    amount: parseFloat(cols[6]) || 0,
                    remark: cols[7] || ''
                });
                count++;
            }
        });

        // 4. ä¿å­˜å¹¶åé¦ˆ
        if (count > 0) {
            saveSupporterData(); // è¯¥å‡½æ•°ä¼šè‡ªåŠ¨è§¦å‘ renderSupporters å’Œ renderSupporterAnalysis
            alert(`æ”¯æŒè€…åå†Œå¯¼å…¥æˆåŠŸï¼å…±æ–°å¢ ${count} ä½æˆå‘˜ã€‚`);
        } else {
            alert("æœªæ£€æµ‹åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥ CSV æ ¼å¼ã€‚");
        }
        document.getElementById('supFileInput').value = ""; // æ¸…ç©º input æ–¹ä¾¿é‡å¤å¯¼å…¥
    };
    reader.onerror = () => alert("è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¼–ç ï¼ˆå»ºè®®ä½¿ç”¨ UTF-8ï¼‰ã€‚");
    reader.readAsText(file, 'UTF-8');
}


function downloadSupTemplate() {
    const header = "\ufeffå¼€å§‹æ”¯æŒæ—¥æœŸ,ç»“æŸæ”¯æŒæ—¥æœŸ,å§“å,æ€§åˆ«,åŸå¸‚,é¢‘ç‡,é‡‘é¢,å¤‡æ³¨\n";
    const example = "2024-01-01,,å¼ ä¸‰,ç”·,ä¸Šæµ·,æŒ‰æœˆ,500,æ ¸å¿ƒæ”¯æŒè€…\n";

    const csvContent = header + example;

    const blob = new Blob([header + example], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);


    const link = document.createElement("a");

 link.setAttribute("href", url);
    link.setAttribute("download", "æ”¯æŒåå†Œå¯¼å…¥æ¨¡ç‰ˆ.csv");
    document.body.appendChild(link);

    link.click();
 document.body.removeChild(link);
    URL.revokeObjectURL(url);
}



/**
 * æ‰§è¡Œå¤šæ¡ä»¶è”åˆç­›é€‰ï¼ˆä¼˜åŒ–ç‰ˆï¼šå…³é”®å­—åŒæ—¶åŒ¹é…å§“åå’Œå†…å®¹ï¼‰
 */
/**
 * æ‰§è¡Œå¤šæ¡ä»¶è”åˆç­›é€‰ (æœªé€‰æ‹©æ¡ä»¶æ—¶é»˜è®¤æ˜¾ç¤ºæœ€æ–°2æ¡)
 */
function filterCareLogs() {
    const name = document.getElementById('filterCareName').value.trim().toLowerCase();
    const type = document.getElementById('filterCareType').value;
    const start = document.getElementById('filterCareStart').value;
    const end = document.getElementById('filterCareEnd').value;
    const keyword = document.getElementById('filterCareKeyword').value.trim().toLowerCase();

    const resultArea = document.getElementById('filterResultArea');
    const gridContainer = document.getElementById('careGridContainer');
    const countSpan = document.getElementById('filterMatchCount');

    // 1. æ£€æŸ¥æ˜¯å¦æ²¡æœ‰ä»»ä½•ç­›é€‰æ¡ä»¶
    const noFilters = !name && !type && !start && !end && !keyword;

    let filtered;
    if (noFilters) {
        // å¦‚æœæ²¡æœ‰ç­›é€‰æ¡ä»¶ï¼Œå–æœ€æ–°çš„ 2 æ¡
        filtered = careLogs.slice(0, 2);
        countSpan.innerText = "æœ€æ–°2æ¡";
    } else {
        // æ‰§è¡Œæ­£å¸¸çš„ç­›é€‰é€»è¾‘
        filtered = careLogs.filter(log => {
            const matchName = !name || log.name.toLowerCase().includes(name);
            const matchType = !type || log.type === type;
            const matchKeyword = !keyword ||
                               log.content.toLowerCase().includes(keyword) ||
                               log.name.toLowerCase().includes(keyword);

            const logTime = new Date(log.date.replace(/-/g, '/')).getTime();
            const startTime = start ? new Date(start.replace(/-/g, '/')).getTime() : 0;
            const endTime = end ? new Date(end.replace(/-/g, '/')).getTime() + 86400000 : Infinity;
            const matchDate = logTime >= startTime && logTime < endTime;

            return matchName && matchType && matchKeyword && matchDate;
        });
        countSpan.innerText = `${filtered.length} æ¡`;
    }

    // å§‹ç»ˆæ˜¾ç¤ºç»“æœåŒºåŸŸ
    resultArea.classList.remove('hidden');

    if (filtered.length === 0) {
        gridContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8; font-size: 13px;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•</div>';
        return;
    }

const statSpan = document.getElementById('careFilterStat');
    if (statSpan) {
        // å¦‚æœæ²¡æœ‰ä»»ä½•ç­›é€‰æ¡ä»¶ï¼Œfiltered é•¿åº¦ä¸º 2ï¼Œä½†æˆ‘ä»¬è¿™é‡Œæ˜¾ç¤ºâ€œæ‰€æœ‰â€
        const isDefault = !name && !type && !start && !end && !keyword;

        if (isDefault) {
            statSpan.innerText = `(æ‰€æœ‰è®°å½• ${careLogs.length} æ¡)`;
        } else {
            statSpan.innerText = `(ç­›é€‰åŒ¹é… ${filtered.length} æ¡)`;
        }
    }


   // æ¸²æŸ“ç»“æœå¡ç‰‡ï¼Œå¹¶ç»‘å®šå“åº”å¼å¼¹çª—
gridContainer.innerHTML = filtered.map(log => {
    return `
        <div class="card" onclick="openCareModal(${log.id})" style="cursor:pointer; margin: 0; padding: 15px; border-top: 3px solid #8b5cf6; display: flex; flex-direction: column; justify-content: space-between; min-height: 120px; transition: 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 15px rgba(0,0,0,0.05)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.03)'">
            <div>
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <b style="font-size: 15px; color: #1e293b;">${log.name}</b>
                        <span style="font-size: 10px; padding: 2px 6px; background: #f1f5f9; color: #64748b; border-radius: 4px; font-weight:600; white-space: nowrap;">${log.type}</span>
                    </div>
                    <span style="font-size: 11px; color: #94a3b8; white-space: nowrap;">${log.date}</span>
                </div>
                <div style="font-size: 13px; color: #475569; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis;">${log.content}</div>
            </div>
        </div>
    `;
}).join('');
}

/**
 * é‡ç½®ç­›é€‰å™¨
 */
function resetCareFilters() {
    document.getElementById('filterCareName').value = '';
    document.getElementById('filterCareType').value = '';
    document.getElementById('filterCareStart').value = '';
    document.getElementById('filterCareEnd').value = '';
    document.getElementById('filterCareKeyword').value = '';
    filterCareLogs();
}


/**
 * å¯¼å…¥å…³æ€€æ—¥å¿— CSV
 */
function importCareLogsFromCSV(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const rows = robustCSVParser(e.target.result); // ä½¿ç”¨é€šç”¨è§£æå™¨

        if (rows.length <= 1) {
            alert("æ–‡ä»¶å†…æ— æœ‰æ•ˆæ•°æ®");
            return;
        }

        let importCount = 0;
        // ä»ç¬¬äºŒè¡Œå¼€å§‹éå† (è·³è¿‡è¡¨å¤´)
        for (let i = 1; i < rows.length; i++) {
            const cols = rows[i];
            if (cols.length >= 2) { 
                careLogs.push({
                    id: Date.now() + i,
                    date: cols[0] || new Date().toISOString().slice(0, 10),
                    name: cols[1] || 'æœªçŸ¥',
                    type: cols[2] || 'å¸¸è§„é—®å€™',
                    content: cols[3] || '' // è¿™é‡Œçš„æ¢è¡Œç°åœ¨è¢«å®Œç¾æ”¯æŒäº†
                });
                importCount++;
            }
        }
        // ... åŸæœ‰çš„ä¿å­˜ã€åˆ·æ–°é€»è¾‘ä¿æŒä¸å˜ ...
        if (importCount > 0) {
            careLogs.sort((a, b) => new Date(b.date.replace(/-/g, '/')) - new Date(a.date.replace(/-/g, '/')));
            localStorage.setItem('sup_care_logs_v1', JSON.stringify(careLogs));
            globalRefreshCareDisplay();
            filterCareLogs(); 
            renderCareLogs();
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${importCount} æ¡å…³æ€€è®°å½•`);
        }
        input.value = "";
    };
    reader.readAsText(file, 'UTF-8');
}

/**
 * å¯¼å‡ºå…³æ€€æ—¥å¿—åˆ° CSV
 */
function exportCareLogsToCSV() {
    if (!careLogs || careLogs.length === 0) {
        alert("æš‚æ— æ—¥å¿—è®°å½•å¯ä»¥å¯¼å‡º");
        return;
    }

    // 1. å®šä¹‰è¡¨å¤´
    const headers = ["æ—¥æœŸ", "æ”¯æŒè€…å§“å", "å…³æ€€ç±»å‹", "è®°å½•å†…å®¹"];

    // 2. æ•°æ®è½¬æ¢é€»è¾‘
    const rows = careLogs.map(log => {
        // æ•°æ®è½¬ä¹‰å¤„ç†ï¼šé˜²æ­¢å†…å®¹é‡Œçš„é€—å·ã€æ¢è¡Œç¬¦ç ´å CSV ç»“æ„
        const escapeCSV = (field) => {
            const str = field === null || field === undefined ? '' : String(field);
            // å¦‚æœå†…å®¹åŒ…å«é€—å·ã€åŒå¼•å·æˆ–æ¢è¡Œç¬¦ï¼Œå¿…é¡»ç”¨åŒå¼•å·åŒ…è£¹ï¼Œå¹¶å°†å†…éƒ¨åŒå¼•å·è½¬ä¸ºä¸¤ä¸ªåŒå¼•å·
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        return [
            escapeCSV(log.date),
            escapeCSV(log.name),
            escapeCSV(log.type),
            escapeCSV(log.content)
        ].join(",");
    });

    // 3. æ„å»º CSV å†…å®¹ (æ·»åŠ  UTF-8 BOM \ufeff è§£å†³ Excel æ‰“å¼€ä¸­æ–‡ä¹±ç )
    const csvContent = "\ufeff" + headers.join(",") + "\n" + rows.join("\n");

    // 4. æ‰§è¡Œä¸‹è½½
    try {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');

        // ç”Ÿæˆæ–‡ä»¶åï¼š20260125_å…³æ€€æ—¥å¿—å¤‡ä»½.csv
        const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.href = url;
        a.download = `${dateStr}_å…³æ€€æ—¥å¿—å¤‡ä»½.csv`;

        document.body.appendChild(a);
        a.click();

        // æ¸…ç†ç°åœº
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 100);
    } catch (err) {
        console.error("å¯¼å‡ºå¤±è´¥:", err);
        alert("å¯¼å‡ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®ã€‚");
    }
}

/**
 * æ‰“å¼€å…³æ€€è®°å½•è¯¦æƒ…å¼¹çª—
 */
function openCareModal(id) {
    const log = careLogs.find(l => l.id === id);
    if (!log) return;

    // å¡«å……æ•°æ®
    document.getElementById('m_careName').innerText = log.name;
    document.getElementById('m_careType').innerText = log.type;
    document.getElementById('m_careDate').innerText = log.date;
    document.getElementById('m_careContent').innerText = log.content;

    // ç»‘å®šåˆ é™¤å’Œç¼–è¾‘æŒ‰é’®
    // å…ˆè·å–ç´¢å¼•
    const index = careLogs.findIndex(l => l.id === id);

    document.getElementById('m_btnDelete').onclick = () => {
        closeCareModal();
        deleteCareLog(index);
        filterCareLogs(); // åˆ·æ–°ç­›é€‰ç»“æœ
    };

    document.getElementById('m_btnEdit').onclick = () => {
        closeCareModal();
        editCareLog(index);
    };

    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('careModal').classList.remove('hidden');
}

/**
 * å…³é—­å¼¹çª—
 */
function closeCareModal(e) {
    document.getElementById('careModal').classList.add('hidden');
}

/**
 * æ‰“å¼€å¼¹çª—å¹¶ç¦ç”¨èƒŒæ™¯æ»šåŠ¨
 */
function openCareModal(id) {
    const log = careLogs.find(l => l.id === id);
    if (!log) return;

    document.getElementById('m_careName').innerText = log.name;
    document.getElementById('m_careType').innerText = log.type;
    document.getElementById('m_careDate').innerText = log.date;
    document.getElementById('m_careContent').innerText = log.content;

    const index = careLogs.findIndex(l => l.id === id);

    document.getElementById('m_btnDelete').onclick = () => {
        if(confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥å¿—å—ï¼Ÿ")) {
            closeCareModal();
            deleteCareLog(index);
            if (typeof filterCareLogs === 'function') filterCareLogs();
        }
    };

    document.getElementById('m_btnEdit').onclick = () => {
        closeCareModal();
        editCareLog(index);
    };

    document.getElementById('careModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
}

/**
 * å…³é—­å¼¹çª—å¹¶æ¢å¤èƒŒæ™¯æ»šåŠ¨
 */
function closeCareModal() {
    document.getElementById('careModal').classList.add('hidden');
    document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
}


//æ”¯æŒè€…ç”»åƒåˆ†æé¡µé¢
/**
 * å…¨å±€åˆ·æ–°ç”»åƒï¼šåœ¨å…³æ€€æ—¥å¿—å‘ç”Ÿä»»ä½•å¢åˆ æ”¹åæ‰§è¡Œ
 */
function globalRefreshCareDisplay() {
    // 1. å¼ºåˆ¶ä» Storage é‡æ–°åŠ è½½ï¼Œç¡®ä¿å¤šç³»ç»Ÿé—´æ•°æ®æœ€æ–°
    careLogs = JSON.parse(localStorage.getItem('sup_care_logs_v1')) || [];

    // 2. å¦‚æœç”»åƒé¡µé¢çš„æœç´¢æ¡†æœ‰å€¼ï¼Œè¯´æ˜ç”»åƒæ­£åœ¨è¢«æŸ¥çœ‹ï¼Œæ‰§è¡Œé‡ç»˜
    const searchVal = document.getElementById('individualSearch').value.trim();
    if (searchVal) {
        renderIndividualProfile();
        console.log("ç”»åƒå·²å®æ—¶æ›´æ–°");
    }
}

/**
 * è¾…åŠ©å‡½æ•°ï¼šå¦‚æœå½“å‰åœ¨ç”»åƒé¡µé¢ï¼Œåˆ™åˆ·æ–°å…¶æ˜¾ç¤ºå†…å®¹
 */
function refreshIndividualProfileIfActive() {
    const currentPage = localStorage.getItem('current_active_page');
    const searchInput = document.getElementById('individualSearch');

    // å¦‚æœå½“å‰æ­£åœ¨â€œæ”¯æŒè€…ç”»åƒâ€é¡µé¢ï¼Œä¸”æœç´¢æ¡†é‡Œæœ‰åå­—ï¼Œåˆ™æ‰§è¡Œåˆ·æ–°
    if (currentPage === 'supporterAnalysisPage' && searchInput && searchInput.value.trim()) {
        renderIndividualProfile();
        console.log("æ£€æµ‹åˆ°æ•°æ®å˜åŠ¨ï¼Œå·²åŠ¨æ€æ›´æ–°ç”»åƒè§†å›¾");
    }
}

/**
 * å®Œæ•´ä¿®å¤ç‰ˆ showPage å‡½æ•°
 * 1. éšè—é¢„ç®—é¡µå¤šä½™çš„æ ‡é¢˜å¤´
 * 2. ä¼˜åŒ–å„ç³»ç»Ÿé—´çš„è¿”å›é€»è¾‘
 */
function showPage(p) {
    localStorage.setItem('current_active_page', p);
    window.scrollTo({ top: 0, behavior: 'instant' });

    const mainTitle = document.getElementById('mainTitle');
    const navHeader = document.querySelector('.nav-header');

    // è·å–æ‰€æœ‰å¯¼èˆªæŒ‰é’®
    const btnToHome = document.getElementById('toHome');
    const btnToSupporter = document.getElementById('toSupporter');
    const btnToCareLog = document.getElementById('toCareLog');
    const btnToIndex = document.getElementById('toIndex');

    // åˆå§‹çŠ¶æ€ï¼šéšè—æ‰€æœ‰å¯¼èˆªæŒ‰é’®
    [btnToHome, btnToSupporter, btnToCareLog, btnToIndex].forEach(btn => {
        if(btn) btn.classList.add('hidden');
    });

    // --- æ ¸å¿ƒä¿®å¤ï¼šå¸ƒå±€æ§åˆ¶ ---
    // å¦‚æœæ˜¯é¦–é¡µ æˆ– é¢„ç®—é¡µï¼Œéšè—å…¬å…±çš„ nav-headerï¼ˆå› ä¸ºé¢„ç®—é¡µè‡ªå¸¦äº†ä¸“å±æ ‡é¢˜å¤´ï¼‰
    if (p === 'index' || p === 'budget') {
        if (navHeader) navHeader.classList.add('hidden');
    } else {
        if (navHeader) navHeader.classList.remove('hidden');
        if(btnToIndex) btnToIndex.classList.remove('hidden'); // å…¶ä»–é¡µæ˜¾ç¤ºâ€œè¿”å›é¦–é¡µâ€
    }

    if (p === 'index') {
        document.getElementById('indexPage').style.display = 'flex';
    } else {
        document.getElementById('indexPage').style.display = 'none';
    }

    // --- å„é¡µé¢ä¸“å±é€»è¾‘ä¸æ ‡é¢˜ ---
    if (p === 'home') {
        if(mainTitle) mainTitle.innerText = "æ”¯æŒè®°å½•ç³»ç»Ÿ";
        const dateInput = document.getElementById('date');
        if (dateInput) dateInput.value = getTodayStr();
        renderHome();
    }
    else if (p === 'careLog') {
        if(mainTitle) mainTitle.innerText = "å…³æ€€æ—¥å¿—ä¸­å¿ƒ";
        const careDateInput = document.getElementById('careDate');
        if (careDateInput) careDateInput.value = getTodayStr();

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šæ˜¾ç¤ºè¿”å›åå†Œå’Œè¿”å›é¦–é¡µæŒ‰é’® ---
        if(btnToSupporter) {
            btnToSupporter.classList.remove('hidden');
            btnToSupporter.innerText = "ğŸ‘¥ è¿”å›åå†Œ";
        }
        if(btnToIndex) btnToIndex.classList.remove('hidden');

        if (typeof updateSupNameList === 'function') updateSupNameList();
        if (typeof filterCareLogs === 'function') filterCareLogs();
        renderCareLogs();
    }
    else if (p === 'supporter') {
        if(mainTitle) mainTitle.innerText = "æ”¯æŒè€…ç®¡ç†ç³»ç»Ÿ";
        if(btnToCareLog) btnToCareLog.classList.remove('hidden');
        // --- æ–°å¢ï¼šç¡®ä¿ä¸€è¿›é¡µé¢å°±åŠ è½½åŸå¸‚è”æƒ³å»ºè®® ---
            updateSupCityList();
            updateSupNameList();
    }
    else if (p === 'analysis') {
        if(mainTitle) mainTitle.innerText = "è´¢åŠ¡åˆ†æä¸­å¿ƒ";
        if(btnToHome) btnToHome.classList.remove('hidden');
        setTimeout(runAnalysis, 100);
    }
    else if (p === 'supporterAnalysisPage') {
        if(mainTitle) mainTitle.innerText = "æ”¯æŒè€…ç”»åƒåˆ†æ";
        updateSupNameList();
        updateAnaYearOptions(); // åˆ·æ–°å¹´ä»½ä¸‹æ‹‰æ¡†
    setTimeout(renderSupporterAnalysis, 100);
        if(btnToSupporter) {
            btnToSupporter.classList.remove('hidden');
            btnToSupporter.innerText = "ğŸ‘¥ è¿”å›åå†Œ";
        }
        setTimeout(renderSupporterAnalysis, 100);
    }

    // é¡µé¢å®¹å™¨æ˜¾éšåˆ‡æ¢
    const pages = ['home', 'analysis', 'supporter', 'supporterAnalysisPage', 'budget', 'careLog'];
    pages.forEach(id => {
        const el = document.getElementById(id + (id.includes('Page') ? '' : 'Page'));
        if (el) el.classList.toggle('hidden', id !== p);
    });
}


function saveData() { localStorage.setItem('sup_v14', JSON.stringify(records)); renderHome(); }

function renderHome() {
    const body = document.getElementById('recordBody');
    // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæ‰¾ä¸åˆ°è¡¨æ ¼å®¹å™¨ï¼Œç›´æ¥é€€å‡ºï¼Œé˜²æ­¢æŠ¥é”™å¯¼è‡´é¡µé¢ç©ºç™½
    if (!body) return;

    // 1. å¤„ç†æ˜¾ç¤ºé€»è¾‘ï¼ˆæ˜¾ç¤ºå…¨éƒ¨ æˆ– åªæ˜¾ç¤ºå‰10æ¡ï¼‰
    const displayList = isShowAll ? records : records.slice(0, 10);

    // 2. æ›´æ–°æŒ‰é’®æ–‡å­—å’Œè®°å½•æ€»æ•°æ˜¾ç¤º
    const btnShowAll = document.getElementById('btnShowAll');
    if (btnShowAll) {
        btnShowAll.innerText = isShowAll ? "æ”¶èµ·è®°å½•" : "æ˜¾ç¤ºå…¨éƒ¨";
    }
    const recordCountSpan = document.getElementById('recordCount');
    if (recordCountSpan) {
        recordCountSpan.innerText = `(å…± ${records.length} æ¡)`;
    }

    // 3. å†…éƒ¨æ—¥æœŸæ ¼å¼åŒ–å·¥å…·ï¼ˆç¡®ä¿è¡¨æ ¼æ—¥æœŸç¾è§‚ï¼‰
    const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        const d = new Date(dateStr.replace(/-/g, '/'));
        if (isNaN(d.getTime())) return dateStr;
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    };

    // 4. æ¸²æŸ“è¡¨æ ¼ HTML ç»“æ„
    body.innerHTML = displayList.map((r, index) => `
        <tr>
            <td>${formatDate(r.date)}</td>
            <td><b>${r.name}</b></td>
            <td>${r.gender || '-'}</td> 
            <td>${r.method || '-'}</td> 
            <td>${r.area || '-'}</td>
            <td>Â¥${(Number(r.amount) || 0).toFixed(2)}</td>
            <td><small>${r.frequency || '-'}</small></td>
            <td title="${r.remark || ''}">${(r.remark || '-').substring(0, 10)}${(r.remark && r.remark.length > 10) ? '...' : ''}</td>
            <td style="text-align:right">
                <a href="javascript:void(0)" onclick="editRecord(${index})" style="color:var(--primary); margin-right:10px; text-decoration:none; font-weight:bold;">ç¼–è¾‘</a>
                <a href="javascript:void(0)" onclick="deleteRecord(${index})" style="color:var(--danger); text-decoration:none; font-weight:bold;">åˆ é™¤</a>
            </td>
        </tr>
    `).join('');

    // 5. æ›´æ–°æ‰€æœ‰è”æƒ³è¯åº“ (Datalists)
    
    // A. è°ƒç”¨åˆå¹¶åçš„å§“åè”æƒ³é€»è¾‘ï¼ˆåå†Œ+è®°å½•ï¼‰
    if (typeof updateSupNameList === 'function') {
        updateSupNameList();
    }

    // B. æ›´æ–°åœ°åŒºè”æƒ³è¯åº“
    const areaList = document.getElementById('areaList');
    if (areaList) {
        const uniqueAreas = [...new Set(records.map(r => r.area))].filter(a => a);
        areaList.innerHTML = uniqueAreas.map(a => `<option value="${a}">`).join('');
    }

    // C. æ›´æ–°æ”¯ä»˜æ–¹å¼è”æƒ³è¯åº“
    const methodList = document.getElementById('methodList');
    if (methodList) {
        const uniqueMethods = [...new Set(records.map(r => r.method))].filter(m => m);
        methodList.innerHTML = uniqueMethods.map(m => `<option value="${m}">`).join('');
    }
}

document.getElementById('recordForm').addEventListener('submit', function(e){
    e.preventDefault();
    const d = document.getElementById('date').value;
    records.push({
        date: d,
        name: document.getElementById('name').value.trim(),
        gender: document.getElementById('gender').value.trim(), // æ–°å¢
        method: document.getElementById('method').value.trim(), // æ–°å¢
        area: document.getElementById('area').value.trim(),
        amount: parseFloat(document.getElementById('amount').value),
        frequency: document.getElementById('frequency').value,
        remark: document.getElementById('remark').value.trim(),
        ts: new Date(d.replace(/-/g,'/')).getTime()
    });
    records.sort((a,b) => b.ts - a.ts);
    saveData();
    this.reset();
    // ä¿®è®¢ç‚¹ï¼šé‡ç½®åæ¢å¤é»˜è®¤æ—¥æœŸ
    document.getElementById('date').value = getTodayStr();
});





// åˆ‡æ¢æ˜¾ç¤ºå…¨éƒ¨
function toggleShowAll() {
    isShowAll = !isShowAll;
    renderHome();
}

// åˆ é™¤å•æ¡è®°å½•
function deleteRecord(index) {
    if (confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
        records.splice(index, 1);
        saveData();
    }
}

// ç¼–è¾‘è®°å½•
// ç¼–è¾‘åŠŸèƒ½ä¿®å¤ç‰ˆ
function editRecord(index) {
    const r = records[index];

    // 1. æ ¸å¿ƒä¿®å¤ï¼šæ ‡å‡†åŒ–æ—¥æœŸæ ¼å¼ä¸º YYYY-MM-DD
    const dateObj = new Date(r.date.replace(/-/g, '/')); // å…¼å®¹ä¸åŒæµè§ˆå™¨çš„è§£æ
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
    const d = String(dateObj.getDate()).padStart(2, '0');
    const formattedDate = `${y}-${m}-${d}`;

    // 2. å›å¡«æ•°æ®
   document.getElementById('date').value = formattedDate;
    document.getElementById('name').value = r.name;
    document.getElementById('area').value = r.area;
    document.getElementById('amount').value = r.amount;
    document.getElementById('frequency').value = r.frequency || ''; // æ–°å¢
    document.getElementById('remark').value = r.remark || '';      // æ–°å¢
    document.getElementById('gender').value = r.gender || ''; // æ–°å¢å›å¡«
    document.getElementById('method').value = r.method || ''; // æ–°å¢å›å¡«

    records.splice(index, 1);
    window.scrollTo({ top: 0, behavior: 'smooth' });
    renderHome();
}

// æ¸…ç©ºæ‰€æœ‰æ•°æ®
function clearAllData() {
    if (confirm("âš ï¸ è­¦å‘Šï¼šè¿™å°†æ°¸ä¹…åˆ é™¤æœ¬åœ°æ‰€æœ‰è®°å½•ï¼Œå»ºè®®æ“ä½œå‰å…ˆç‚¹å‡»å¯¼å‡º CSV å¤‡ä»½ã€‚ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) {
        records = [];
        saveData();
        alert("æ•°æ®å·²æ¸…ç©º");
    }
}

    // --- åˆ†æä¸­å¿ƒé€»è¾‘ä¿®å¤ ---
    function getTimeline() {
        const res = []; const now = new Date();
        for(let i=11; i>=0; i--) {
            const s = new Date(now.getFullYear(), now.getMonth()-i, 1);
            const e = new Date(now.getFullYear(), now.getMonth()-i+1, 1);
            res.push({ label: `${s.getFullYear()}-${(s.getMonth()+1).toString().padStart(2,'0')}`, start: s.getTime(), end: e.getTime() });
        }
        return res;
    }


/**
 * ç»´åº¦åˆ‡æ¢å¤„ç†å‡½æ•°ï¼šå½»åº•æ§åˆ¶â€œè¿‡å»5å¹´â€é€‰é¡¹çš„æ˜¾éš
 */
function handleDimensionChange() {
    const dim = document.getElementById('vDimension').value;
    const rangeSelect = document.getElementById('vRange');
    const opt5y = document.getElementById('opt5y');
    const optPersonAvg = document.getElementById('optPersonAvg');

    // åˆå§‹å…¨éƒ¨éšè—
    if (opt5y) opt5y.style.display = 'none';
    if (optPersonAvg) optPersonAvg.style.display = 'none';

    if (dim === 'time') {
        opt5y.style.display = 'block';
    } else if (dim === 'person') {
        optPersonAvg.style.display = 'block';
    }

    // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœåˆ‡æ¢ç»´åº¦åï¼Œå½“å‰é€‰ä¸­çš„ Range é€‰é¡¹è¢«éšè—äº†ï¼Œåˆ™é‡ç½®ä¸ºâ€œä»Šå¹´æ€»é¢â€
    const currentOpt = rangeSelect.options[rangeSelect.selectedIndex];
    if (currentOpt && currentOpt.style.display === 'none') {
        rangeSelect.value = 'year';
    }

    updateDimensionChart();
}

/**
 * æ ¸å¿ƒå›¾è¡¨æ›´æ–°å‡½æ•°
 */
function updateDimensionChart() {
    const dim = document.getElementById('vDimension').value;
    const range = document.getElementById('vRange').value;
    const timeline = getTimeline();

    let labels = [], vals = [];
    let isHorizontal = (dim === 'person' || dim === 'city');
    let isTrendStyle = (range === '5y' || range === 'personAvg'); // ç‰¹æ®Šæ¸²æŸ“æ¨¡å¼

    if (dim === 'time') {
        isHorizontal = false;
        if (range === '5y') {
            const currentYear = new Date().getFullYear();
            for (let i = 4; i >= 0; i--) {
                const year = currentYear - i;
                labels.push(year + 'å¹´');
                const yearRecs = records.filter(r => new Date(r.date.replace(/-/g, '/')).getFullYear() === year);
                const total = yearRecs.reduce((s, r) => s + r.amount, 0);
                let divisor = (year === currentYear) ? (new Date().getMonth() + 1) : 12;
                vals.push(Number((total / divisor).toFixed(2)));
            }
        } else if (range === 'year') {
            labels = Array.from({length: 12}, (_, i) => (i + 1) + 'æœˆ');
            vals = Array(12).fill(0);
            const thisYear = new Date().getFullYear();
            records.filter(r => new Date(r.date.replace(/-/g,'/')).getFullYear() === thisYear).forEach(r => {
                const m = new Date(r.date.replace(/-/g,'/')).getMonth();
                vals[m] += r.amount;
            });
        } else {
            labels = timeline.map(t => t.label);
            vals = timeline.map(t => records.filter(r => r.ts >= t.start && r.ts < t.end).reduce((s, r) => s + r.amount, 0));
        }
    } else {
        // --- æ’åç±»é€»è¾‘ï¼ˆæ”¯æŒè€…/åŸå¸‚ï¼‰ ---
        // ç¡®å®šå¼€å§‹æ—¶é—´ï¼šå¦‚æœæ˜¯ 12m æˆ– personAvgï¼Œéƒ½å–è¿‡å» 12 ä¸ªæœˆçš„èµ·ç‚¹
        const startTime = (range === 'year') ? new Date(new Date().getFullYear(), 0, 1).getTime() : timeline[0].start;
        const filtered = records.filter(r => r.ts >= startTime);

        let map = {};
        filtered.forEach(r => {
            const key = dim === 'person' ? r.name : r.area;
            map[key] = (map[key] || 0) + r.amount;
        });

        // å¦‚æœæ˜¯æœˆå‡å¯¹æ¯”ï¼Œå°†æ€»é¢é™¤ä»¥ 12
        if (range === 'personAvg') {
            Object.keys(map).forEach(name => {
                map[name] = Number((map[name] / 12).toFixed(2));
            });
        }

        const sorted = Object.entries(map).sort((a, b) => b[1] - a[1]).slice(0, 15);
        labels = sorted.map(e => e[0]);
        vals = sorted.map(e => e[1]);
        isHorizontal = true;
    }

    // è°ƒç”¨æ¸²æŸ“å¼•æ“
    renderCoreChart(labels, vals, (range === '5y'), isHorizontal, range === 'personAvg');
}

/**
 * ç»Ÿä¸€æ¸²æŸ“å¼•æ“
 * @param {boolean} isLineTrend æ˜¯å¦æ˜¾ç¤ºå¤åˆæŠ˜çº¿ï¼ˆä»…é™æ—¶é—´5å¹´ï¼‰
 * @param {boolean} isAvgBar æ˜¯å¦æ˜¯æœˆå‡å¯¹æ¯”ï¼ˆå†³å®šæ ‡ç­¾æ˜¾ç¤ºï¼‰
 */
function renderCoreChart(labels, vals, isLineTrend, isHorizontal, isAvgBar) {
    const ctx = document.getElementById('vBarChart').getContext('2d');
    if (charts.v) charts.v.destroy();

    const datasets = [{
        label: (isLineTrend || isAvgBar) ? 'æœˆå¹³å‡é‡‘é¢' : 'æ€»é‡‘é¢',
        data: vals,
        backgroundColor: (isLineTrend || isAvgBar) ? 'rgba(99, 102, 241, 0.4)' : getColors(vals),
        borderColor: (isLineTrend || isAvgBar) ? '#6366f1' : 'transparent',
        borderWidth: (isLineTrend || isAvgBar) ? 1 : 0,
        borderRadius: 4,
        order: 2
    }];

    if (isLineTrend) {
        datasets.push({
            label: 'è¶‹åŠ¿',
            data: vals,
            type: 'line',
            borderColor: '#f97316',
            borderWidth: 2,
            pointRadius: 3,
            fill: false,
            order: 1
        });
    }

    charts.v = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
            ...chartBase,
            indexAxis: isHorizontal ? 'y' : 'x',
            plugins: {
                datalabels: { display: false }, // ç¦ç”¨æ­¤å›¾è¡¨çš„æ–‡å­—æ ‡ç­¾
                legend: { display: isLineTrend || isAvgBar },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const val = isHorizontal ? context.parsed.x : context.parsed.y;
                            return ` Â¥${val.toFixed(2)}${isAvgBar ? '/æœˆ' : ''}`;
                        }
                    }
                }
            },
            scales: {
                x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                y: { grid: { display: 0 }, beginAtZero: true }
            }
        }
    });
}

function updateGoals() {
    // 1. è·å–å¹¶å­˜å‚¨ç›®æ ‡
    monthlyTarget = parseFloat(document.getElementById('monthlyTargetInput').value) || 0;
    localStorage.setItem('sup_target', monthlyTarget);
    localStorage.setItem('sup_manual_goal', monthlyTarget);

    const annualTarget = monthlyTarget * 12;
    document.getElementById('annualTargetDisplay').innerText = `Â¥ ${annualTarget.toLocaleString(undefined, {minimumFractionDigits: 0})}`;

    // 2. è®¡ç®—å¹³å‡æŒ‡æ ‡
    const timeline = getTimeline();
    const actuals = timeline.map(t => records.filter(r => r.ts >= t.start && r.ts < t.end).reduce((s,r)=>s+r.amount,0));
    const avg = actuals.reduce((a,b)=>a+b, 0) / 12;
    const rate = monthlyTarget > 0 ? (avg / monthlyTarget * 100) : 0;
    const gap = monthlyTarget - avg;

    // æ›´æ–°æ˜¾ç¤ºæ–‡å­—
    document.getElementById('avgMonthlyAmt').innerText = `Â¥ ${avg.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
    document.getElementById('avgAchievement').innerText = `${rate.toFixed(1)}%`;

    // --- æ ¸å¿ƒé€»è¾‘ï¼šåŠ¨æ€å¤„ç†è¾¹çº¿é¢œè‰² ---
    const achItem = document.getElementById('avgAchievementItem');
    if (achItem) {
        // è¾¾æ ‡(>=100)æ˜¾ç¤ºç»¿è‰²ï¼Œæœªè¾¾æ ‡æ˜¾ç¤ºç°è‰²
        achItem.style.borderLeftColor = rate >= 100 ? 'var(--success)' : '#cbd5e1';
    }

    // æ›´æ–°ç¼ºå£é¢œè‰²é€»è¾‘
    const gapText = (gap > 0 ? 'Â¥ ' : '- Â¥ ') + Math.abs(gap).toLocaleString(undefined, {maximumFractionDigits: 0});
    document.getElementById('avgGap').innerText = gapText;
    document.getElementById('avgGap').style.color = gap <= 0 ? 'var(--success)' : 'var(--danger)';

    // 3. è®¡ç®—å¹´åº¦è¿›åº¦å¹¶æ›´æ–°è¿›åº¦æ¡
    const thisYear = new Date().getFullYear();
    const yearActual = records
        .filter(r => new Date(r.date.replace(/-/g,'/')).getFullYear() === thisYear)
        .reduce((s,r) => s + r.amount, 0);

    let annualPercent = annualTarget > 0 ? (yearActual / annualTarget) * 100 : 0;
    document.getElementById('annualProgressTextDisplay').innerText = annualPercent.toFixed(1) + "%";

    const annualBar = document.getElementById('annualProgressBar');
    if(annualBar) {
        annualBar.style.width = Math.min(annualPercent, 100) + "%";
        annualBar.style.background = annualPercent >= 100 ? '#059669' : '#6366f1';
    }

    // 4. åˆ·æ–°å›¾è¡¨
    const ctxM = document.getElementById('monthlyGoalChart').getContext('2d');
    if(charts.goalM) charts.goalM.destroy();
    charts.goalM = new Chart(ctxM, {
        type: 'bar',
        data: {
            labels: timeline.map(t => t.label),
            datasets: [
                { label: 'å®é™…ç­¹æ¬¾', data: actuals, backgroundColor: actuals.map(v => v >= monthlyTarget ? '#10b981':'#94a3b8'), borderRadius: 4 },
                { label: 'ç›®æ ‡çº¿', data: Array(12).fill(monthlyTarget), type: 'line', borderColor: '#6366f1', borderDash: [5, 5], pointRadius: 0 }
            ]
        },
        options: {
            ...chartBase,
            plugins: {
                ...chartBase.plugins,
                // --- æ ¸å¿ƒä¿®æ”¹ï¼šç¦ç”¨æ­¤å›¾è¡¨çš„æ•°å­—æ ‡ç­¾ ---
                datalabels: {
                    display: false
                }
                // ------------------------------------
            }
        }
    });
}

/**
 * æ ¹æ®å§“åè‡ªåŠ¨å¡«å……æ”¯æŒè€…åŸºç¡€ä¿¡æ¯
 */
function autoFillSupporterInfo() {
    const nameInput = document.getElementById('supName'); // å‡è®¾å§“åè¾“å…¥æ¡†IDä¸ºsupName
    const name = nameInput.value.trim();

    if (!name) return;

    // 1. ä¼˜å…ˆä» supporters (åå†Œ) ä¸­æŸ¥æ‰¾
    let profile = supporters.find(s => s.name === name);

    // 2. å¦‚æœåå†Œæ²¡æ‰¾åˆ°ï¼Œå°è¯•ä» records (å†å²è®°å½•) ä¸­æ‰¾æœ€è¿‘çš„ä¸€æ¬¡
    if (!profile) {
        const lastRec = [...records].reverse().find(r => r.name === name);
        if (lastRec) {
            // æ¨¡æ‹Ÿä¸€ä¸ª profile ç»“æ„
            profile = {
                gender: lastRec.gender || '',
                city: lastRec.city || '',
                freq: lastRec.freq || 'æŒ‰æœˆ',
                amount: lastRec.amount || ''
            };
        }
    }

    // 3. å¦‚æœæ‰¾åˆ°äº†åŒ¹é…é¡¹ï¼Œè‡ªåŠ¨å¡«å…¥è¾“å…¥æ¡†
    if (profile) {
        // è‡ªåŠ¨å¡«å…¥æ€§åˆ« (å‡è®¾æ˜¯ select æˆ– input)
        if(document.getElementById('supGender')) document.getElementById('supGender').value = profile.gender || '';

        // è‡ªåŠ¨å¡«å…¥åŸå¸‚
        if(document.getElementById('supCity')) document.getElementById('supCity').value = profile.city || '';

        // è‡ªåŠ¨å¡«å…¥é¢‘ç‡ (select)
        if(document.getElementById('supFreq')) document.getElementById('supFreq').value = profile.freq || 'æŒ‰æœˆ';

        // è‡ªåŠ¨å¡«å…¥é‡‘é¢
        if(document.getElementById('supAmount')) document.getElementById('supAmount').value = profile.amount || '';

        console.log(`å·²ä¸ºæ”¯æŒè€… ${name} è‡ªåŠ¨å¡«å……å†å²æ•°æ®`);
    }
}

function analyzePerson() {
    const name = document.getElementById('pSearch').value;
    const pRecs = records.filter(r => r.name === name);
    const reminderDiv = document.getElementById('pReminder');
    const now = new Date();

    if(!pRecs.length) {
        document.getElementById('pStats').style.display='none';
        return;
    }

    document.getElementById('pStats').style.display = 'grid';

    // 1. è·å–åå†Œä¸­çš„æ‰¿è¯ºé‡‘é¢
    const supporterProfile = supporters.find(s => s.name === name);
    let promiseText = "æœªè®¾å®š";
    if (supporterProfile) {
        const rawAmt = parseFloat(supporterProfile.amount) || 0;
        if (supporterProfile.freq === 'æŒ‰æœˆ') promiseText = `Â¥ ${rawAmt.toFixed(1)}`;
        else if (supporterProfile.freq === 'æŒ‰å¹´') promiseText = `Â¥ ${(rawAmt / 12).toFixed(1)}`;
        else if (supporterProfile.freq === 'ä¸å®šæœŸ') promiseText = "ä¸å®šæœŸ";
    }
    document.getElementById('pMonthlyPromise').innerText = promiseText;

    // 2. è®¡ç®—æœ¬å¹´åº¦æœˆå¹³å‡ (åªç»Ÿè®¡å½“å¹´çš„æ•°æ®é™¤ä»¥ 12)
    const currentYear = now.getFullYear();
    const yearStart = new Date(currentYear, 0, 1).getTime();
    const thisYearTotal = pRecs.filter(r => r.ts >= yearStart).reduce((s,r) => s + r.amount, 0);
    document.getElementById('pAvgYearly').innerText = `Â¥ ${(thisYearTotal / 12).toFixed(2)}`;

    // 3. åŸæœ‰åŸºç¡€ç»Ÿè®¡ (ç´¯è®¡å’Œæœ€è¿‘)
    const totalAmt = pRecs.reduce((s,r) => s + r.amount, 0);
    const last = [...pRecs].sort((a,b) => b.ts - a.ts)[0];
    document.getElementById('pTotalAmount').innerText = `Â¥ ${totalAmt.toFixed(2)}`;
    document.getElementById('pLastRecord').innerText = `${last.date} (Â¥${last.amount})`;

    // æ¸©é¦¨æé†’å’Œå›¾è¡¨æ¸²æŸ“ä¿æŒä¸å˜...
    const daysDiff = Math.floor((now.getTime() - last.ts) / (1000 * 60 * 60 * 24));
    reminderDiv.innerHTML = daysDiff > 60 ?
        `<div class="alert-box alert-warn">âš ï¸ å·²æœ‰ ${daysDiff} å¤©æœªæ”¯æŒï¼Œå¯ä»¥ä¸»åŠ¨å…³å¿ƒä¸€ä¸‹å“¦ï¼â¤ï¸</div>` :
        `<div class="alert-box alert-heart">âœ¨ æœ€è¿‘æ”¯æŒåœ¨ ${daysDiff} å¤©å‰ï¼Œå¯ä»¥é—®å€™æ„Ÿè°¢ä¸€ä¸‹å“¦ï¼ğŸ‰</div>`;

    renderPersonChart(pRecs, supporterProfile);
}

// å»ºè®®å°†å›¾è¡¨æ¸²æŸ“æ‹†åˆ†ï¼Œä¿æŒä»£ç æ•´æ´
function renderPersonChart(pRecs, supporterProfile) {
    const range = document.getElementById('pRange').value;
    let labels = [], vals = [];
    const now = new Date();
    const currentYear = now.getFullYear();

    // 1. æ•°æ®è®¡ç®—é€»è¾‘
    if (range === 'yearlyAvg') {
        // --- æ ¸å¿ƒæ–°å¢ï¼šè¿‡å» 5 å¹´å¹´åº¦æœˆå‡è®¡ç®— ---
        for (let i = 4; i >= 0; i--) {
            const year = currentYear - i;
            labels.push(year + 'å¹´');
            const yearRecs = pRecs.filter(r => {
                const d = new Date(r.date.replace(/-/g, '/'));
                return d.getFullYear() === year;
            });
            const total = yearRecs.reduce((s, r) => s + r.amount, 0);
            // ä»Šå¹´æŒ‰å·²è¿‡æœˆä»½ç®—å‡å€¼ï¼Œå¾€å¹´æŒ‰12ä¸ªæœˆç®—
            let divisor = (year === currentYear) ? (now.getMonth() + 1) : 12;
            vals.push(Number((total / divisor).toFixed(2)));
        }
    }
    else if (range === 'yearly') {
        const years = [...new Set(pRecs.map(r => new Date(r.ts).getFullYear()))].sort();
        labels = years.map(y => y + 'å¹´');
        vals = years.map(y => pRecs.filter(r => new Date(r.ts).getFullYear() === y).reduce((s,r)=>s+r.amount, 0));
    }
    else if (range === 'monthly') {
        const lastYear = currentYear - 1;
        labels = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
        vals = Array(12).fill(0);
        pRecs.forEach(r => {
            const d = new Date(r.ts);
            if (d.getFullYear() === lastYear) {
                vals[d.getMonth()] += r.amount;
            }
        });
    }
    else {
        const timeline = getTimeline();
        labels = timeline.map(t => t.label);
        vals = timeline.map(t => pRecs.filter(r => r.ts >= t.start && r.ts < t.end).reduce((s,r)=>s+r.amount, 0));
    }

    // 2. æ„é€ æ•°æ®é›†
    const isYearlyAvg = (range === 'yearlyAvg');
    const datasets = [{
        label: isYearlyAvg ? 'å¹´åº¦æœˆå‡é¢' : 'å®é™…æ”¯æŒ',
        data: vals,
        backgroundColor: isYearlyAvg ? 'rgba(99, 102, 241, 0.3)' : '#6366f1',
        borderColor: isYearlyAvg ? '#6366f1' : 'transparent',
        borderWidth: isYearlyAvg ? 1 : 0,
        borderRadius: 6,
        order: 2
    }];

    // å¦‚æœæ˜¯ 5 å¹´è¶‹åŠ¿ï¼Œå¢åŠ æ©™è‰²è¶‹åŠ¿æŠ˜çº¿
    if (isYearlyAvg) {
        datasets.push({
            label: 'æ”¯æŒè¶‹åŠ¿',
            data: vals,
            type: 'line',
            borderColor: '#f97316',
            backgroundColor: '#f97316',
            borderWidth: 2,
            pointRadius: 4,
            tension: 0.3,
            fill: false,
            order: 1
        });
    }

    // è®¡ç®—æ‰¿è¯ºçº¿æ•°å€¼ï¼ˆåªæœ‰éâ€œæŒ‰å¹´â€æ¨¡å¼ä¸‹æ˜¾ç¤ºå‚è€ƒçº¿ï¼‰
    let promiseValue = null;
    if (supporterProfile && range !== 'yearly') {
        const rawAmt = parseFloat(supporterProfile.amount) || 0;
        if (supporterProfile.freq === 'æŒ‰æœˆ') promiseValue = rawAmt;
        if (supporterProfile.freq === 'æŒ‰å¹´') promiseValue = rawAmt / 12;
    }

    if (promiseValue !== null) {
        datasets.push({
            label: 'æ‰¿è¯ºæœˆé¢å‚è€ƒ',
            data: Array(labels.length).fill(promiseValue),
            type: 'line',
            borderColor: '#22c55e',
            borderDash: [5, 5],
            borderWidth: 2,
            pointRadius: 0,
            fill: false,
            order: 0
        });
    }

    // 3. æ¸²æŸ“å›¾è¡¨
    const ctx = document.getElementById('pBarChart').getContext('2d');
    if(charts.p) charts.p.destroy();

    charts.p = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
            ...chartBase,
            plugins: {
                datalabels: { display: false }, // ç¦ç”¨æ­¤å›¾è¡¨çš„æ–‡å­—æ ‡ç­¾
                legend: { display: true, labels: { boxWidth: 10, font: { size: 10 } } },
                tooltip: {
                    callbacks: {
                        label: (ctx) => ` Â¥${ctx.parsed.y.toFixed(2)}${isYearlyAvg ? ' (æœˆå‡)' : ''}`
                    }
                }
            }
        }
    });
}

    function runAnalysis() {

  // --- æ–°å¢ï¼šåˆ·æ–°åä»æœ¬åœ°å­˜å‚¨å›å¡«ç›®æ ‡ ---
    const savedGoal = localStorage.getItem('sup_manual_goal');
    const targetInput = document.getElementById('monthlyTargetInput');
    if (savedGoal && (!targetInput.value || targetInput.value == "0")) {
        targetInput.value = savedGoal;
        monthlyTarget = parseFloat(savedGoal); // åŒæ­¥å…¨å±€å˜é‡
    }

        const now = new Date();
        const yearRecs = records.filter(r => r.ts >= new Date(now.getFullYear(), 0, 1).getTime());
        const firstDay = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-01`;
    const today = now.toISOString().split('T')[0];

    const startInput = document.getElementById('mStart');
    const endInput = document.getElementById('mEnd');

    if (!startInput.value) startInput.value = firstDay;
    if (!endInput.value) endInput.value = today;



        document.getElementById('totalYear').innerText = `Â¥ ${yearRecs.reduce((s,r)=>s+r.amount,0).toFixed(2)}`;
        const latest = [...records].sort((a,b) => b.ts - a.ts)[0];
        document.getElementById('lastDetail').innerText = latest ? `${latest.date} (${latest.name})` : "-";
        document.getElementById('pSearchList').innerHTML = [...new Set(records.map(r => r.name))].map(n => `<option value="${n}">`).join('');

          calculateMethodStats(); // è§¦å‘ç»Ÿè®¡


        const mData = Array(12).fill(0);
        yearRecs.forEach(r => { const m = new Date(r.ts).getMonth(); mData[m] += r.amount; });
        const ctx = document.getElementById('mainDoughnut').getContext('2d');
        if(charts.main) charts.main.destroy();
        charts.main = new Chart(ctx, { type: 'doughnut', data: { labels: ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'], datasets: [{ data: mData, backgroundColor: getColors(mData), borderWidth:0 }] }, options: { maintainAspectRatio:false, plugins:{datalabels: { display: false },legend:{position:'right'}} } });

        updateDimensionChart();
        updateGoals();

function updateMaintenancePanel() {
    const now = new Date().getTime();
    const oneMonthMs = 30 * 24 * 60 * 60 * 1000; // ä¸€ä¸ªæœˆçš„æ¯«ç§’æ•°

    const personMap = {};
    // å°†è®°å½•æŒ‰å§“ååˆ†ç»„ï¼Œå¹¶ä¿ç•™æ¯äººçš„é¢‘ç‡å±æ€§
    records.forEach(r => {
        if (!personMap[r.name]) {
            personMap[r.name] = {
                timestamps: [],
                freq: r.frequency // è·å–è¯¥æ”¯æŒè€…çš„è®¾å®šé¢‘ç‡
            };
        }
        personMap[r.name].timestamps.push(r.ts);
    });

    let dormant = [], loyal = [];

    Object.keys(personMap).forEach(name => {
        const data = personMap[name];
        const timestamps = data.timestamps.sort((a, b) => b - a); // é™åºæ’ï¼Œæœ€è¿‘çš„åœ¨æœ€å‰
        const latest = timestamps[0];
        const diffMs = now - latest;

        // --- é€»è¾‘ä¿®è®¢ï¼šåˆ†ç±»åˆ¤æ–­é€¾æœŸ ---
        let isDormant = false;
        if (data.freq === 'æŒ‰æœˆ') {
            // è¶…è¿‡ 3 ä¸ªæœˆï¼ˆçº¦ 90 å¤©ï¼‰
            if (diffMs > (3 * oneMonthMs)) isDormant = true;
        } else if (data.freq === 'æŒ‰å¹´') {
            // è¶…è¿‡ 12 ä¸ªæœˆï¼ˆçº¦ 365 å¤©ï¼‰
            if (diffMs > (12 * oneMonthMs)) isDormant = true;
        }
        // â€œä¸å®šæœŸâ€æˆ–â€œå…¶ä»–â€ç±»å‹è¿™é‡Œä¸å¤„ç†ï¼Œå³ä¸è¿›å…¥ dormant åˆ—è¡¨

        if (isDormant) {
            dormant.push(name);
        }

        // --- ä¿æŒåŸæœ‰çš„ç‰¹åˆ«è‡´è°¢é€»è¾‘ï¼ˆæœ€è¿‘6ä¸ªæœˆæ”¯æŒæ¬¡æ•° >= 5ï¼‰ ---
        const sixMonthsMs = 180 * 24 * 60 * 60 * 1000;
        const recentCount = timestamps.filter(ts => (now - ts) <= sixMonthsMs).length;
        if (recentCount >= 5) {
            loyal.push(name);
        }
    });

    document.getElementById('dormantList').innerHTML = dormant.length ? dormant.map(n => `<span class="badge-name">${n}</span>`).join('') : "æš‚æ— ";
    document.getElementById('loyalList').innerHTML = loyal.length ? loyal.map(n => `<span class="badge-name">${n}</span>`).join('') : "æš‚æ— ";
}

updateMaintenancePanel(); // æ–°å¢ï¼šæ›´æ–°ç»´æŠ¤çœ‹æ¿
    }

    function getColors(vals) {
        if(!vals.length) return [];
        const min = Math.min(...vals), max = Math.max(...vals), range = (max - min) || 1;
        return vals.map(v => {
            const r = (v-min)/range;
            return r < 0.5 ? `rgb(${Math.floor(34+(249-34)*r*2)},${Math.floor(197+(115-197)*r*2)},${Math.floor(94+(22-94)*r*2)})` : `rgb(${Math.floor(249+(239-249)*(r-0.5)*2)},${Math.floor(115+(68-115)*(r-0.5)*2)},${Math.floor(22+(68-22)*(r-0.5)*2)})`;
        });
    }

// å¯¼å‡ºæ”¯æŒè®°å½•ä¸º CSV
function exportToCSV() {
    // 1. ç¡®ä¿è¯»å–å½“å‰ä½œç”¨åŸŸå†…çš„ records æ•°ç»„
    const dataToExport = records;

    if (!dataToExport || dataToExport.length === 0) {
        alert("ç›®å‰æ²¡æœ‰å¯å¯¼å‡ºçš„æ”¯æŒè®°å½•æ•°æ®ï¼");
        return;
    }

    // 2. å†…éƒ¨æ—¥æœŸæ ¼å¼åŒ–å·¥å…·
    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr.replace(/-/g, '/'));
        if (isNaN(d.getTime())) return dateStr;
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    };

    // 3. æ•°æ®è½¬ä¹‰å‡½æ•°
    const escapeCSV = (field) => {
        const str = (field === null || field === undefined) ? '' : String(field);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
    };

    // 4. æ„å»º CSV å†…å®¹ (UTF-8 BOM)
    const header = "\ufeffæ—¥æœŸ,å§“å,æ€§åˆ«,æ–¹å¼,åœ°åŒº,é‡‘é¢,é¢‘ç‡,å¤‡æ³¨";
    const rows = dataToExport.map(r =>
        [
            formatDate(r.date),
            r.name,
            r.gender || '',
            r.method || '',
            r.area,
            (typeof r.amount === 'number' ? r.amount : 0).toFixed(2),
            r.frequency || '',
            r.remark || ''
        ]
        .map(escapeCSV)
        .join(",")
    );

    const csvContent = header + "\n" + rows.join("\n");

    // 5. å¢å¼ºå‹ä¸‹è½½è§¦å‘æœºåˆ¶ (é€‚é…æ‰‹æœºç«¯)
    try {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');

        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');

        a.href = url;
        a.download = `${dateStr}_æ”¯æŒè®°å½•å¤‡ä»½.csv`;

        // å¿…é¡»æŒ‚è½½åˆ° DOM æ‰èƒ½åœ¨æŸäº›æµè§ˆå™¨è§¦å‘
        a.style.display = 'none';
        document.body.appendChild(a);

        // ä½¿ç”¨å»¶æ—¶ç¡®ä¿ DOM æŒ‚è½½å®Œæˆ
        setTimeout(() => {
            a.click();
            // æ¸…ç†
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 200);
        }, 50);

    } catch (err) {
        console.error("å¯¼å‡ºå¤±è´¥:", err);
        alert("å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™ã€‚");
    }
}
    renderHome();

// å½“é¡µé¢èµ„æºåŠ è½½å®Œæˆåæ‰§è¡Œ
window.addEventListener('load', () => {
    // å¦‚æœä½ å¸Œæœ›æ¯æ¬¡åˆ·æ–°éƒ½å›åˆ°åˆå§‹é€‰æ‹©ç•Œé¢ï¼Œå°†ä¸‹é¢æ”¹ä¸º const lastPage = 'index';
    // å¦‚æœå¸Œæœ›è®°ä½ä¸Šæ¬¡åœ¨å“ªä¸ªç³»ç»Ÿï¼Œåˆ™ä¿ç•™åŸé€»è¾‘
    const lastPage ='index';
    showPage(lastPage);
// 2. å¼ºåˆ¶è§¦å‘æ‰€æœ‰ç³»ç»Ÿçš„æ•°æ®æ¸²æŸ“ï¼Œç¡®ä¿åˆ—è¡¨ä¸æ˜¯ç©ºçš„
    renderHome();             // æ¸²æŸ“æ”¯æŒè®°å½•åˆ—è¡¨
    renderSupporters();       // æ¸²æŸ“æ”¯æŒè€…åå†Œ
    renderCareLogs();         // æ¸²æŸ“å…³æ€€æ—¥å¿—é¢„è§ˆ
    renderBudgetHistory();    // æ¸²æŸ“é¢„ç®—å†å²è®°å½•ï¼ˆä¿®å¤æ¶ˆå¤±çš„å…³é”®ï¼‰

    // 3. åˆ·æ–°åˆ†æå›¾è¡¨ï¼ˆå¦‚æœå½“å‰åœ¨åˆ†æé¡µï¼‰
    if (lastPage === 'analysis') {
        runAnalysis();
    } else if (lastPage === 'supporterAnalysisPage') {
        renderSupporterAnalysis();
    }

});

// 1. åˆå§‹åŒ–æ•°æ®
let careLogs = JSON.parse(localStorage.getItem('sup_care_logs_v1')) || [];

// 2. ä¿å­˜é€»è¾‘
document.getElementById('careForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const name = document.getElementById('careName').value.trim();
    const content = document.getElementById('careContent').value.trim();

    if(!name || !content) {
        alert("è¯·å¡«å†™å§“åå’Œå†…å®¹");
        return;
    }

    const log = {
        id: Date.now(),
        date: document.getElementById('careDate').value,
        name: name,
        type: document.getElementById('careType').value,
        content: content
    };

    careLogs.unshift(log); // æœ€æ–°è®°å½•ç½®é¡¶
    localStorage.setItem('sup_care_logs_v1', JSON.stringify(careLogs));
    globalRefreshCareDisplay(); // æ·»åŠ è¿™ä¸€è¡Œ
    refreshIndividualProfileIfActive();
    // é‡ç½®è¡¨å•å¹¶é‡æ–°è®¾ç½®é»˜è®¤æ—¥æœŸ
    this.reset();
document.getElementById('careDate').value = getTodayStr();
    renderCareLogs();
    filterCareLogs(); // ã€æ ¸å¿ƒæ–°å¢ã€‘å®æ—¶åˆ·æ–°ä¸‹æ–¹çš„ç­›é€‰ç»“æœåŒºåŸŸ
    alert("å…³æ€€è®°å½•å·²ä¿å­˜ï¼");
});

// ç¼–è¾‘å…³æ€€æ—¥å¿—
function editCareLog(index) {
    const log = careLogs[index];

    // 1. æ•°æ®å›å¡«è¡¨å•
    document.getElementById('careDate').value = log.date;
    document.getElementById('careName').value = log.name;
    document.getElementById('careType').value = log.type;
    document.getElementById('careContent').value = log.content;

    // 2. ä»æ•°ç»„ä¸­æš‚æ—¶ç§»é™¤ï¼ˆç”¨æˆ·ä¿å­˜åä¼šä½œä¸ºæ–°è®°å½•é‡æ–°å‡ºç°åœ¨é¡¶éƒ¨ï¼‰
    // å¦‚æœä½ å¸Œæœ›ä¿æŒåŸä½ç½®ï¼Œå¯ä»¥ä½¿ç”¨å…¨å±€å˜é‡ editIndex å­˜å‚¨ï¼Œä½†é€šå¸¸â€œä¿®æ”¹å¹¶ç½®é¡¶â€æ›´ç¬¦åˆæ‰‹æœºæ“ä½œä¹ æƒ¯
    careLogs.splice(index, 1);

    // 3. æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // 4. åˆ·æ–°åˆ—è¡¨æ˜¾ç¤ºï¼ˆæ­¤æ—¶è¯¥æ¡è®°å½•ä¼šæ¶ˆå¤±ï¼Œç›´åˆ°ç”¨æˆ·é‡æ–°ä¿å­˜ï¼‰
    renderCareLogs();

    // 5. ç®€å•çš„è§†è§‰æç¤º
    const formCard = document.querySelector('#careLogPage .card');
    formCard.style.boxShadow = "0 0 15px rgba(139, 92, 246, 0.3)";
    setTimeout(() => formCard.style.boxShadow = "0 4px 10px rgba(0,0,0,0.03)", 1000);
}

let showAllCareLogs = false;

// 3. æ¸²æŸ“é€»è¾‘ (ç¾åŒ–å¡ç‰‡å¼å¸ƒå±€)
function toggleShowAllCareLogs() {
    showAllCareLogs = !showAllCareLogs;
    renderCareLogs();
}

/**
 * æ¸…ç©ºæ‰€æœ‰å…³æ€€æ—¥å¿—
 */
function clearAllCareLogs() {
    if (confirm("âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å…³æ€€è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚")) {
        careLogs = [];
        localStorage.removeItem('sup_care_logs_v1');
        renderCareLogs();
        filterCareLogs();  // ã€æ ¸å¿ƒæ–°å¢ã€‘å®æ—¶åˆ·æ–°ä¸‹æ–¹çš„ç­›é€‰ç»“æœå¡ç‰‡åŒº
        alert("å·²æˆåŠŸæ¸…ç©ºæ‰€æœ‰æ—¥å¿—");
    }
}

/**
 * æ¸²æŸ“å…³æ€€æ—¥å¿— (å›ºå®šæŒ‰é’®é€»è¾‘)
 */
function renderCareLogs() {
    const listContainer = document.getElementById('careLogList');
    const countSpan = document.getElementById('careRecordCount');
    const btnShowAll = document.getElementById('btnShowAllCareLogs');

    if(!listContainer) return;

    // æ›´æ–°è®¡æ•°
    countSpan.innerText = `(å…± ${careLogs.length} æ¡è®°å½•)`;

    if(careLogs.length === 0) {
        listContainer.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:30px; font-size:13px;">å°šæœªè®°å½•ä»»ä½•å…³æ€€æ—¥å¿—</p>';
        if(btnShowAll) btnShowAll.innerText = "å±•å¼€å…¨éƒ¨";
        return;
    }

    // æ ¹æ®çŠ¶æ€å†³å®šæ˜¾ç¤ºæ•°é‡ï¼šfalse æ˜¾ç¤ºå‰2æ¡ï¼Œtrue æ˜¾ç¤ºå…¨éƒ¨
    const displayList = showAllCareLogs ? careLogs : careLogs.slice(0, 2);

    // æ›´æ–°æŒ‰é’®æ–‡å­—
    if (btnShowAll) {
        btnShowAll.innerText = showAllCareLogs ? "æ”¶èµ·æ—¥å¿—" : "å±•å¼€å…¨éƒ¨";
    }

    listContainer.innerHTML = displayList.map((log, index) => `
        <div class="card" style="margin-bottom:12px; padding:15px; border-left:5px solid #8b5cf6; background:#fff;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                <div>
                    <span style="font-weight:bold; color:#1e293b; font-size:15px;">${log.name}</span>
                    <span style="margin-left:8px; font-size:11px; padding:2px 6px; background:#f3f4f6; color:#6b7280; border-radius:4px;">${log.type}</span>
                </div>
                <span style="font-size:12px; color:#94a3b8;">${log.date}</span>
            </div>
            <div style="font-size:14px; color:#475569; line-height:1.6; white-space: pre-wrap;">${log.content}</div>
            <div style="text-align:right; margin-top:10px; border-top:1px solid #f1f5f9; padding-top:8px; display:flex; justify-content:flex-end; gap:15px;">
                <a href="javascript:void(0)" onclick="editCareLog(${index})" style="color:var(--primary); font-size:12px; text-decoration:none;">âœï¸ ç¼–è¾‘</a>
                <a href="javascript:void(0)" onclick="deleteCareLog(${index})" style="color:#ef4444; font-size:12px; text-decoration:none;">ğŸ—‘ï¸ åˆ é™¤</a>
            </div>
        </div>
    `).join('');
}


// 4. åˆ é™¤é€»è¾‘
function deleteCareLog(index) {
    if(confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡å…³æ€€è®°å½•å—ï¼Ÿ")) {
        careLogs.splice(index, 1);
        localStorage.setItem('sup_care_logs_v1', JSON.stringify(careLogs));
        globalRefreshCareDisplay(); // æ·»åŠ è¿™ä¸€è¡Œ
        refreshIndividualProfileIfActive();
        renderCareLogs();
        filterCareLogs(); // ã€æ ¸å¿ƒæ–°å¢ã€‘ç¡®ä¿å·²åˆ é™¤çš„å†…å®¹ä»ç»“æœä¸­æ¶ˆå¤±
    }
}

// åˆå§‹åŒ–æ—¥æœŸ

const initialDate = getTodayStr();
if(document.getElementById('careDate')) document.getElementById('careDate').value = initialDate;
if(document.getElementById('date')) document.getElementById('date').value = initialDate;

// åœ¨è„šæœ¬æœ«å°¾æˆ– DOMContentLoaded ä¸­æ·»åŠ 
document.addEventListener('DOMContentLoaded', () => {
    const homeNameInput = document.getElementById('name');
    if (homeNameInput) {
        // ç›‘å¬è¾“å…¥(input)å’Œé€‰æ‹©å˜åŠ¨(change)
        homeNameInput.addEventListener('input', autoFillSupporterProfileFromHistory);
        homeNameInput.addEventListener('change', autoFillSupporterProfileFromHistory);
    }
});

// --- æ‰¹é‡è¾“å…¥é€»è¾‘ ---



function openBulkImportModal() {
    document.getElementById('bulkImportModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.getElementById('bulkInputArea').focus();
}

function closeBulkImportModal() {
    document.getElementById('bulkImportModal').classList.add('hidden');
    document.body.style.overflow = '';
    document.getElementById('bulkInputArea').value = '';
    previewBulkData();
}

// æ ¸å¿ƒè§£æå™¨
function parseBulkLines() {
    const text = document.getElementById('bulkInputArea').value;
    return text.split(/\r?\n/).filter(line => line.trim() !== '').map(line => {
        const cols = line.split(/[,ï¼Œ]/).map(c => c.trim());
        return {
            startDate: cols[0] || '',
            endDate: cols[1] || '',
            name: cols[2] || '',
            gender: cols[3] || '',
            city: cols[4] || '',
            freq: cols[5] || '',
            amount: cols[6] || '0',
            remark: cols[7] || ''
        };
    });
}

// å®æ—¶é¢„è§ˆ
function previewBulkData() {
    const data = parseBulkLines();
    const previewBody = document.getElementById('bulkPreviewBody');
    document.getElementById('previewCount').innerText = data.length;

    if (data.length === 0) {
        previewBody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#94a3b8; padding: 20px;">ç­‰å¾…è¾“å…¥æ•°æ®...</td></tr>';
        return;
    }

    previewBody.innerHTML = data.map(item => {
        // æ ¡éªŒé€»è¾‘
        const genderValid = ['ç”·', 'å¥³', 'å…¶ä»–'].includes(item.gender);
        const freqValid = ['æŒ‰æœˆ', 'æŒ‰å¹´', 'ä¸å®šæœŸ'].includes(item.freq);
        const nameValid = item.name.length > 0;

        return `<tr>
            <td>${item.startDate || '<span style="color:#94a3b8">ç©º</span>'}</td>
            <td>${item.endDate || '<span style="color:#94a3b8">ç©º</span>'}</td>
            <td style="${!nameValid ? 'background:#fee2e2' : ''}">${item.name || 'â—ç¼ºå§“å'}</td>
            <td style="${!genderValid ? 'color:var(--danger); font-weight:bold' : ''}">${item.gender || 'â—ç¼ºæ€§åˆ«'}</td>
            <td>${item.city}</td>
            <td style="${!freqValid ? 'color:var(--danger); font-weight:bold' : ''}">${item.freq || 'â—ç¼ºé¢‘ç‡'}</td>
            <td>${item.amount}</td>
            <td style="max-width:100px; overflow:hidden; text-overflow:ellipsis;">${item.remark}</td>
        </tr>`;
    }).join('');
}

// ç¡®è®¤å¯¼å…¥
function confirmBulkImport() {
    const data = parseBulkLines();
    if (data.length === 0) return alert("å†…å®¹ä¸ºç©º");

    const validGenders = ['ç”·', 'å¥³', 'å…¶ä»–'];
    const validFreqs = ['æŒ‰æœˆ', 'æŒ‰å¹´', 'ä¸å®šæœŸ'];
    const newSupporters = [];
    let errorLog = [];

    data.forEach((item, index) => {
        const lineNum = index + 1;
        // ä¸¥æ ¼æ ¡éªŒ
        if (!item.name) errorLog.push(`ç¬¬${lineNum}è¡Œï¼šå§“åç¼ºå¤±`);
        if (!validGenders.includes(item.gender)) errorLog.push(`ç¬¬${lineNum}è¡Œï¼šæ€§åˆ«é”™è¯¯(${item.gender || 'ç©º'})ï¼Œé¡»ä¸º ç”·/å¥³/å…¶ä»–`);
        if (!validFreqs.includes(item.freq)) errorLog.push(`ç¬¬${lineNum}è¡Œï¼šé¢‘ç‡é”™è¯¯(${item.freq || 'ç©º'})ï¼Œé¡»ä¸º æŒ‰æœˆ/æŒ‰å¹´/ä¸å®šæœŸ`);

        if (errorLog.length === 0) {
            newSupporters.push({
                id: Date.now() + index,
                startDate: formatDateStandard(item.startDate) || getTodayStr(),
                endDate: formatDateStandard(item.endDate),
                name: item.name,
                gender: item.gender,
                city: item.city,
                freq: item.freq,
                amount: parseFloat(item.amount) || 0,
                remark: item.remark
            });
        }
    });

    if (errorLog.length > 0) {
        alert("å¯¼å…¥å¤±è´¥ï¼Œè¯·ä¿®æ­£ä»¥ä¸‹é”™è¯¯ï¼š\n\n" + errorLog.slice(0, 5).join('\n') + (errorLog.length > 5 ? '\n...' : ''));
    } else {
        supporters.push(...newSupporters);
        saveSupporterData();
        alert(`âœ… æˆåŠŸå¯¼å…¥ ${newSupporters.length} æ¡è®°å½•ï¼`);
        closeBulkImportModal();
    }
}

</script>


<div class="footer-copyright">
    <div style="margin-bottom: 12px; display: flex; justify-content: center; gap: 15px;">
        <a href="javascript:void(0)" onclick="showPage('home')" class="footer-link">æ”¯æŒè®°å½•</a>
        <a href="javascript:void(0)" onclick="showPage('supporter')" class="footer-link">æ”¯æŒè€…ç®¡ç†</a>
        <a href="javascript:void(0)" onclick="showPage('budget')" class="footer-link">æ”¶æ”¯é¢„ç®—</a>

    </div>
    <div>Â© 2026 æ”¯æŒç®¡ç†ç³»ç»Ÿ All Rights Reserved</div>
</div>

<div id="careModal" class="modal-overlay hidden" onclick="closeCareModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 id="m_careName" style="margin:0; font-size:18px;">æ”¯æŒè€…å§“å</h3>
            <div style="margin-top:5px;">
                <span id="m_careType" style="font-size:11px; padding:2px 8px; background:#f3f4f6; color:#6b7280; border-radius:4px;">ç±»å‹</span>
                <span id="m_careDate" style="font-size:12px; color:#94a3b8; margin-left:10px;">æ—¥æœŸ</span>
            </div>
        </div>
        <div class="modal-body" id="m_careContent">å†…å®¹åŠ è½½ä¸­...</div>
      <div class="modal-footer" style="display: flex; gap: 10px; width: 100%; box-sizing: border-box;">
    <button id="m_btnDelete" class="btn-clear-danger" style="flex: 1; height: 40px; margin: 0; padding: 0; justify-content: center; font-size: 13px;">
        ğŸ—‘ï¸ åˆ é™¤
    </button>
    <button id="m_btnEdit" class="btn-indigo" style="flex: 1; height: 40px; margin: 0; padding: 0; justify-content: center; font-size: 13px;">
        âœï¸ ç¼–è¾‘
    </button>
    <button class="btn-outline" onclick="closeCareModal()" style="flex: 1; height: 40px; margin: 0; padding: 0; justify-content: center; font-size: 13px;">
        å…³é—­
    </button>
</div>
    </div>
</div>

</body>
</html>
